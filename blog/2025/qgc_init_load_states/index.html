<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> QGC代码架构解析：QGC初始加载及状态机 | Roderick Huang </title> <meta name="author" content="Roderick Huang"> <meta name="description" content="Roderick Huang 的个人博客，记录工作与技术。 "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="manifest" href="/manifest.json"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a2e"> <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script> <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; media-src 'self' https:; frame-src 'self' https:; connect-src 'self' https:;"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?v=6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://hxf0223.github.io/blog/2025/qgc_init_load_states/"> <script src="/assets/js/theme.js?v=5fea5159b787642c1bbc1f334d60f883"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Roderick</span> Huang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="fa-solid fa-magnifying-glass"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-half-sun-moon" id="light-toggle-system"></i> <i class="fa-solid fa-moon" id="light-toggle-dark"></i> <i class="fa-solid fa-sun" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">QGC代码架构解析：QGC初始加载及状态机</h1> <p class="post-meta"> Created on December 13, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/qgc"> <i class="fa-solid fa-hashtag fa-sm"></i> QGC</a>   ·   <a href="/blog/category/qgc"> <i class="fa-solid fa-tag fa-sm"></i> QGC</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>在收到飞机发来的心跳包后，消息发送给<code class="language-plaintext highlighter-rouge">MultiVehicleManager</code>，在<code class="language-plaintext highlighter-rouge">MultiVehicleManager</code>中，检查组件ID是否是<code class="language-plaintext highlighter-rouge">MAV_COMP_ID_AUTOPILOT1</code>，以及<code class="language-plaintext highlighter-rouge">vehicleType</code>不是<code class="language-plaintext highlighter-rouge">GCS</code>等之后，会创建一个<code class="language-plaintext highlighter-rouge">Vehicle</code>对象，并进入初始化流程。</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">mavlink_message_t</code>中已经包含了<code class="language-plaintext highlighter-rouge">sysid</code>、<code class="language-plaintext highlighter-rouge">compid</code>信息。而心跳包<code class="language-plaintext highlighter-rouge">mavlink_heartbeat_t</code>中则包含了<code class="language-plaintext highlighter-rouge">vehicleType</code>、<code class="language-plaintext highlighter-rouge">firmwareType</code>等信息。</p> </blockquote> <blockquote> <p>需要注意的是，与飞控通信中，组件ID是固定的：<code class="language-plaintext highlighter-rouge">MAV_COMP_ID_AUTOPILOT1</code>，即每个飞控的组件ID都是1。</p> </blockquote> <p>飞机发现、创建及初始化流程如下图所示： <img src="/assets/images/qgc/20251214/QGC-Vehicle-Discovery-and-Creation-Process.png" alt="qgc_vehicle_init"></p> <p>主要初始流程入口在<code class="language-plaintext highlighter-rouge">InitialConnectStateMachine</code>中以状态机实现，且部分子流程也是以状态机实现（至多嵌套了三层状态机）：</p> <blockquote> <p>由于获取信息需要使用同步方式，在<code class="language-plaintext highlighter-rouge">InitialConnectStateMachine</code>状态机中，使用回调方式处理应答<code class="language-plaintext highlighter-rouge">Ack</code>，在回调中进入下一个处理阶段。参见：<a href="#1-%E8%AF%B7%E6%B1%82%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BB%A5%E5%8F%8A%E6%A8%A1%E6%8B%9F%E5%90%8C%E6%AD%A5%E8%AF%B7%E6%B1%82">1. 请求的实现，以及模拟同步请求</a>。</p> </blockquote> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="n">StateMachine</span><span class="o">::</span><span class="n">StateFn</span> <span class="n">_rgStates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">_stateRequestAutopilotVersion</span><span class="p">,</span>
    <span class="n">_stateRequestStandardModes</span><span class="p">,</span>
    <span class="n">_stateRequestCompInfo</span><span class="p">,</span>
    <span class="n">_stateRequestParameters</span><span class="p">,</span>
    <span class="n">_stateRequestMission</span><span class="p">,</span>
    <span class="n">_stateRequestGeoFence</span><span class="p">,</span>
    <span class="n">_stateRequestRallyPoints</span><span class="p">,</span>
    <span class="n">_stateSignalInitialConnectComplete</span>
<span class="p">};</span>
</code></pre></div></div> <h2 id="1-请求的实现以及模拟同步请求">1. 请求的实现，以及模拟同步请求</h2> <p>请求飞机信息，使用<code class="language-plaintext highlighter-rouge">MAV_CMD_REQUEST_MESSAGE</code>命令字，请求对应的消息ID（即子命令，比如请求飞机版本信息<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AUTOPILOT_VERSION</code>），以及子命令的参数。另外，使用命令<code class="language-plaintext highlighter-rouge">MAV_CMD_SET_MESSAGE_INTERVAL</code>让飞机定期周期响应子命令消息。</p> <p>飞机端收到<code class="language-plaintext highlighter-rouge">MESSAGE</code>消息之后，先返回一个响应<code class="language-plaintext highlighter-rouge">Ack</code>（<code class="language-plaintext highlighter-rouge">Ack</code>中包含<code class="language-plaintext highlighter-rouge">msgid</code>，以及响应码，比如<code class="language-plaintext highlighter-rouge">MAV_RESULT_ACCEPTED</code>）。<code class="language-plaintext highlighter-rouge">QGC</code>收到该消息，继续处理之前发送的请求，实现代码主要有两个函数入口：<code class="language-plaintext highlighter-rouge">Vehicle::requestMessage</code>，<code class="language-plaintext highlighter-rouge">Vehicle::_handleCommandAck(mavlink_message_t&amp; message)</code>，以及一个主要的数据成员<code class="language-plaintext highlighter-rouge">QMap&lt;int, QMap&lt;int, RequestMessageInfo_t*&gt;&gt; _requestMessageInfoMap</code>。</p> <p><code class="language-plaintext highlighter-rouge">MAV_CMD_REQUEST_MESSAGE</code>消息的文档：<a href="https://mavlink.io/en/mavgen_python/howto_requestmessages.html" rel="external nofollow noopener" target="_blank">How to Request &amp; Stream Messages</a>。处理流程示例：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>你的程序                           飞控
   |                               |
   | 1. 发送 MAV_CMD_SET_MESSAGE_INTERVAL
   |----------------------------------------→  (请求：以1Hz发送BATTERY_STATUS)
   |
   |                               | 处理请求
   | 2. 接收 COMMAND_ACK
   |←----------------------------------------  (确认已接受)
   |
   | 3. 等待 BATTERY_STATUS
   |
   |                               | 自动发送电池信息（周期:  1秒）
   | ← 接收 BATTERY_STATUS #1      |
   | ← 接收 BATTERY_STATUS #2      | （自动循环，无需请求）
   | ← 接收 BATTERY_STATUS #3      |
   | ← 接收 BATTERY_STATUS #4      |
</code></pre></div></div> <h2 id="2-请求飞机版本信息mavlink_msg_id_autopilot_version">2. 请求飞机版本信息(<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AUTOPILOT_VERSION</code>)</h2> <p>主要获取飞机的编号、固件的<code class="language-plaintext highlighter-rouge">vender_id</code>、<code class="language-plaintext highlighter-rouge">product_id</code>，固件版本信息，以及<code class="language-plaintext highlighter-rouge">capabilities</code>（64位bitmask），<code class="language-plaintext highlighter-rouge">capabilities</code>相关枚举定义在<code class="language-plaintext highlighter-rouge">MAVLink</code>协议的<code class="language-plaintext highlighter-rouge">MAV_PROTOCOL_CAPABILITY</code>中。</p> <h2 id="3-请求飞机标准模式mavlink_msg_id_available_modes">3. 请求飞机标准模式(<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AVAILABLE_MODES</code>)</h2> <p>主要获取飞机支持的标准模式。获取的模式列表用于设置给<code class="language-plaintext highlighter-rouge">FirmwarePlugin</code>，并在<code class="language-plaintext highlighter-rouge">Vehicle</code>中使用。</p> <h2 id="4-请求组件元数据meta信息">4. 请求组件元数据（META）信息</h2> <p>由于这一步请求处理多个类型<code class="language-plaintext highlighter-rouge">META</code>数据文件，整个处理放在单独的模块（源码文件）<code class="language-plaintext highlighter-rouge">ComponentInformationManager</code>中，且也使用状态机来实现：请求<code class="language-plaintext highlighter-rouge">General</code>元数据、<code class="language-plaintext highlighter-rouge">Param</code>元数据、<code class="language-plaintext highlighter-rouge">Events</code>元数据、<code class="language-plaintext highlighter-rouge">Actuator</code>元数据。<code class="language-plaintext highlighter-rouge">General</code>是指组件的信息（主要是飞控自身），而<code class="language-plaintext highlighter-rouge">Events</code>，<code class="language-plaintext highlighter-rouge">Actuator</code>不一定每个组件都有。</p> <p>请求每个子分类的<code class="language-plaintext highlighter-rouge">META</code>数据，分为几个步骤（还是用状态机实现），在<code class="language-plaintext highlighter-rouge">RequestMetaDataTypeStateMachine</code>中实现：请求数据文件的地址<code class="language-plaintext highlighter-rouge">URI</code>（返回URI，以及CRC），根据URI请求<code class="language-plaintext highlighter-rouge">META</code>数据文件内容（具有缓存功能，先比较CRC，不相等再请求远程<code class="language-plaintext highlighter-rouge">META</code>文件），即数据类型描述文件。比如下一个步骤请求飞机的参数信息，就需要将请求到的参数生成<code class="language-plaintext highlighter-rouge">Fact</code>，而<code class="language-plaintext highlighter-rouge">Fact</code>的类型信息就来自于参数的<code class="language-plaintext highlighter-rouge">META</code>数据文件。</p> <blockquote> <p>在请求<code class="language-plaintext highlighter-rouge">META</code>数据文件的过程中，定义了两个数据类：1. <code class="language-plaintext highlighter-rouge">struct CompInfo::Uris</code>：存放<code class="language-plaintext highlighter-rouge">META</code>文件的<code class="language-plaintext highlighter-rouge">URI</code>，<code class="language-plaintext highlighter-rouge">CRC</code>，以及其他一些信息（如<code class="language-plaintext highlighter-rouge">Fallback</code>请求信息）。2. <code class="language-plaintext highlighter-rouge">CompInfo</code>，以及继承自<code class="language-plaintext highlighter-rouge">CompInfo</code>的上述几种<code class="language-plaintext highlighter-rouge">META</code>文件对应的子类：<code class="language-plaintext highlighter-rouge">CompInfoGeneral</code>，<code class="language-plaintext highlighter-rouge">CompInfoParam</code>，<code class="language-plaintext highlighter-rouge">CompInfoEvents</code>，<code class="language-plaintext highlighter-rouge">CompInfoActuators</code>。其中最重要也是首先需要请求的<code class="language-plaintext highlighter-rouge">META</code>文件是<code class="language-plaintext highlighter-rouge">CompInfoGeneral</code>，因为这个文件里面包含了设备支持的<code class="language-plaintext highlighter-rouge">META</code>文件类型列表（数据成员<code class="language-plaintext highlighter-rouge">QMap&lt;COMP_METADATA_TYPE, Uris&gt; _supportedTypes;</code>）。后续几个请求，要先检查设备是否支持该类型的<code class="language-plaintext highlighter-rouge">META</code>文件。</p> </blockquote> <blockquote> <p>在<code class="language-plaintext highlighter-rouge">ComponentInformationManager</code>中，维护了一个<code class="language-plaintext highlighter-rouge">QMap&lt;uint8_t /* compId */, QMap&lt;COMP_METADATA_TYPE, CompInfo*&gt;&gt; _compInfoMap;</code>，用于存放每个组件的各类<code class="language-plaintext highlighter-rouge">META</code>文件对象。这与上面所述的逻辑连接起来。</p> </blockquote> <blockquote> <p><code class="language-plaintext highlighter-rouge">Events</code>是<code class="language-plaintext highlighter-rouge">MAVLink</code>协议中的一个系统事件和诊断机制，用于飞机端向地面站实时报告系统事件、警告和错误。相关文档：<a href="https://mavlink.io/en/services/events.html" rel="external nofollow noopener" target="_blank">Events Interface (WIP)</a>。比如可能有如下事件：</p> </blockquote> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>飞机端事件流：
    ├─ 电池低电量事件
    ├─ GPS 信号丢失事件
    ├─ IMU 过热警告
    ├─ 传感器校准失败
    ├─ 电机故障检测
    └─ 健康检查失败 (Health &amp; Arming Checks)
</code></pre></div></div> <h3 id="41-meta数据使用流程">4.1. META数据使用流程</h3> <p>请求到的<code class="language-plaintext highlighter-rouge">META</code>数据文件，主要用于创建<code class="language-plaintext highlighter-rouge">FactMetaData</code>对象，进而创建<code class="language-plaintext highlighter-rouge">Fact</code>对象。以请求参数的<code class="language-plaintext highlighter-rouge">META</code>数据文件为例，流程如下所示：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌───────────────────────────────────────────────────┐
│           飞机端 (Autopilot)                       │
└───────────────────────────────────────────────────┘
                       │
                       │ MAVLink
                       │
         ┌─────────────▼──────────────┐
         │ ComponentInformation       │
         │ ┌──────────────────────┐   │
         │ │ COMP_METADATA_TYPE   │   │
         │ │ _PARAMETER           │   │
         │ │ (JSON 文件 URI)      │   │
         │ └──────────────────────┘   │
         └─────────────┬──────────────┘
                       │ 下载 JSON
                       │
         ┌─────────────▼──────────────┐
         │ CompInfoParam.setJson()    │
         │ (解析 JSON 文件)            │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────────────────────┐
         │ FactMetaData::createFromJsonObject()       │
         │ (将 JSON 转换为 FactMetaData 对象)          │
         └─────────────┬──────────────────────────────┘
                       │
         ┌─────────────▼──────────────────────────────┐
         │ ParameterManager                           │
         │ _nameToMetaDataMap[paramName]              │
         │ (存储所有参数的元数据)                       │
         └────────────────────────────────────────────┘
</code></pre></div></div> <p>代码执行流程：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1️⃣ 初始化连接时，请求参数的元数据</span>
<span class="n">_stateRequestCompInfoEvents</span><span class="p">()</span>
    <span class="err">└─►</span> <span class="n">_requestTypeStateMachine</span><span class="p">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">_compInfoMap</span><span class="p">[</span><span class="n">MAV_COMP_ID_AUTOPILOT1</span><span class="p">][</span><span class="n">COMP_METADATA_TYPE_PARAMETER</span><span class="p">]</span>
        <span class="p">);</span>

<span class="c1">// 2️⃣ 下载 JSON 文件后，调用 setJson()</span>
<span class="n">CompInfoParam</span><span class="o">::</span><span class="n">setJson</span><span class="p">(</span><span class="k">const</span> <span class="n">QString</span><span class="o">&amp;</span> <span class="n">metadataJsonFileName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 3️⃣ 解析 JSON 文件</span>
    <span class="n">QJsonDocument</span> <span class="n">jsonDoc</span> <span class="o">=</span> <span class="c1">// 从文件读取</span>
    <span class="n">QJsonArray</span> <span class="n">rgParameters</span> <span class="o">=</span> <span class="n">jsonDoc</span><span class="p">[</span><span class="s">"QGC_PARAMETERS"</span><span class="p">].</span><span class="n">toArray</span><span class="p">();</span>

    <span class="c1">// 4️⃣ 为每个参数创建 FactMetaData 对象</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">QJsonValue</span> <span class="n">parameterValue</span> <span class="o">:</span> <span class="n">rgParameters</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FactMetaData</span><span class="o">*</span> <span class="n">newMetaData</span> <span class="o">=</span>
            <span class="n">FactMetaData</span><span class="o">::</span><span class="n">createFromJsonObject</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">toObject</span><span class="p">(),</span> <span class="p">...);</span>

        <span class="c1">// 5️⃣ 存储到 map 中</span>
        <span class="n">_nameToMetaDataMap</span><span class="p">[</span><span class="n">newMetaData</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">newMetaData</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 6️⃣ 后续使用时</span>
<span class="n">FactMetaData</span><span class="o">*</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">_compInfoParam</span><span class="o">-&gt;</span><span class="n">factMetaDataForName</span><span class="p">(</span><span class="s">"PARAM_NAME"</span><span class="p">);</span>
<span class="c1">// 使用 meta 来验证、转换参数值</span>
</code></pre></div></div> <h3 id="42-对应的-mavlink-服务">4.2. 对应的 MAVLink 服务</h3> <p>请求<code class="language-plaintext highlighter-rouge">META</code>数据使用微服务<a href="https://mavlink.io/en/services/component_information.html" rel="external nofollow noopener" target="_blank">Component Metadata Protocol (WIP)</a>，命令字：<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_COMPONENT_METADATA</code>。针对各个<code class="language-plaintext highlighter-rouge">META</code>数据类型，提供了枚举定义<code class="language-plaintext highlighter-rouge">COMP_METADATA_TYPE</code>。</p> <p>请求流程图如下所示：</p> <pre><code class="language-mermaid">sequenceDiagram;
    participant Client
    participant Server
    Note over Server, Client: Client: Request component information.
    Client-&gt;&gt;Server: MAV_CMD_REQUEST_MESSAGE(param1=397)
    Client--&gt;&gt;Client: Start ACK receive timeout
      Server-&gt;&gt;Client: CMD_ACK
      Server-&gt;&gt;Client: COMPONENT_METADATA( uri, file_crc)
    Note over Server, Client: Client check file at uri has changed (using CRC in file_crc).
    Note over Server, Client: Client download file at uri using MAVFTP and parse.
    Note over Server, Client: Client download other metadata types referenced in general metadata&lt;br&gt; (from device or Internet).
</code></pre> <h2 id="5-请求系统参数列表">5. 请求系统参数列表</h2> <p>这个步骤请求飞机的所有参数，使用<code class="language-plaintext highlighter-rouge">MAVLink</code>的微服务<code class="language-plaintext highlighter-rouge">Parameter Protocol</code>，在<code class="language-plaintext highlighter-rouge">QGC</code>的<code class="language-plaintext highlighter-rouge">ParameterManager</code>模块中实现，见上一篇<code class="language-plaintext highlighter-rouge">QGC代码架构解析：MAVLink参数服务及QGC参数管理模块</code>。</p> <p>请求参数，依赖于上一步骤，即请求的参数<code class="language-plaintext highlighter-rouge">META</code>数据文件，用于创建参数对应的<code class="language-plaintext highlighter-rouge">FactMetaData</code>对象。</p> <h2 id="6-请求任务列表航点列表">6. 请求任务列表（航点列表）</h2> <p>这个步骤使用<code class="language-plaintext highlighter-rouge">Mission Protocol</code>，直接调用<code class="language-plaintext highlighter-rouge">PlanManager::loadFromVehicle</code>下载飞机航点信息，进行初始化同步。具体参考下一篇<code class="language-plaintext highlighter-rouge">QGC代码架构解析：MAVLink Mission Protocol，以及 QGC 航点管理</code>。</p> <p>由于<code class="language-plaintext highlighter-rouge">MAVLink v2</code>中，<code class="language-plaintext highlighter-rouge">Mission Protocol</code>不仅仅包含航点，还包含地理围栏(<code class="language-plaintext highlighter-rouge">GeoFence</code>)、降落点(<code class="language-plaintext highlighter-rouge">Rally Points</code>)等信息。所有这些部分都实现在<code class="language-plaintext highlighter-rouge">PlanManager</code>以及其继承子类中。</p> <h2 id="7-请求地理围栏列表">7. 请求地理围栏列表</h2> <p>参考6。</p> <h2 id="8-请求降落点列表">8. 请求降落点列表</h2> <p>参考6。</p> <h2 id="9-初始化完成">9. 初始化完成</h2> <p>完成初始化，发送<code class="language-plaintext highlighter-rouge">signal</code>，通知<code class="language-plaintext highlighter-rouge">QML</code>界面。</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/al-folio-local-deploy-ubuntu2404/">al-folio 本地部署记录（Ubuntu 24.04）</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/C++-Traits/">C++ Traits</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95/">道格拉斯-普克算法(Douglas–Peucker algorithm)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93/">CMake支持库收集</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/QGC%E9%A3%9E%E8%A1%8C%E5%89%8D%E6%A3%80%E6%9F%A5/">QGC代码架构解析：飞行前检查（起飞条件）</a> </li> </div> </div> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2026 Roderick Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?v=c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?v=f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=ccc841c459bfc0e64c1c2b5acd10df02"></script> </body> </html>