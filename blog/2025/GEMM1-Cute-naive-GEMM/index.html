<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> GEMM ç‰ˆæœ¬1ï¼šä½¿ç”¨ CuTe å®ç°ä¸€ä¸ª naive GEMM | Roderick Huang </title> <meta name="author" content="Roderick Huang"> <meta name="description" content="Roderick Huang çš„ä¸ªäººåšå®¢ï¼Œè®°å½•å·¥ä½œä¸æŠ€æœ¯ã€‚ "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="manifest" href="/manifest.json"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a2e"> <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script> <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; media-src 'self' https:; frame-src 'self' https:; connect-src 'self' https:; worker-src 'self';"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?v=6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://hxf0223.github.io/blog/2025/GEMM1-Cute-naive-GEMM/"> <script src="/assets/js/theme.js?v=5fea5159b787642c1bbc1f334d60f883"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Roderick</span> Huang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="fa-solid fa-magnifying-glass"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-half-sun-moon" id="light-toggle-system"></i> <i class="fa-solid fa-moon" id="light-toggle-dark"></i> <i class="fa-solid fa-sun" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">GEMM ç‰ˆæœ¬1ï¼šä½¿ç”¨ CuTe å®ç°ä¸€ä¸ª naive GEMM</h1> <p class="post-meta"> Created on February 26, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a> Â  Â· Â  <a href="/blog/tag/cuda"> <i class="fa-solid fa-hashtag fa-sm"></i> CUDA</a> Â  Â· Â  <a href="/blog/category/cuda"> <i class="fa-solid fa-tag fa-sm"></i> CUDA</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><img src="/assets/images/cuda/20250226/gemm_tile_naive_cute/gemm_naive_tile.jpg" alt="tile_gemm"></p> <h2 id="1-navie-tile-gemm">1. navie tile GEMM</h2> <ul> <li>ä»£ç æ–‡ä»¶ï¼š<a href="https://github.com/HPC02/cuda_perf/blob/master/src/cute_gemm/gemm_tile_naive.cu" rel="external nofollow noopener" target="_blank">navie tile GEMM</a> </li> </ul> <p>åŸºäºåˆ†å—çŸ©é˜µä¹˜æ³•çš„ç®€å•å®ç°ï¼ŒæŒ‰ç…§ Thread Block å°†çŸ©é˜µåˆ’åˆ†ä¸ºå¤šä¸ªtileè¿›è¡Œè®¡ç®—ï¼Œåœ¨ Thread Blockå†…ï¼Œå†æ¬¡å°† tile åˆ’åˆ†ä¸ºå¤šä¸ªå­å—ï¼Œç”±æ¯ä¸ªçº¿ç¨‹è´Ÿè´£è®¡ç®—å­å—ã€‚</p> <p>ä½¿ç”¨ Shared Memory æ¥ç¼“å­˜ tile æ•°æ®ï¼Œå‡å°‘å…¨å±€å†…å­˜è®¿é—®æ¬¡æ•°ã€‚æ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä»å…¨å±€å†…å­˜ä¸­å¤åˆ¶ tile å†…çš„ä¸€å°å—å†…å­˜åˆ° Shared Memoryã€‚</p> <ul> <li>å¾ªç¯å±•å¼€<code class="language-plaintext highlighter-rouge">#pragma unroll</code>ä¼˜åŒ–åŠ è½½å’Œè®¡ç®—éƒ¨åˆ†çš„å¾ªç¯ï¼Œæé«˜æŒ‡ä»¤çº§å¹¶è¡Œæ€§ï¼ˆæ¶ˆè€—æ›´å¤šå¯„å­˜å™¨èµ„æºï¼‰ï¼Œæœ¬ä»£ç æµ‹è¯•æ•´ä½“è¿è¡Œæ—¶é—´æå‡<code class="language-plaintext highlighter-rouge">15%</code>å·¦å³ã€‚</li> </ul> <h2 id="2-cute-ç‰ˆæœ¬-naive-tile-gemm">2. CuTe ç‰ˆæœ¬ naive tile GEMM</h2> <ul> <li>ä»£ç æ–‡ä»¶ï¼š<a href="https://github.com/HPC02/cuda_perf/blob/master/src/cute_gemm/gemm_tile_naive_cute.cu" rel="external nofollow noopener" target="_blank">CuTe naive tile GEMM</a> </li> </ul> <p>ä½¿ç”¨ CuTe åº“é‡å†™çš„åˆ†å—çŸ©é˜µä¹˜æ³•ï¼Œä½¿ç”¨ slice-k æ–¹æ³•ï¼Œå³åˆ†å—ï¼ˆtileï¼‰æ²¿ç€ K ç»´åº¦ç´¯åŠ æ‰€æœ‰ç»“æœå­çŸ©é˜µã€‚</p> <blockquote> <p>ä½¿ç”¨ NVIDIA CuTe åº“é‡å†™çš„åˆ†å—çŸ©é˜µä¹˜æ³•å®ç°ï¼Œé‡‡ç”¨ <code class="language-plaintext highlighter-rouge">cute::gemm</code> æœŸæœ›çš„æ ‡å‡†å¸ƒå±€ã€‚</p> </blockquote> <h3 id="21-çŸ©é˜µå¸ƒå±€çº¦å®š">2.1. çŸ©é˜µå¸ƒå±€çº¦å®š</h3> <p>é‡‡ç”¨ <strong>BLAS/Fortran é£æ ¼çš„åˆ—ä¸»åº (Column-major)</strong>ï¼š</p> <table> <thead> <tr> <th>Tensor</th> <th>Shape</th> <th>Stride</th> <th>è¯´æ˜</th> </tr> </thead> <tbody> <tr> <td>A</td> <td>(M, K)</td> <td>(1, M)</td> <td>åˆ—ä¸»åºï¼ŒMæ–¹å‘è¿ç»­</td> </tr> <tr> <td>B</td> <td>(N, K)</td> <td>(1, N)</td> <td>åˆ—ä¸»åºï¼Œå­˜å‚¨ B^T</td> </tr> <tr> <td>C</td> <td>(M, N)</td> <td>(1, M)</td> <td>åˆ—ä¸»åºï¼ŒMæ–¹å‘è¿ç»­</td> </tr> </tbody> </table> <blockquote> <p>çŸ©é˜µå‚æ•°ï¼Œä»¥åŠåˆ’åˆ†å‚æ•°ï¼šM=1024ï¼ŒN=1024ï¼ŒK=1024*8ï¼ŒBM=64ï¼ŒBN=64ï¼ŒBK=16ï¼ŒTM=8ï¼ŒTN=8ã€‚ <strong>å…³é”®ç‚¹</strong>ï¼šB çŸ©é˜µä»¥ (N, K) å½¢å¼å­˜å‚¨ï¼Œå®é™…ä¸Šæ˜¯åŸå§‹ B(K, N) çš„è½¬ç½®ã€‚è¿™æ˜¯ <code class="language-plaintext highlighter-rouge">cute::gemm</code> çš„æ ‡å‡†è¾“å…¥æ ¼å¼ã€‚</p> </blockquote> <p>åˆ›å»ºçš„çŸ©é˜µ Aã€Bã€C çš„ tensor è§†å›¾å¦‚ä¸‹ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// A: (M, K) åˆ—ä¸»åº, stride = (1, M)</span>
<span class="c1">// B: (N, K) åˆ—ä¸»åº, stride = (1, N)  -- æ³¨æ„è¿™é‡Œå­˜çš„æ˜¯Bçš„è½¬ç½®</span>
<span class="c1">// C: (M, N) åˆ—ä¸»åº, stride = (1, M)</span>
<span class="n">Tensor</span> <span class="n">mA</span> <span class="o">=</span> <span class="n">make_tensor</span><span class="p">(</span><span class="n">make_gmem_ptr</span><span class="p">(</span><span class="n">Aptr</span><span class="p">),</span> <span class="n">make_shape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">make_stride</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">M</span><span class="p">));</span>
<span class="n">Tensor</span> <span class="n">mB</span> <span class="o">=</span> <span class="n">make_tensor</span><span class="p">(</span><span class="n">make_gmem_ptr</span><span class="p">(</span><span class="n">Bptr</span><span class="p">),</span> <span class="n">make_shape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">make_stride</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">N</span><span class="p">));</span>
<span class="n">Tensor</span> <span class="n">mC</span> <span class="o">=</span> <span class="n">make_tensor</span><span class="p">(</span><span class="n">make_gmem_ptr</span><span class="p">(</span><span class="n">Cptr</span><span class="p">),</span> <span class="n">make_shape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">make_stride</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">M</span><span class="p">));</span>
</code></pre></div></div> <blockquote> <p>kernel çš„ dimensions é…ç½®ä¸ºï¼š</p> </blockquote> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dim3</span> <span class="nf">gridDim</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">BN</span><span class="p">,</span> <span class="n">M</span> <span class="o">/</span> <span class="n">BM</span><span class="p">);</span>   <span class="c1">// (16, 16)</span>
<span class="n">dim3</span> <span class="nf">blockDim</span><span class="p">(</span><span class="n">BN</span> <span class="o">/</span> <span class="n">TN</span><span class="p">,</span> <span class="n">BM</span> <span class="o">/</span> <span class="n">TM</span><span class="p">);</span><span class="c1">// (8, 8)</span>
</code></pre></div></div> <h3 id="22-cute-å®ç°åˆ†å—åˆ†å‰²çº¿ç¨‹åˆ†åŒºæ‹·è´åŠè®¡ç®—">2.2. CuTe å®ç°ï¼šåˆ†å—åˆ†å‰²ã€çº¿ç¨‹åˆ†åŒºã€æ‹·è´åŠè®¡ç®—</h3> <p>ä»¥çŸ©é˜µ A ä¸ºä¾‹ï¼ŒçŸ©é˜µ A åœ¨ M çº¬åº¦ä¸Šï¼Œæ¯ä¸ª Thread Block è´Ÿè´£å¤„ç† BM è¡Œï¼ˆå¤åˆ¶ + GEMMï¼‰ï¼›åœ¨ K ç»´åº¦ä¸Šï¼ŒThread Block è´Ÿè´£å¤„ç† BK åˆ—ã€‚Thread Block ä»¥äºŒç»´çš„æ–¹å¼åˆ’åˆ†ï¼Œéœ€è¦çš„ Thread Block æ•°é‡ä¸º (M/BM, N/BN)ï¼Œå³åˆ’åˆ†çš„ tile æ•°é‡ï¼›æ¯ä¸ª Thread Block å†…çš„çº¿ç¨‹æ•°é‡ä¸º (BM/TM, BN/TN)ï¼Œå³åŒæ ·ä»¥äºŒç»´çš„æ–¹å¼å°† tile å†æ¬¡åˆ’åˆ†ç»™ Thread Block å†…çš„çº¿ç¨‹ã€‚</p> <p>ä½¿ç”¨ slice-k æ–¹æ³•ï¼ŒThread Block éœ€è¦å¾ªç¯éå† K ç»´åº¦ï¼Œå°†çŸ©é˜µ A åˆ†å—åŠ è½½åˆ° SMEM ä¸­ã€‚æ‰€ä»¥åˆ›å»ºçš„ tile tensor è§†å›¾æ˜¯ä¸€ä¸ªä¸‰ç»´ tensorï¼š (BM, BK, K/BK) å¤§å°ã€‚çŸ©é˜µ B åŒç†ï¼Œå¾—åˆ°çš„ä¸‰ç»´ tensorï¼š(BN, BK, K/BK)ã€‚</p> <p>ç”±äºåˆ†å—è®¡ç®—å¾—åˆ°çš„ C çŸ©é˜µ tile å¤§å°ä¸º (BM, BN)ï¼Œæ‰€ä»¥éœ€è¦å–å¾—çŸ©é˜µ C çš„ tile tensorã€‚</p> <blockquote> <p>çŸ©é˜µ Aã€B åˆ†å— GEMM éœ€è¦çš„ SMEMã€‚å…¶æœ¬è´¨æ˜¯ç¼“å­˜ï¼Œå¤§å°ä¸ºä¸€ä¸ª tile å¤§å°ã€‚å³é’ˆå¯¹çŸ©é˜µ Aï¼ŒThread Block æ¯æ¬¡ä» GMEM ä¸­ä¾æ¬¡å–å¾— (BM, BK) åˆ†å—å¤§å°å¤åˆ¶åˆ° SMEMï¼Œç„¶åæ²¿ç€ K ç»´åº¦å¾ªç¯ for(product)ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p> </blockquote> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__shared__</span> <span class="n">T</span> <span class="n">smemA</span><span class="p">[</span><span class="n">BM</span> <span class="o">*</span> <span class="n">BK</span><span class="p">];</span>
<span class="n">__shared__</span> <span class="n">T</span> <span class="n">smemB</span><span class="p">[</span><span class="n">BN</span> <span class="o">*</span> <span class="n">BK</span><span class="p">];</span>

<span class="c1">// sA: (BM, BK) åˆ—ä¸»åº, stride = (1, BM)</span>
<span class="c1">// sB: (BN, BK) åˆ—ä¸»åº, stride = (1, BN)</span>
<span class="n">Tensor</span> <span class="n">sA</span> <span class="o">=</span> <span class="n">make_tensor</span><span class="p">(</span><span class="n">make_smem_ptr</span><span class="p">(</span><span class="n">smemA</span><span class="p">),</span> <span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BK</span><span class="o">&gt;</span><span class="p">{}),</span> <span class="n">make_stride</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span><span class="o">&gt;</span><span class="p">{}));</span>
<span class="n">Tensor</span> <span class="n">sB</span> <span class="o">=</span> <span class="n">make_tensor</span><span class="p">(</span><span class="n">make_smem_ptr</span><span class="p">(</span><span class="n">smemB</span><span class="p">),</span> <span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BK</span><span class="o">&gt;</span><span class="p">{}),</span> <span class="n">make_stride</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span><span class="o">&gt;</span><span class="p">{}));</span>
</code></pre></div></div> <h3 id="221-åˆ†å—æ“ä½œ">2.2.1. åˆ†å—æ“ä½œ</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åˆ›å»ºå…¨å±€å†…å­˜ tensor è§†å›¾</span>
<span class="n">Tensor</span> <span class="n">gA</span> <span class="o">=</span> <span class="n">local_tile</span><span class="p">(</span><span class="n">mA</span><span class="p">,</span> <span class="n">make_tile</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BK</span><span class="o">&gt;</span><span class="p">{}),</span> <span class="n">make_coord</span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">_</span><span class="p">));</span>           <span class="c1">// (BM, BK, k)</span>
<span class="n">Tensor</span> <span class="n">gB</span> <span class="o">=</span> <span class="n">local_tile</span><span class="p">(</span><span class="n">mB</span><span class="p">,</span> <span class="n">make_tile</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BK</span><span class="o">&gt;</span><span class="p">{}),</span> <span class="n">make_coord</span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">_</span><span class="p">));</span>           <span class="c1">// (BN, BK, k)</span>
<span class="n">Tensor</span> <span class="n">gC</span> <span class="o">=</span> <span class="n">local_tile</span><span class="p">(</span><span class="n">mC</span><span class="p">,</span> <span class="n">make_tile</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span><span class="o">&gt;</span><span class="p">{}),</span> <span class="n">make_coord</span><span class="p">(</span><span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="p">));</span>  <span class="c1">// (BM, BN)</span>
</code></pre></div></div> <p>æŒ‰ç…§è¯­ä¹‰ç†è§£ï¼ŒA çŸ©é˜µä½¿ç”¨ shape(BM, BK) æ²¿ç€ M ç»´åº¦ä»¥åŠ K ç»´åº¦è¿›è¡Œåˆ‡åˆ†ï¼Œå³å°†å…¶åˆ’åˆ†ä¸ºè‹¥å¹² tileï¼Œæ¯ä¸ª tile çš„å¤§å°ä¸º (BM, BK)ã€‚è€Œåï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">make_coord(blockIdx.y, _)</code> å–å¾—ç¬¬ <code class="language-plaintext highlighter-rouge">blockIdx.y</code> ä¸ª tileï¼Œåœ¨ K ç»´åº¦ä¸Šä½¿ç”¨ <code class="language-plaintext highlighter-rouge">_</code> è¡¨ç¤ºå–æ‰€æœ‰ tileï¼Œæ‰€ä»¥ç”Ÿæˆäº†ä¸€ä¸ªä¸‰ç»´çš„ Tensorã€‚ç”±äº A çŸ©é˜µåœ¨ K ç»´åº¦ä¸Šè¢«åˆ‡åˆ†ä¸ºå¤šä¸ª tileï¼Œæ‰€ä»¥æœ€ç»ˆç”Ÿæˆçš„ tensor ç»´åº¦ä¸º (BM, BK, K/BK)ï¼Œå³è¡¨ç¤ºæœ‰ K/BK ä¸ªäºŒç»´ tile(BM, BK)ã€‚</p> <p>ä½œä¸ºå¯¹æ¯”ï¼ŒçŸ©é˜µ C åœ¨ M ç»´åº¦ä»¥åŠ N ç»´åº¦ä¸Šè¿›è¡Œåˆ‡åˆ†ï¼Œå¾—åˆ°è‹¥å¹²ä¸ª tileï¼Œæ¯ä¸ª tile çš„å¤§å°ä¸º (BM, BN)ã€‚è€Œåä½¿ç”¨å®Œæ•´çš„äºŒç»´åæ ‡ <code class="language-plaintext highlighter-rouge">make_coord(blockIdx.y, blockIdx.x)</code> å–å¾—å”¯ä¸€çš„ tileï¼Œæ•…å…¶ç”Ÿæˆçš„ tensor ç»´åº¦ä¸º (BM, BN)ã€‚</p> <p>åˆ†å—ä¹‹åï¼Œæ¯ä¸ª Thread Block åˆ†åˆ°çš„ tile shape å¦‚ä¸‹ï¼š</p> <ul> <li>gA(64, 16, 512)ï¼šå…¶ä¸­ï¼Œ1024*8 / 16 = 512ï¼Œå³è¿™æ˜¯ä¸€ä¸ª tile group</li> <li>gB(64, 16, 512)ï¼šå…¶ä¸­ï¼Œ1024*8 / 16 = 512ï¼Œå³è¿™æ˜¯ä¸€ä¸ª tile group</li> <li>gC(64, 64)</li> </ul> <h3 id="222-çº¿ç¨‹åˆ†åŒº">2.2.2. çº¿ç¨‹åˆ†åŒº</h3> <p><strong>åˆ†åŒºå¤åˆ¶ GMEM -&gt; SMEM</strong>ï¼š</p> <p>å‰é¢å·²ç»æŒ‰ç…§ Thread Block åˆ†å—å¾—åˆ° tileï¼Œç°åœ¨éœ€è¦ç»§ç»­å°†åˆ’åˆ†ç»†åŒ–åˆ° Thread Block å†…çš„æ¯ä¸ªçº¿ç¨‹ã€‚é¦–å…ˆè®¡ç®—çº¿ç¨‹æ•°é‡ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// çº¿ç¨‹å—é…ç½®: (BN/TN, BM/TM) = (8, 8) = 64 çº¿ç¨‹</span>
<span class="k">constexpr</span> <span class="kt">int</span> <span class="n">num_threads</span> <span class="o">=</span> <span class="p">(</span><span class="n">BM</span> <span class="o">/</span> <span class="n">TM</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">BN</span> <span class="o">/</span> <span class="n">TN</span><span class="p">);</span>
</code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// çº¿ç¨‹åˆ’åˆ†æ–¹æ³•ï¼šæŒ‰ç…§ M ç»´åº¦åˆ’åˆ† A çŸ©é˜µï¼ŒN ç»´åº¦åˆ’åˆ† B çŸ©é˜µ</span>
<span class="n">Layout</span> <span class="n">tA_copy</span> <span class="o">=</span> <span class="n">make_layout</span><span class="p">(</span><span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">num_threads</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{}));</span>
<span class="n">Layout</span> <span class="n">tB_copy</span> <span class="o">=</span> <span class="n">make_layout</span><span class="p">(</span><span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">num_threads</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{}));</span>

<span class="c1">// å¾—åˆ°æœ¬çº¿ç¨‹åˆ’åˆ†çš„ sub-tile</span>
<span class="n">Tensor</span> <span class="n">tAgA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">gA</span><span class="p">,</span> <span class="n">tA_copy</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>  <span class="c1">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„gAéƒ¨åˆ†</span>
<span class="n">Tensor</span> <span class="n">tAsA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span> <span class="n">tA_copy</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>  <span class="c1">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„sAéƒ¨åˆ†</span>
<span class="n">Tensor</span> <span class="n">tBgB</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">gB</span><span class="p">,</span> <span class="n">tB_copy</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>  <span class="c1">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„gBéƒ¨åˆ†</span>
<span class="n">Tensor</span> <span class="n">tBsB</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">tB_copy</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>  <span class="c1">// æ¯ä¸ªçº¿ç¨‹è´Ÿè´£çš„sBéƒ¨åˆ†</span>
</code></pre></div></div> <p>é’ˆå¯¹ tile Aï¼Œåªåœ¨ M ç»´åº¦ä¸Šè¿›è¡Œçº¿ç¨‹åˆ’åˆ†ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£å¤åˆ¶ <code class="language-plaintext highlighter-rouge">BM / num_threads</code> è¡Œæ•°æ®ï¼Œåœ¨ K ç»´åº¦ä¸Šè´Ÿè´£å¤åˆ¶å…¨éƒ¨ K åˆ—æ•°æ®ï¼Œç»´åº¦ä¿¡æ¯ä¿æŒï¼ŒtAgAã€tBgB è¿˜æ˜¯ä¸€ä¸ªä¸‰ç»´ tensorã€‚æ¯ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œå¤åˆ¶æ—¶ï¼Œåœ¨ K ç»´åº¦ä¸Šæ¯æ¬¡å¤åˆ¶ BK åˆ—ï¼Œä¸€å…±éœ€è¦ K / BK æ¬¡å¾ªç¯ï¼Œæ‰èƒ½å®Œæˆ sub-tile çš„åŠ è½½ä»¥åŠ GEMM å¾—åˆ°æœ€ç»ˆçš„ç»“æœã€‚</p> <p>çŸ©é˜µ B åŒç†ï¼Œåªåœ¨ N ç»´åº¦ä¸Šè¿›è¡Œçº¿ç¨‹åˆ’åˆ†ã€‚</p> <p>å¾—åˆ°çš„çº¿ç¨‹åˆ†åŒº tensor layout å¦‚ä¸‹ï¼š</p> <ul> <li>tAgA(1, 16)ï¼šshape: (_1,_16,512), stride: (_0,1024,16384)</li> <li>tAsA(1, 16)ï¼šshape: (_1,_16), stride: (_0,64)</li> <li>tBgB(1, 16)ï¼šshape: (_1,_16,512), stride: (_0,1024,16384)</li> <li>tBsB(1, 16)ï¼šshape: (_1,_16), stride: (_0,64)</li> </ul> <p><strong>è®¡ç®—åˆ†åŒº</strong>ï¼š</p> <p>æ¯ä¸ªçº¿ç¨‹å¤åˆ¶åˆ’åˆ†ï¼Œæ˜¯é’ˆå¯¹çŸ©é˜µ Aã€B è¿›è¡Œçš„ã€‚è®¡ç®— C çŸ©é˜µæ—¶ï¼Œéœ€è¦å–å¾— A(TM, TK) åˆ†å—ã€B(TN, TK) åˆ†å—ã€C(TM, TN)ï¼Œè¿›è¡Œçº¿ç¨‹åˆ†å—çš„ GEMM è®¡ç®—ã€‚å¤åˆ¶æ—¶çš„çº¿ç¨‹åˆ†å—ä¸è®¡ç®—æ—¶çš„çº¿ç¨‹åˆ†å—å¯ä»¥åˆ†å¼€ï¼Œå› ä¸ºåœ¨ GMEM -&gt; SMEM å¤åˆ¶ä¹‹åï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">__syncthreads</code> ä¿è¯ Thread Block çš„ A-tileã€B-tile éƒ½å®Œæˆå¤åˆ¶ï¼ˆæ›´ä¸¥è°¨çš„è¯´ï¼Œæ˜¯åœ¨ GMEM -&gt; SMEM ä¸ sub-tile GEMM ä¸¤ä¸ªæ­¥éª¤ä¹‹é—´åŒæ­¥ï¼‰ã€‚</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è®¡ç®—æ—¶çš„çº¿ç¨‹åˆ’åˆ†æ–¹æ³•: (BM/TM, BN/TN) = (8, 8)</span>
<span class="n">Layout</span> <span class="n">tC</span> <span class="o">=</span> <span class="n">make_layout</span><span class="p">(</span><span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span> <span class="o">/</span> <span class="n">TM</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span> <span class="o">/</span> <span class="n">TN</span><span class="o">&gt;</span><span class="p">{}));</span>

<span class="c1">// local_partition: æŒ‰çº¿ç¨‹å¸ƒå±€åˆ†é…å·¥ä½œ</span>
<span class="c1">// Step&lt;_1, X&gt; è¡¨ç¤ºç¬¬ 0 ç»´å‚ä¸åˆ†åŒºï¼Œç¬¬ 1 ç»´ä¸å‚ä¸</span>
<span class="n">Tensor</span> <span class="n">tCsA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">,</span> <span class="n">X</span><span class="o">&gt;</span><span class="p">{});</span>   <span class="c1">// (TM, BK)</span>
<span class="n">Tensor</span> <span class="n">tCsB</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">_1</span><span class="o">&gt;</span><span class="p">{});</span>   <span class="c1">// (TN, BK)</span>
<span class="n">Tensor</span> <span class="n">tCgC</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">gC</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">,</span> <span class="n">_1</span><span class="o">&gt;</span><span class="p">{});</span>  <span class="c1">// (TM, TN)</span>
</code></pre></div></div> <p>çº¿ç¨‹åˆ†åŒºä¹‹åï¼Œå¾—åˆ°çš„æ¯ä¸ªçº¿ç¨‹çš„ tensor layout å¦‚ä¸‹ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tCsA</span> <span class="n">shape</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="n">_16</span><span class="p">),</span> <span class="n">stride</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="n">_64</span><span class="p">)</span>
<span class="n">tCsB</span> <span class="n">shape</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="n">_16</span><span class="p">),</span> <span class="n">stride</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="n">_64</span><span class="p">)</span>
<span class="n">tCgC</span> <span class="n">shape</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="n">_8</span><span class="p">),</span> <span class="n">stride</span><span class="o">:</span> <span class="p">(</span><span class="n">_8</span><span class="p">,</span><span class="mi">8192</span><span class="p">)</span>
</code></pre></div></div> <h3 id="223-slice-k-gemm">2.2.3. slice-k GEMM</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// éå†Kç»´åº¦</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">num_tile_k</span> <span class="o">=</span> <span class="n">K</span> <span class="o">/</span> <span class="n">BK</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">num_tile_k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ä»å…¨å±€å†…å­˜å¤åˆ¶åˆ°å…±äº«å†…å­˜</span>
  <span class="n">copy</span><span class="p">(</span><span class="n">tAgA</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">tAsA</span><span class="p">);</span>
  <span class="n">copy</span><span class="p">(</span><span class="n">tBgB</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">tBsB</span><span class="p">);</span>

  <span class="n">__syncthreads</span><span class="p">();</span>  <span class="c1">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå¤åˆ¶</span>

  <span class="c1">// ä½¿ç”¨ cute::gemm æ‰§è¡ŒçŸ©é˜µä¹˜æ³•</span>
  <span class="c1">// gemm æœŸæœ›: A(M,K), B(N,K), C(M,N) - Bæ˜¯(N,K)å½¢å¼</span>
  <span class="n">gemm</span><span class="p">(</span><span class="n">tCsA</span><span class="p">,</span> <span class="n">tCsB</span><span class="p">,</span> <span class="n">tCrC</span><span class="p">);</span>  <span class="c1">// tCrC += tCsA * tCsB^T</span>

  <span class="n">__syncthreads</span><span class="p">();</span>  <span class="c1">// ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆè®¡ç®—</span>
<span class="p">}</span>
</code></pre></div></div> <p>åœ¨ tile åˆ†åŒºçš„æ—¶å€™ï¼Œå·²ç»å°† A-tileã€B-tile åˆ’åˆ†ä¸º K/BK ä¸ªå­ tileï¼Œå³æ²¿ç€ K ç»´åº¦è¿›è¡Œäº†åˆ†å—ã€‚è®¡ç®—æ—¶ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ª sub-tile è¿›è¡Œ GEMMï¼Œä¸€å…±è¿­ä»£ K / BK æ¬¡ã€‚</p> <blockquote> <p>å½“çŸ©é˜µæ˜¯åˆ—ä¸»åºæ—¶ï¼ˆæ¯”å¦‚çŸ©é˜µ Aã€B æ˜¯ K-majorï¼‰ï¼Œå¦‚æœ Thread Block å†…çš„çº¿ç¨‹ä»»åŠ¡åˆ’åˆ†ä¹ŸæŒ‰ç…§ K-major è¿›è¡Œï¼Œè¿™æ ·å¾—åˆ°çš„è®¿é—®çŸ©é˜µå†…çš„å…ƒç´ çš„ç¼–å·ä¹Ÿæ˜¯è¿ç»­çš„ï¼Œå³<strong>è®¿å­˜åˆå¹¶</strong>ã€‚</p> </blockquote> <h3 id="224-bank-conflict-è®¡ç®—">2.2.4. Bank Conflict è®¡ç®—</h3> <p>ä¾æ® outter-partition åˆ’åˆ†çš„æ–¹å¼ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Layout</span> <span class="n">tC</span> <span class="o">=</span> <span class="n">make_layout</span><span class="p">(</span><span class="n">make_shape</span><span class="p">(</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">BM</span> <span class="o">/</span> <span class="n">TM</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">Int</span><span class="o">&lt;</span><span class="n">BN</span> <span class="o">/</span> <span class="n">TN</span><span class="o">&gt;</span><span class="p">{}));</span>

<span class="n">Tensor</span> <span class="n">tCsA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">,</span> <span class="n">X</span><span class="o">&gt;</span><span class="p">{});</span>   <span class="c1">// (TM, BK)</span>
<span class="n">Tensor</span> <span class="n">tCsB</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sB</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">_1</span><span class="o">&gt;</span><span class="p">{});</span>   <span class="c1">// (TN, BK)</span>
</code></pre></div></div> <p>çº¿ç¨‹åœ¨ tC layout ä¸­çš„äºŒç»´åæ ‡ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tC_row = tid % 8  (M ç»´åº¦æ–¹å‘)
tC_col = tid / 8  (N ç»´åº¦æ–¹å‘)
</code></pre></div></div> <h4 id="2241-tcsa-è®¿é—®æ–¹å¼åŠ-bank-conflict-åˆ†æ">2.2.4.1. tCsA è®¿é—®æ–¹å¼åŠ bank conflict åˆ†æ</h4> <p>Step&lt;_1, X&gt; è¡¨ç¤ºä½¿ç”¨ M ç»´åº¦å‚ä¸åˆ†åŒºã€‚</p> <p>çº¿ç¨‹çš„ tCsA èµ·å§‹è¡Œå·ä¸ºï¼š</p> \[\text{row_offset}_{A} = \text{tC_row} \times \text{TM} = (\text{tid} \% 8) \times 8\] <p>çº¿ç¨‹è®¿é—® sA çš„åœ°å€è®¡ç®—å…¬å¼ï¼š</p> \[\begin{aligned} &amp; \text{addr}_{sA}[m, k] = (\text{row_offset}_{A} + m) + k \times 64 \\ &amp; m \in [0, 7], k \in [0, 15] \end{aligned}\] <p>stride=8ï¼Œå¯ä»¥ç†è§£ä¸ºæ¯ä¸ªçº¿ç¨‹å æ® 8 ä¸ªfloat ç±»å‹æ•°æ®ï¼Œåˆ™ 4 ä¸ªçº¿ç¨‹ä¹‹åå³äº§ç”Ÿ bank conflictã€‚</p> <p>æ­¤æ—¶ï¼Œæ¯éš” 4 ä¸ªçº¿ç¨‹ï¼Œè®¿é—®çš„åœ°å€ä¼šè½åœ¨åŒä¸€ä¸ª bank ä¸Šï¼Œå¹¶äº§ç”Ÿ bank conflictã€‚ä¸€ä¸ª warp å†… ï¼ˆtid - bankIdï¼‰ å¯¹åº”è¡¨å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0 -  0,   1 -  8,   2 -  16,    3 - 24]
[4 -  0,   5 -  8,   6 -  16,    7 - 24]
[8 -  0,   9 -  8,   10 - 16,   11 - 24]
[12 - 0,   13 - 8,   14 - 16,   15 - 24]
</code></pre></div></div> <blockquote> <p>å…¶ä¸­ï¼Œç”±äº m = (m+1) % 8ï¼Œç¬¬ 8 ä¸ªçº¿ç¨‹åœ°å€è·³è·ƒ 64 ä¸ª floatã€‚</p> </blockquote> <p>å³ä¸€ä¸ª warp äº§ç”Ÿ 4 ä¸ª 4-way bank conflictã€‚</p> <h4 id="2242-tcsb-è®¿é—®æ–¹å¼åŠ-bank-conflict-åˆ†æ">2.2.4.2. tCsB è®¿é—®æ–¹å¼åŠ bank conflict åˆ†æ</h4> <p>Step&lt;X, _1&gt; è¡¨ç¤ºä½¿ç”¨ N ç»´åº¦å‚ä¸åˆ†åŒºã€‚</p> <p>æ¯ä¸ªçº¿ç¨‹çš„ tCsB èµ·å§‹è¡Œå·ä¸ºï¼š</p> \[\text{row_offset}_{B} = \text{tC_col} * \text{TN} = (\text{tid} / 8) \times 8\] <p>çº¿ç¨‹è®¿é—® sB çš„åœ°å€è®¡ç®—å…¬å¼ï¼š</p> \[\begin{aligned} &amp; \text{addr}_{sB}[n, k] = (\text{row_offset}_{B} + n) + k \times 64 \\ &amp; n \in [0, 7], k \in [0, 15] \end{aligned}\] <p>æ­¤æ—¶ï¼Œæ¯ 8 ä¸ªçº¿ç¨‹ä¸€ç»„ï¼Œå…¶è®¿é—®åœ°å€éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ã€‚ä¸‹ä¸€ç»„ 8 ä¸ªçº¿ç¨‹ï¼Œå…¶åœ¨ smemB[] ä¸­çš„ç¼–å· +8ã€‚å³æ¯ç›¸é‚»çš„ 8 ä¸ªçº¿ç¨‹ï¼Œäº§ç”Ÿä¸€ä¸ª broadcastã€‚å¯¹åº”è¡¨æ ¼å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[0 - 0,  1 - 0,  2 - 0,  3 - 0, 4 - 0,  5 - 0,  6 - 0,  7 - 0]
[8 - 8,  9 - 8,  10 -8,  11 -8, 12 -8,  13 -8,  14 -8,  15 -8]
</code></pre></div></div> <blockquote> <p>ä¸€ä¸ª warp å†…ï¼Œä»ç¬¬ 8 ä¸ªçº¿ç¨‹å¼€å§‹ï¼Œè®¿é—®ç¼–å·è·³è½¬äº† 64 ä¸ª floatã€‚</p> </blockquote> <h4 id="2243-æ€»ç»“">2.2.4.3. æ€»ç»“</h4> <p>å‘ç°ï¼Œåœ¨å½“å‰æƒ…å†µä¸‹ï¼ˆsA ä¸ sB å¸ƒå±€ç›¸åŒï¼Œä¸”åˆ’åˆ†å¤§å°ç›¸åŒï¼‰ï¼Œä»–ä»¬ä¹‹å‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œæ¥è‡ªäºåˆ’åˆ†æ—¶ï¼Œé€‰æ‹©çš„ç»´åº¦ä¸åŒï¼š</p> <ul> <li>é¦–å…ˆï¼Œçº¿ç¨‹è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªç»´åº¦ï¼Œä¸”ä½¿ç”¨è¿™ä¸¤ä¸ªç»´åº¦åˆ†åˆ«å»åˆ’åˆ† sA ä¸ sBã€‚</li> <li>å…¶æ¬¡ï¼Œç”±äºä½¿ç”¨äº†è¿™ä¸¤ä¸ªç»´åº¦è¿›è¡Œåˆ’åˆ†ï¼Œå¯¼è‡´ M ç»´åº¦æ˜¯ä½¿ç”¨å–ä½™ï¼ŒN ç»´åº¦æ˜¯ä½¿ç”¨æ•´é™¤ã€‚è¿™æ‰æ˜¯å¯¼è‡´è®¿é—®æ¨¡å¼ä¸åŒçš„æ ¹æœ¬åŸå› ã€‚</li> </ul> <p>æ€§èƒ½å½±å“ï¼š</p> <ul> <li>tCsA è®¿é—®äº§ç”Ÿ bank conflictï¼Œå½±å“æ€§èƒ½ã€‚</li> <li>tCsB è®¿é—®äº§ç”Ÿ broadcastï¼Œå¸¦å®½åˆ©ç”¨ç‡ä½ã€‚</li> </ul> <h2 id="3-stride-ç†è§£">3. Stride ç†è§£</h2> <p><code class="language-plaintext highlighter-rouge">make_stride(s0, s1)</code> å®šä¹‰äº†æ²¿å„ç»´åº¦ç§»åŠ¨æ—¶çš„å†…å­˜è·³è·ƒè·ç¦»ï¼š</p> <ul> <li> <code class="language-plaintext highlighter-rouge">stride(1, M)</code> â†’ ç¬¬0ç»´æ­¥é•¿=1ï¼ˆè¿ç»­ï¼‰ï¼Œç¬¬1ç»´æ­¥é•¿=M â†’ <strong>åˆ—ä¸»åº</strong> </li> <li> <code class="language-plaintext highlighter-rouge">stride(M, 1)</code> â†’ ç¬¬0ç»´æ­¥é•¿=Mï¼Œç¬¬1ç»´æ­¥é•¿=1ï¼ˆè¿ç»­ï¼‰ â†’ <strong>è¡Œä¸»åº</strong> </li> </ul> <blockquote> <p><strong>ç®€å•è®°å¿†</strong>ï¼šStride ä¸º 1 çš„ç»´åº¦åœ¨å†…å­˜ä¸­è¿ç»­ã€‚</p> </blockquote> <h2 id="4-cute-å‘½åçº¦å®š">4. CuTe å‘½åçº¦å®š</h2> <p>CuTe é‡‡ç”¨ä¸‰æ®µå¼å‘½åè§„åˆ™ï¼š<code class="language-plaintext highlighter-rouge">t[åˆ†åŒºè€…][å­˜å‚¨ç©ºé—´][çŸ©é˜µ]</code>ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>t C s A
â”‚ â”‚ â”‚ â””â”€ çŸ©é˜µï¼šA / B / C
â”‚ â”‚ â””â”€â”€â”€ å­˜å‚¨ç©ºé—´ï¼šg(global) / s(smem) / r(register)
â”‚ â””â”€â”€â”€â”€â”€ åˆ†åŒºè€…ï¼ˆPartitionerï¼‰ï¼šA / B / C
â””â”€â”€â”€â”€â”€â”€â”€ å‰ç¼€ï¼št = thread-partitioned tensor
</code></pre></div></div> <h3 id="41-å‰ç¼€-t">4.1. å‰ç¼€ t</h3> <p>è¡¨ç¤ºè¯¥ Tensor å·²ç»è¿‡çº¿ç¨‹åˆ†åŒºï¼ˆthread partitioningï¼‰ï¼Œå³é€šè¿‡ local<em>partition æˆ– TiledMMA::partition</em>* åˆ‡åˆ†åï¼Œå½“å‰çº¿ç¨‹æ‰€â€çœ‹åˆ°â€çš„å­è§†å›¾ã€‚</p> <h3 id="42-åˆ†åŒºè€…æ ‡è¯†a--b--c">4.2. åˆ†åŒºè€…æ ‡è¯†ï¼šA / B / C</h3> <p>è¿™æ˜¯å‘½åä¸­æœ€å®¹æ˜“æ··æ·†çš„éƒ¨åˆ†ã€‚å®ƒä¸æ˜¯æŒ‡çŸ©é˜µæœ¬èº«ï¼Œè€Œæ˜¯ç”¨äºåˆ†åŒºçš„çº¿ç¨‹ Layout å¯¹è±¡ï¼š</p> <table> <thead> <tr> <th>æ ‡è¯†</th> <th>å¯¹åº”çº¿ç¨‹ Layout</th> <th>ä½œç”¨</th> </tr> </thead> <tbody> <tr> <td>tA</td> <td>AThreadLayout tA</td> <td>ç”¨äº Copy é˜¶æ®µå¯¹ A çŸ©é˜µçš„çº¿ç¨‹åˆ†åŒº</td> </tr> <tr> <td>tB</td> <td>BThreadLayout tB</td> <td>ç”¨äº Copy é˜¶æ®µå¯¹ B çŸ©é˜µçš„çº¿ç¨‹åˆ†åŒº</td> </tr> <tr> <td>tC</td> <td>CThreadLayout tC / TiledMMA</td> <td>ç”¨äº Mathï¼ˆMMAï¼‰é˜¶æ®µå¯¹ C/A/B çš„çº¿ç¨‹åˆ†åŒº</td> </tr> </tbody> </table> <p><code class="language-plaintext highlighter-rouge">tC</code> çš„æœ¬è´¨ï¼š<code class="language-plaintext highlighter-rouge">C</code> çš„çº¿ç¨‹è¦†ç›–ï¼ˆoverlayï¼‰å¸ƒå±€ï¼Œå³ MMA è®¡ç®—è¾“å‡ºçš„çº¿ç¨‹åˆ†å¸ƒæ¨¡å¼ã€‚å®˜æ–¹ Issue åŸè¯ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"tC refers to the layout of the overlay threads of MMA."
</code></pre></div></div> <h3 id="43-å­˜å‚¨ç©ºé—´æ ‡è¯†g--s--r">4.3. å­˜å‚¨ç©ºé—´æ ‡è¯†ï¼šg / s / r</h3> <table> <thead> <tr> <th>å‰ç¼€</th> <th>è‹±æ–‡</th> <th>å«ä¹‰</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">m</code></td> <td>matrix</td> <td>å®Œæ•´çŸ©é˜µçš„ tensor è§†å›¾</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">g</code></td> <td>global</td> <td>å…¨å±€å†…å­˜ä¸­çš„ tile</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">s</code></td> <td>shared</td> <td>å…±äº«å†…å­˜ä¸­çš„ tensor</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">r</code></td> <td>register</td> <td>å¯„å­˜å™¨ä¸­çš„ tensor</td> </tr> </tbody> </table> <h3 id="44-çŸ©é˜µæ ‡è¯†a--b--c">4.4. çŸ©é˜µæ ‡è¯†ï¼šA / B / C</h3> <p>æŒ‡è¢«åˆ†åŒºçš„ç›®æ ‡çŸ©é˜µã€‚</p> <h3 id="45-ç¤ºä¾‹">4.5. ç¤ºä¾‹</h3> <p>ä»¥ å®˜æ–¹ç¤ºä¾‹ <a href="https://github.com/NVIDIA/cutlass/blob/main/examples/cute/tutorial/sgemm_1.cu" rel="external nofollow noopener" target="_blank">https://github.com/NVIDIA/cutlass/blob/main/examples/cute/tutorial/sgemm_1.cu</a> ä¸ºä¾‹ï¼ŒCopy é˜¶æ®µä¸ Math é˜¶æ®µå¯¹ <code class="language-plaintext highlighter-rouge">sA</code> ä½¿ç”¨äº†ä¸¤å¥—ä¸åŒçš„åˆ†åŒºæ–¹å¼ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Copy é˜¶æ®µï¼šç”¨ tAï¼ˆ32x8 çº¿ç¨‹å¸ƒå±€ï¼‰å¯¹ sA åšåˆ†åŒº</span>
<span class="n">Tensor</span> <span class="n">tAsA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span> <span class="n">tA</span><span class="p">,</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>    <span class="c1">// (THR_M, THR_K)</span>
<span class="c1">//     â†‘â†‘â†‘</span>
<span class="c1">//     tA åˆ†åŒºè€… + så…±äº«å†…å­˜ + AçŸ©é˜µ</span>

<span class="c1">// Math é˜¶æ®µï¼šç”¨ tCï¼ˆ16x16 çº¿ç¨‹å¸ƒå±€ï¼‰å¯¹ sA åšåˆ†åŒº</span>
<span class="n">Tensor</span> <span class="n">tCsA</span> <span class="o">=</span> <span class="n">local_partition</span><span class="p">(</span><span class="n">sA</span><span class="p">,</span> <span class="n">tC</span><span class="p">,</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">Step</span><span class="o">&lt;</span><span class="n">_1</span><span class="p">,</span> <span class="n">X</span><span class="o">&gt;</span><span class="p">{});</span>  <span class="c1">// (THR_M, BLK_K)</span>
<span class="c1">//     â†‘â†‘â†‘</span>
<span class="c1">//     tC åˆ†åŒºè€… + så…±äº«å†…å­˜ + AçŸ©é˜µ</span>
</code></pre></div></div> <blockquote> <p>ğŸ’¡ å…³é”®ç‚¹ï¼šåŒä¸€å— <code class="language-plaintext highlighter-rouge">sA</code> å…±äº«å†…å­˜ï¼Œè¢« <code class="language-plaintext highlighter-rouge">tA</code> åˆ†åŒºç”¨äº cute::copyï¼Œåˆè¢« <code class="language-plaintext highlighter-rouge">tC</code> åˆ†åŒºç”¨äº cute::gemmã€‚é€šè¿‡å‰ç¼€å°±èƒ½ä»å˜é‡åç›´æ¥è¯†åˆ«â€ç”¨å“ªå¥—çº¿ç¨‹å¸ƒå±€åœ¨æ“ä½œâ€ã€‚</p> </blockquote> <ul> <li>cutlass issue ä¸­ï¼Œå‘½åæé—®ï¼š<a href="https://github.com/NVIDIA/cutlass/issues/1052#issuecomment-1680718745" rel="external nofollow noopener" target="_blank">https://github.com/NVIDIA/cutlass/issues/1052#issuecomment-1680718745</a> </li> <li>å®˜æ–¹æ–‡æ¡£æœ‰ç›¸å…³è®²è§£ï¼š<a href="https://github.com/NVIDIA/cutlass/blob/main/media/docs/cpp/cute/0x_gemm_tutorial.md#copy-partitioning" rel="external nofollow noopener" target="_blank">https://github.com/NVIDIA/cutlass/blob/main/media/docs/cpp/cute/0x_gemm_tutorial.md#copy-partitioning</a> </li> </ul> <h2 id="5-qa">5. Q/A</h2> <blockquote> <p><strong>ä¸ºä»€ä¹ˆåŒä¸€ä¸ªçŸ©é˜µæœ‰ä¸åŒçš„åˆ†åŒºï¼Ÿ</strong> å› ä¸ºå¤åˆ¶å’Œè®¡ç®—æ—¶çš„çº¿ç¨‹åˆ†å·¥ä¸åŒã€‚ä¾‹å¦‚ <code class="language-plaintext highlighter-rouge">sA</code>ï¼š å¤åˆ¶æ—¶ï¼š64ä¸ªçº¿ç¨‹å¹³å‡åˆ†é… <code class="language-plaintext highlighter-rouge">BMÃ—BK</code> å…ƒç´  â†’ <code class="language-plaintext highlighter-rouge">tAsA</code> è®¡ç®—æ—¶ï¼šæ¯ä¸ªçº¿ç¨‹å– <code class="language-plaintext highlighter-rouge">TMÃ—BK</code> å­çŸ©é˜µ â†’ <code class="language-plaintext highlighter-rouge">tCsA</code></p> </blockquote> <h2 id="èµ„æ–™">èµ„æ–™</h2> <ul> <li> <a href="https://docs.nvidia.com/deeplearning/performance/dl-performance-matrix-multiplication/index.html" rel="external nofollow noopener" target="_blank">Matrix Multiplication Background Userâ€™s Guide</a>ã€‚å¦‚ä½•è®¡ç®— GEMM çš„æ€§èƒ½æŒ‡æ ‡</li> <li> <a href="https://docs.nvidia.com/cutlass/latest/media/docs/cpp/cute/0x_gemm_tutorial.html" rel="external nofollow noopener" target="_blank">CuTe dense matrix-matrix multiply tutorial</a>ã€‚CuTe GEMM å®˜æ–¹ Documentã€‚</li> <li> <a href="https://zhuanlan.zhihu.com/p/667521327" rel="external nofollow noopener" target="_blank">cute ä¹‹ ç®€å•GEMMå®ç°</a>ï¼šreed çŸ¥ä¹æ–‡ç« </li> <li> <a href="https://zhuanlan.zhihu.com/p/663092747" rel="external nofollow noopener" target="_blank">cute ä¹‹ MMAæŠ½è±¡</a>ï¼šreed çŸ¥ä¹æ–‡ç« </li> <li> <a href="https://leimao.github.io/blog/CuTe-Local-Partition/" rel="external nofollow noopener" target="_blank">CuTe Local Partition</a>ï¼šMao Leiåšå®¢</li> <li> <a href="https://leimao.github.io/article/CUDA-Matrix-Multiplication-Optimization/" rel="external nofollow noopener" target="_blank">CUDA Matrix Multiplication Optimization</a>ï¼šMao Leiåšå®¢ï¼ŒGEMMä¼˜åŒ–æ­¥éª¤å…¨è§£æ</li> <li> <a href="https://research.colfax-intl.com/category/papers/tutorials/" rel="external nofollow noopener" target="_blank">Colfax Research Cute Tutorial</a>ï¼šColfax Research Cute Tutorial</li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/al-folio-customization-summary/">al-folio æ¨¡æ¿å®šåˆ¶ä¿®æ”¹æ€»ç»“</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/al-folio-local-deploy-ubuntu2404/">al-folio æœ¬åœ°éƒ¨ç½²è®°å½•ï¼ˆUbuntu 24.04ï¼‰</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/C++-Traits/">C++ Traits</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95/">é“æ ¼æ‹‰æ–¯-æ™®å…‹ç®—æ³•(Douglasâ€“Peucker algorithm)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93/">CMakeæ”¯æŒåº“æ”¶é›†</a> </li> </div> </div> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> Â© Copyright 2026 Roderick Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?v=c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?v=f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=ccc841c459bfc0e64c1c2b5acd10df02"></script> </body> </html>