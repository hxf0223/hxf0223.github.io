<!DOCTYPE html> <html lang="zh-CN"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> CUTLASS-Cute åˆæ­¥(3.1)ï¼šTiledCopy ä»¥åŠ TiledMMA é…ç½®ç¤ºä¾‹ | Roderick Huang </title> <meta name="author" content="Roderick Huang"> <meta name="description" content="Roderick Huang çš„ä¸ªäººåšå®¢ï¼Œè®°å½•å·¥ä½œä¸æŠ€æœ¯ã€‚ "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="manifest" href="/manifest.json"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1a1a2e"> <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function () {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script> <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; media-src 'self' https:; frame-src 'self' https:; connect-src 'self' https:; worker-src 'self';"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?v=a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?v=f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?v=62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?v=591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?v=6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?v=d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://hxf0223.github.io/blog/2025/Cute%E5%88%9D%E6%AD%A53.1-TileMMA%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B/"> <script src="/assets/js/theme.js?v=5fea5159b787642c1bbc1f334d60f883"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?v=5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Roderick</span> Huang </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="fa-solid fa-magnifying-glass"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-half-sun-moon" id="light-toggle-system"></i> <i class="fa-solid fa-moon" id="light-toggle-dark"></i> <i class="fa-solid fa-sun" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">CUTLASS-Cute åˆæ­¥(3.1)ï¼šTiledCopy ä»¥åŠ TiledMMA é…ç½®ç¤ºä¾‹</h1> <p class="post-meta"> Created on February 26, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a> Â  Â· Â  <a href="/blog/tag/cuda"> <i class="fa-solid fa-hashtag fa-sm"></i> CUDA</a> Â  Â· Â  <a href="/blog/category/cuda"> <i class="fa-solid fa-tag fa-sm"></i> CUDA</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <ul> <li><a href="https://github.com/HPC02/cuda_perf/blob/master/src/study_codes/tiled_mma_preview/cute_tiled_mma_preview.cu" rel="external nofollow noopener" target="_blank">cute_tiled_mma_preview.cu</a></li> </ul> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Configure data type.</span>
  <span class="k">using</span> <span class="n">TA</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">half_t</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">TB</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">half_t</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">TC</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">half_t</span><span class="p">;</span>

  <span class="c1">// Configure static "shared memory".</span>
  <span class="c1">// The "shared memory" is actually on host for preview purpose.</span>
  <span class="c1">// For tiled mma, the shared memory layout has to be static.</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">bM</span><span class="p">{</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TA</span><span class="p">)};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">bN</span><span class="p">{</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TB</span><span class="p">)};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">bK</span><span class="p">{</span><span class="mi">32</span><span class="p">};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">blk_M</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">bM</span><span class="o">&gt;</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">blk_N</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">bN</span><span class="o">&gt;</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">blk_K</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">bK</span><span class="o">&gt;</span><span class="p">{};</span>

  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_shape_A</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_shape</span><span class="p">(</span><span class="n">blk_M</span><span class="p">,</span> <span class="n">blk_K</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_shape_B</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_shape</span><span class="p">(</span><span class="n">blk_N</span><span class="p">,</span> <span class="n">blk_K</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_shape_C</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_shape</span><span class="p">(</span><span class="n">blk_M</span><span class="p">,</span> <span class="n">blk_N</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_stride_A</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_stride</span><span class="p">(</span><span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">blk_M</span><span class="p">)};</span>        <span class="c1">// Column-major</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_stride_B</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_stride</span><span class="p">(</span><span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">blk_N</span><span class="p">)};</span>        <span class="c1">// Column-major</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_stride_C</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_stride</span><span class="p">(</span><span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">blk_M</span><span class="p">)};</span>        <span class="c1">// Column-major</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_layout_A</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_layout</span><span class="p">(</span><span class="n">smem_shape_A</span><span class="p">,</span> <span class="n">smem_stride_A</span><span class="p">)};</span>  <span class="c1">// (blk_M, blk_K)</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_layout_B</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_layout</span><span class="p">(</span><span class="n">smem_shape_B</span><span class="p">,</span> <span class="n">smem_stride_B</span><span class="p">)};</span>  <span class="c1">// (blk_N, blk_K)</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">smem_layout_C</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_layout</span><span class="p">(</span><span class="n">smem_shape_C</span><span class="p">,</span> <span class="n">smem_stride_C</span><span class="p">)};</span>  <span class="c1">// (blk_M, blk_N)</span>

  <span class="k">auto</span> <span class="k">const</span> <span class="n">size_a</span><span class="p">{</span><span class="n">blk_M</span> <span class="o">*</span> <span class="n">blk_K</span><span class="p">};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">size_b</span><span class="p">{</span><span class="n">blk_N</span> <span class="o">*</span> <span class="n">blk_K</span><span class="p">};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">size_c</span><span class="p">{</span><span class="n">blk_M</span> <span class="o">*</span> <span class="n">blk_N</span><span class="p">};</span>

  <span class="k">auto</span> <span class="n">h_A</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">::</span><span class="n">host_vector</span><span class="o">&lt;</span><span class="n">TA</span><span class="o">&gt;</span><span class="p">(</span><span class="n">size_a</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">h_B</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">::</span><span class="n">host_vector</span><span class="o">&lt;</span><span class="n">TB</span><span class="o">&gt;</span><span class="p">(</span><span class="n">size_b</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">h_C</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">::</span><span class="n">host_vector</span><span class="o">&lt;</span><span class="n">TC</span><span class="o">&gt;</span><span class="p">(</span><span class="n">size_c</span><span class="p">);</span>

  <span class="c1">// Make tensor for smem_A and smem_B.</span>
  <span class="k">auto</span> <span class="n">smem_tensor_A</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tensor</span><span class="p">(</span><span class="n">h_A</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">smem_layout_A</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">smem_tensor_B</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tensor</span><span class="p">(</span><span class="n">h_B</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">smem_layout_B</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">smem_tensor_C</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tensor</span><span class="p">(</span><span class="n">h_C</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">smem_layout_C</span><span class="p">)};</span>
</code></pre></div></div> <h2 id="1-mma_atom-ä»¥åŠ-tiledmma-é…ç½®">1. MMA_Atom ä»¥åŠ TiledMMA é…ç½®</h2> <p>ä½äº SMEM ä¸­çš„ tile å¤§å°ä¸º $M \times N \times K = 128 \times 128 \times 32$ï¼Œå…¶ä¸­ï¼š</p> <ul> <li>A çŸ©é˜µä¸º $M \times K = 128 \times 32$ï¼Œrow-major layoutï¼›</li> <li>B çŸ©é˜µä¸º $K \times N = 32 \times 128$ï¼Œcolumn-major layoutï¼›</li> <li>C çŸ©é˜µä¸º $M \times N = 128 \times 128$ã€‚</li> </ul> <h3 id="11-mma_atom-é…ç½®">1.1. MMA_Atom é…ç½®</h3> <p>MMA_Atom ä½¿ç”¨çš„é…ç½®ä¸º <strong>cute::SM80_16x8x16_F16F16F16F16_TN</strong>ï¼Œä½¿ç”¨ä¸€ä¸ª warpï¼Œå³ 32 ä¸ªçº¿ç¨‹å¤„ç†è¿™ä¸ª MMA Atomã€‚å¤„ç†çš„ MNK è§„æ¨¡ä¸ºï¼š$Mâ€™ \times Nâ€™ \times Kâ€™ = 16 \times 8 \times 16$ï¼Œå…¶ä¸­ï¼š</p> <ul> <li>A sub-tile ä¸º $Mâ€™ \times Kâ€™ = 16 \times 16$ï¼›</li> <li>B sub-tile ä¸º $Kâ€™ \times Nâ€™ = 16 \times 8$ï¼›</li> <li>C sub-tile ä¸º $Mâ€™ \times Nâ€™ = 16 \times 8$ã€‚</li> </ul> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mma_atom
MMA_Atom
  ThrID:      _32:_1
  Shape_MNK:  (_16,_8,_16)
  LayoutA_TV: ((_4,_8),(_2,_2,_2)):((_32,_1),(_16,_8,_128))
  LayoutB_TV: ((_4,_8),(_2,_2)):((_16,_1),(_8,_64))
  LayoutC_TV: ((_4,_8),(_2,_2)):((_32,_1),(_16,_8))
</code></pre></div></div> <p>åˆ†é…åˆ°çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•°é‡ä¸ºï¼šA çŸ©é˜µä¸º <strong>2 x 2 x 2 = 8</strong> ä¸ªå…ƒç´ ï¼ŒB çŸ©é˜µä¸º <strong>2 x 2 = 4</strong> ä¸ªå…ƒç´ ï¼Œå¾—åˆ° C çŸ©é˜µä¸­ <strong>2 x 2 = 4</strong> ä¸ªå…ƒç´ ã€‚</p> <blockquote> <p>ğŸ“Œ çº¿ç¨‹æ•°è®¡ç®—ï¼š$ThrNum_{A} = 16 \times 16 \div 8 = 32$ï¼Œ$ThrNum_{B} = 16 \times 8 \div 4 = 32$ï¼Œ$ThrNum_{C} = 16 \times 8 \div 4 = 32$ã€‚</p> </blockquote> <p><img src="/assets/images/cuda/20250226/tiled_mma_example/mma_atom_SM80_16x8x16_F16F16F16F16_TN.svg" alt="inverse_tv_layout_SM80_16x8x16_F16F16F16F16_TN"></p> <h3 id="12-tiled-mma-é…ç½®">1.2. Tiled MMA é…ç½®</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">// Configure tiled MMA.</span>
  <span class="k">using</span> <span class="n">MmaTraits</span>           <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">MMA_Traits</span><span class="o">&lt;</span><span class="n">cute</span><span class="o">::</span><span class="n">SM80_16x8x16_F16F16F16F16_TN</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">MmaAtomShape</span>        <span class="o">=</span> <span class="n">MmaTraits</span><span class="o">::</span><span class="n">Shape_MNK</span><span class="p">;</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">mma_atom</span>       <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">MMA_Atom</span><span class="o">&lt;</span><span class="n">MmaTraits</span><span class="o">&gt;</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="k">const</span> <span class="n">mma_atom_shape</span> <span class="o">=</span> <span class="n">MmaAtomShape</span><span class="p">{};</span>
  <span class="c1">// Repeating the mma atom along the M, N, and K dimensions.</span>
  <span class="c1">// This increases the number of threads to process the tiled MMA.</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_LAYOUT_M</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_LAYOUT_N</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_LAYOUT_K</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">mma_layout</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_layout</span><span class="p">(</span>
    <span class="n">cute</span><span class="o">::</span><span class="n">make_shape</span><span class="p">(</span><span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_LAYOUT_M</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_LAYOUT_N</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_LAYOUT_K</span><span class="o">&gt;</span><span class="p">{}))};</span>
  <span class="c1">// Repeating the mma processing along the M, N, and K dimensions.</span>
  <span class="c1">// This does not increase the number of threads to process the tiled MMA.</span>
  <span class="c1">// But the number of registers required for processing the tiled MMA increases.</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">NUM_MMA_TILE_M</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">NUM_MMA_TILE_N</span><span class="p">{</span><span class="mi">2</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">NUM_MMA_TILE_K</span><span class="p">{</span><span class="mi">1</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_TILE_M</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mma_atom_shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">MMA_LAYOUT_M</span> <span class="o">*</span> <span class="n">NUM_MMA_TILE_M</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_TILE_N</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mma_atom_shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">MMA_LAYOUT_N</span> <span class="o">*</span> <span class="n">NUM_MMA_TILE_N</span><span class="p">};</span>
  <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">MMA_TILE_K</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">get</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mma_atom_shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">MMA_LAYOUT_K</span> <span class="o">*</span> <span class="n">NUM_MMA_TILE_K</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">mma_tile</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tile</span><span class="p">(</span><span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_TILE_M</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_TILE_N</span><span class="o">&gt;</span><span class="p">{},</span> <span class="n">cute</span><span class="o">::</span><span class="n">Int</span><span class="o">&lt;</span><span class="n">MMA_TILE_K</span><span class="o">&gt;</span><span class="p">{})};</span>
  <span class="k">auto</span> <span class="n">tiled_mma</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tiled_mma</span><span class="p">(</span><span class="n">mma_atom</span><span class="p">,</span> <span class="n">mma_layout</span><span class="p">,</span> <span class="n">mma_tile</span><span class="p">)};</span>
</code></pre></div></div> <p>åœ¨ M ç»´åº¦ä¸Šï¼ŒMMA Atom é‡å¤ 2 æ¬¡ï¼Œåœ¨ N ç»´åº¦ä¸Šé‡å¤ 2 æ¬¡ï¼Œåœ¨ K ç»´åº¦ä¸Šé‡å¤ 1 æ¬¡ã€‚ä¸€å…±éœ€è¦ 2 x 2 x 1 = 4 ä¸ª MMA Atom æ¥å¤„ç†è¿™ä¸ª tiled MMAã€‚æ¯ä¸ª Atom ç”±ä¸€ä¸ª warpï¼ˆ32 ä¸ªçº¿ç¨‹ï¼‰å¤„ç†ï¼Œæ•´ä¸ª tiled MMA ç”± 4 ä¸ª warpï¼ˆ128 ä¸ªçº¿ç¨‹ï¼‰å¤„ç†ã€‚å³ <strong>ThrLayoutVMNK = (_32, _2, _2, _1):(_1, _32, _64, _0)</strong>ã€‚ç»è¿‡æ­¤é…ç½®åï¼Œèƒ½å¤„ç†çš„ MNK è§„æ¨¡ä¸º $(Mâ€™ \times 2) \times (Nâ€™ \times 2) \times (Kâ€™ \times 1) = 32 \times 16 \times 16$ã€‚</p> <p>å¦å¤–ï¼Œé€šè¿‡é…ç½® PermutationMNKï¼ˆå¯¹åº”ä»¥å‰ç‰ˆæœ¬çš„ ValLayoutMNKï¼‰ï¼Œä½¿å¾—ä¸€ä¸ª tiled MMA åœ¨ M/N/K æ–¹å‘ä¸Šå¤„ç†æ›´å¤šçš„å…ƒç´ ï¼ˆå³ä¸€ä¸ªçº¿ç¨‹å¤„ç†æ›´å¤šçš„å…ƒç´ ï¼‰ã€‚è¿™é‡Œé…ç½® N ç»´åº¦ä¸Šä¹˜ä»¥ 2ï¼Œå¾—åˆ°è¯¥ tiled MMA å¤„ç†çš„ MNK è§„æ¨¡ä¸º $32 \times 32 \times 16$ï¼Œå³ <strong>PermutationMNK: (_32, _32, _16)</strong>ã€‚</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tiled_mma
TiledMMA
  ThrLayoutVMNK:  (_32,_2,_2,_1):(_1,_32,_64,_0)
  PermutationMNK: (_32,_32,_16)
MMA_Atom
  ThrID:      _32:_1
  Shape_MNK:  (_16,_8,_16)
  LayoutA_TV: ((_4,_8),(_2,_2,_2)):((_32,_1),(_16,_8,_128))
  LayoutB_TV: ((_4,_8),(_2,_2)):((_16,_1),(_8,_64))
  LayoutC_TV: ((_4,_8),(_2,_2)):((_32,_1),(_16,_8))
</code></pre></div></div> <p><img src="/assets/images/cuda/20250226/tiled_mma_example/tiled_mma_SM80_16x8x16_F16F16F16F16_TN.svg" alt="tile_mma_SM80_16x8x16_F16F16F16F16_TN"></p> <h3 id="13-tiled-mma-åˆ’åˆ†æ€»ç»“">1.3. Tiled MMA åˆ’åˆ†æ€»ç»“</h3> <p>ä»¥$M \times N \times K = 128 \times 128 \times 32$ï¼Œä»¥åŠ MMA Atom <strong>SM80_16x8x16_F16F16F16F16_TN</strong> ä¸ºä¾‹ï¼ŒMNK ä¸‰ä¸ªç»´åº¦åˆ†å—åˆ’åˆ†ï¼ˆè®¡ç®—å…¬å¼ï¼‰ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹å‡ ç§ï¼š</p> <ul> <li>$\frac{M}{Mâ€™} \times \frac{N}{Nâ€™} \times \frac{K}{Kâ€™}$ = $\frac{128}{16} \times \frac{128}{8} \times \frac{32}{16}$ = $8 \times 16 \times 2$ = $256$ï¼Œå³ MMA Atom åœ¨ M ç»´åº¦é‡å¤ 8 æ¬¡ï¼ŒN ç»´åº¦ é‡å¤16 æ¬¡ï¼ŒK ç»´åº¦é‡å¤ 2 æ¬¡ã€‚Atom æ€»å…±éœ€è¦å¾ªç¯ <strong>256</strong> æ¬¡ã€‚</li> <li>$\frac{M}{Mâ€™ \times MMA_LAYOUT_M} \times \frac{N}{Nâ€™ \times MMA_LAYOUT_N} \times \frac{K}{Kâ€™ \times MMA_LAYOUT_K}$ = $\frac{128}{16 \times 2} \times \frac{128}{8 \times 2} \times \frac{32}{16 \times 1}$ = $4 \times 8 \times 2$ = $64$ï¼Œå³ tiled MMA åœ¨ M ç»´åº¦é‡å¤ 2 æ¬¡ï¼ŒN ç»´åº¦é‡å¤ 2 æ¬¡ï¼ŒK ç»´åº¦é‡å¤ 1 æ¬¡ã€‚Atom æ€»å…±éœ€è¦å¾ªç¯ <strong>64</strong> æ¬¡ã€‚</li> <li>å…¶ä»–é…ç½®æ–¹å¼ï¼Œç±»ä¼¼ä¸Šé¢ä¸¤ç§è®¡ç®—æ–¹å¼ã€‚</li> </ul> <p>ä¸€ä¸ª thread block å¦‚ä½•åˆ’åˆ†ä¸€ä¸ª tiled MMAï¼Œä»æ€§èƒ½ä¸Šéœ€è¦ç»¼åˆè€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š</p> <ul> <li>SM ä¸Šå¯ç”¨çš„å¯„å­˜å™¨æ•°é‡ï¼Œæ¥ç¡®å®šä¸€ä¸ª thread block ä¸­å¯ä»¥æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ª tiled MMAã€‚æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•°é‡è¶Šå¤šï¼Œéœ€è¦çš„å¯„å­˜å™¨æ•°é‡å°±è¶Šå¤šã€‚</li> <li>åœ¨å¯„å­˜å™¨å¤Ÿç”¨çš„æƒ…å†µä¸‹ï¼Œå°½é‡è®©ä¸€ä¸ª thread block ä¸­çš„çº¿ç¨‹æ•°é‡èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ SM ä¸Šçš„è®¡ç®—èµ„æºï¼ˆå³ CUDA Coreã€Tensor Coreï¼‰ã€‚æ¯ä¸ª tiled MMA éœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œå–å†³äº MMA Atom çš„é…ç½®ä»¥åŠ tiled MMA çš„é…ç½®ã€‚</li> </ul> <h2 id="2-å†…å­˜åˆ†å—ä»¥åŠ-tiledcopy">2. å†…å­˜åˆ†å—ä»¥åŠ TiledCopy</h2> <p>åœ¨å°† thread block å¯¹åº”çš„ tile å†…å­˜å†æ¬¡åˆ†è§£ä¸ºçº¿ç¨‹ sub-tile è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ CuTe åˆ†å—ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š</p> <ul> <li>ä½¿ç”¨ partition åˆ†å—ï¼Œå¾—åˆ° SMEM / GMEM sliceã€‚</li> <li>ä½¿ç”¨ partition_fragment åˆ†å—ï¼Œå¾—åˆ°å¯„å­˜å™¨ç‰‡æ®µï¼ˆregister fragmentï¼‰ã€‚</li> <li>ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“ã€‚</li> </ul> <h3 id="21-ä½¿ç”¨-partitionpartition_fragment-åˆ†å—">2.1. ä½¿ç”¨ partitionã€partition_fragment åˆ†å—</h3> <p><strong>partition_A/B/C</strong></p> <p>ä½¿ç”¨ partition æ–¹æ³•ï¼Œè·å–åŸå§‹ layout çš„åˆ†å—ï¼Œå³ç”Ÿæˆä¸€ä¸ª sliceã€‚åˆ†å—ä¹‹åï¼Œæ•°æ®è¿˜æ˜¯åœ¨ SMEM / GMEM ä¸­ï¼Œä¸”ä¿ç•™äº†åŸæœ‰çš„ tile çš„ stride ä¿¡æ¯ã€‚</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">auto</span> <span class="n">thread_mma</span><span class="p">{</span><span class="n">tiled_mma</span><span class="p">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">THREAD_IDX</span><span class="p">)};</span>

  <span class="k">auto</span> <span class="n">thread_layout_C_smem_tensor_A_no_tiled_copy</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_A</span><span class="p">(</span><span class="n">smem_tensor_A</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_M, MMA_K)</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_smem_tensor_B_no_tiled_copy</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_B</span><span class="p">(</span><span class="n">smem_tensor_B</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_N, MMA_K)</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_smem_tensor_C_no_tiled_copy</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_C</span><span class="p">(</span><span class="n">smem_tensor_C</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_M, MMA_N)</span>
</code></pre></div></div> <p>æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_layout_C_smem_tensor_A_no_tiled_copy
ptr[16b](0x5c6c073e78c0) o ((_2,_2,_2),_4,_2):((_128,_8,_1024),_32,_2048)
thread_layout_C_smem_tensor_B_no_tiled_copy
ptr[16b](0x5c6c073e98d0) o ((_2,_2),_8,_2):((_128,_1024),_16,_2048)
thread_layout_C_smem_tensor_C_no_tiled_copy
ptr[16b](0x5c6c073eb8e0) o ((_2,_2),_4,_8):((_128,_8),_32,_2048)
</code></pre></div></div> <p>å…¶ä¸­ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p> <table> <thead> <tr> <th>ç»´åº¦</th> <th>å«ä¹‰</th> </tr> </thead> <tbody> <tr> <td>MMA (ç¬¬0ç»´)</td> <td>ä¸€æ¬¡ tiled MMA è®¡ç®—ä¸­è¯¥çº¿ç¨‹è´Ÿè´£çš„å…ƒç´ </td> </tr> <tr> <td>MMA_M (ç¬¬1ç»´)</td> <td>æ²¿ M æ–¹å‘éœ€è¦å¾ªç¯çš„æ¬¡æ•°</td> </tr> <tr> <td>MMA_K (ç¬¬2ç»´)</td> <td>æ²¿ K æ–¹å‘éœ€è¦å¾ªç¯çš„æ¬¡æ•°</td> </tr> </tbody> </table> <p>å…·ä½“åˆ° A/B/C çŸ©é˜µä¸Šï¼Œå«ä¹‰å¦‚ä¸‹ï¼š</p> <table> <thead> <tr> <th>çŸ©é˜µ</th> <th>shape</th> <th>è§£é‡Š</th> </tr> </thead> <tbody> <tr> <td>A</td> <td>((_2,_2,_2), _4, _2)</td> <td>MMA=8ä¸ªå…ƒç´ , Må¾ªç¯4æ¬¡, Kå¾ªç¯2æ¬¡</td> </tr> <tr> <td>B</td> <td>((_2,_2), _8, _2)</td> <td>MMA=4ä¸ªå…ƒç´ , Nå¾ªç¯8æ¬¡, Kå¾ªç¯2æ¬¡</td> </tr> <tr> <td>C</td> <td>((_2,_2), _4, _8)</td> <td>MMA=4ä¸ªå…ƒç´ , Må¾ªç¯4æ¬¡, Nå¾ªç¯8æ¬¡</td> </tr> </tbody> </table> <p>æŒ‰çº¿ç¨‹åˆ‡åˆ†ä¹‹åï¼Œä¿ç•™çš„ç¬¬ä¸€ä¸ª modeï¼Œå¦å¤–ä¸¤ä¸ª mode å«ä¹‰æ˜¯ï¼ˆä»¥ A ä¸ºä¾‹ï¼‰ï¼ŒMMA Atom æŒ‰ M ç»´åº¦å¾ªç¯ 4 æ¬¡ï¼ŒK ç»´åº¦å¾ªç¯ 2 æ¬¡ã€‚å¯¹äº B/C çŸ©é˜µç±»ä¼¼ã€‚</p> <blockquote> <p>ğŸ“Œ å¾ªç¯æ¬¡æ•°è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š</p> <ul> <li>SMEM tileï¼šM * N * K = 128 * 128 * 32ã€‚</li> <li>tiled_mmaï¼šMâ€™ * Nâ€™ * Kâ€™ = 32 * 32 * 16ã€‚</li> </ul> <p>å¾—åˆ°è®¡ç®—å…¬å¼ï¼š</p> <ul> <li>MMA_M = 128 / 32 = 4</li> <li>MMA_N = 128 / 32 * 2 = 8 (ç”±äºé…ç½®äº† permutationï¼Œä½¿å¾— tiled MMA åœ¨ N ç»´åº¦ä¸Šå¤„ç†æ›´å¤šçš„å…ƒç´ ï¼Œæ‰€ä»¥å¾ªç¯æ¬¡æ•°å¢åŠ äº†)</li> <li>MMA_K = 32 / 16 = 2</li> </ul> <p>ğŸ’¡ ä»æ‰“å°ä¿¡æ¯çœ‹å‡ºï¼Œä¸è®ºæ˜¯ç›´æ¥ä½¿ç”¨ <strong>thread_layout_C_smem_tensor_A/B_no_tiled_copy</strong>ï¼Œè¿˜æ˜¯å°†å…¶æ‹·è´åˆ°å¯„å­˜å™¨ï¼Œç”±äºä¸è¿ç»­ï¼Œå¯¼è‡´çº¿ç¨‹æ¯æ¬¡è®¿é—® 2 * 2 * 2 = 8 ä¸ªå…ƒç´ æ—¶ï¼Œéœ€è¦åˆ†å¼€æ‹·è´ï¼Œå³åˆ† 8 æ¬¡è®¿é—® SMEM / GMEM æ¥åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ä¸­ã€‚</p> </blockquote> <p><strong>partition_fragment_A/B/C</strong></p> <p>partition_fragment åˆ™åˆ›å»ºå¯„å­˜å™¨ç‰‡æ®µï¼ˆregister fragmentï¼‰ï¼Œä»¥å¤ç”¨å¯„å­˜å™¨æ•°æ®ã€‚åˆ†å—ä¹‹åï¼Œæ•°æ®åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸”ä¸ä¿ç•™åŸæœ‰ tile çš„ stride ä¿¡æ¯ï¼Œè€Œæ˜¯å˜ä¸ºç´§å‡‘å‹å¸ƒå±€ã€‚çº¿ç¨‹åœ¨åš gemm ä¹‹å‰ï¼Œä½¿ç”¨ copy å°†æ•°æ®ä» SMEM ä¸­åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">auto</span> <span class="n">thread_layout_C_register_tensor_A</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_fragment_A</span><span class="p">(</span><span class="n">smem_tensor_A</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_M, MMA_K)</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_register_tensor_B</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_fragment_B</span><span class="p">(</span><span class="n">smem_tensor_B</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_N, MMA_K)</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_register_tensor_C</span><span class="p">{</span><span class="n">thread_mma</span><span class="p">.</span><span class="n">partition_fragment_C</span><span class="p">(</span><span class="n">smem_tensor_C</span><span class="p">)};</span>  <span class="c1">// (MMA, MMA_M, MMA_N)</span>
</code></pre></div></div> <p>æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_layout_C_register_tensor_A
ptr[16b](0x7ffc34e465f0) o ((_2,_2,_2),_4,_2):((_1,_2,_4),_8,_32)
thread_layout_C_register_tensor_B
ptr[16b](0x7ffc34e46670) o ((_2,_2),_8,_2):((_1,_2),_4,_32)
thread_layout_C_register_tensor_C
ptr[16b](0x7ffc34e466f0) o ((_2,_2),_4,_8):((_1,_2),_4,_16)
</code></pre></div></div> <p><strong>æ€»ç»“</strong></p> <p>ä½¿ç”¨ partition / partition_fragment åˆ†å—ï¼Œåˆ†å—æ•°æ®å¯èƒ½ä¸è¿ç»­ï¼Œå¯¼è‡´éœ€è¦å¤šæ¬¡è®¿é—® SMEM / GMEMã€‚ä½¿ç”¨åˆé€‚çš„ ldmatrix å¯ä»¥ä¸€æ¬¡å°†ä¸€æ¬¡è®¡ç®—æ‰€éœ€è¦çš„ sub-tile æ•°æ®æ‹·è´åˆ°å¯„å­˜å™¨ã€‚</p> <h3 id="22-ä½¿ç”¨-tiledcopy--ldmatrix-è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“">2.2. ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“</h3> <p>å‰é¢ä½¿ç”¨çš„ partition / partition_fragment æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨ TiledMMA/ThrMMA åˆ†å—å¾—åˆ°çš„ã€‚ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“ã€‚è®¾ç½® TiledCopy éœ€è¦çš„ Copy_Atomã€CopyTraitsï¼ˆlayout ä¿¡æ¯ï¼‰ï¼Œå¹¶ä½¿å…¶ä¼ è¾“çš„ sub-tile å¤§å°ä¸ tiled MMA çš„è®¡ç®—éœ€æ±‚ä¸€è‡´ã€‚</p> <h4 id="221-copy-atom-é…ç½®">2.2.1. Copy Atom é…ç½®</h4> <p>é’ˆå¯¹ Aã€Bï¼Œä½¿ç”¨ <strong>cute::SM75_U16x8_LDSM_T</strong> ç”Ÿæˆ Copy Atom æ¥å¤åˆ¶ Aã€B çš„ sub-tileï¼Œå…¶å¯¹åº”çš„ PTX ä¸ºï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ldmatrix</span><span class="p">.</span><span class="n">sync</span><span class="p">.</span><span class="n">aligned</span><span class="p">.</span><span class="n">m8n8</span><span class="p">.</span><span class="n">x4</span><span class="p">.</span><span class="n">trans</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">b16</span> <span class="p">{</span><span class="n">r0</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">},</span> <span class="p">[</span><span class="n">addr</span><span class="p">];</span>
</code></pre></div></div> <p>å³ä½¿ç”¨ä¸€ä¸ª warpï¼ˆ32 ä¸ªçº¿ç¨‹ï¼‰åŒæ—¶åŠ è½½ä¸€ä¸ª sub-tile çš„æ•°æ®åˆ°å¯„å­˜å™¨ä¸­ã€‚</p> <blockquote> <p>ldmatrix åªæ”¯æŒ16ä½æ•°æ®ï¼Œä¸æ”¯æŒ32ä½æ•°æ®ï¼›å¦å¤– ldmatrix æ˜¯ PTX æŒ‡ä»¤ï¼Œå¯¹åº”åˆ° ncu ä¸­çœ‹åˆ°çš„ LDSM æŒ‡ä»¤ã€‚x1 è¡¨ç¤ºä½¿ç”¨å‰ 8 ä¸ªçº¿ç¨‹ï¼Œx2ã€x4 ä¾æ¬¡ç±»æ¨ã€‚m8n8 è¡¨ç¤º load æ“ä½œçš„å­å—å¤§å°ä¸º 8x8ï¼Œx4 åˆ™è¡¨ç¤ºåŒæ—¶åŠ è½½ 4 ä¸ªå­å—ã€‚</p> </blockquote> <p><strong>cute::SM75_U16x8_LDSM_T</strong> æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy_atom_A
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b

copy_atom_B
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b
</code></pre></div></div> <p>åœ¨å‰é¢ TiledMMA çš„é…ç½®ä¸­ï¼Œç»è¿‡ AtomLayout ä»¥åŠ Permutationï¼Œæœ€ç»ˆå¾—åˆ°çš„ tiled MMA å¤„ç†çš„ sub-tile å¤§å°ä¸º $Mâ€™ \times Nâ€™ \times Kâ€™ = 32 \times 32 \times 16$ã€‚å…¶ä¸­ A çŸ©é˜µçš„ sub-tile å¤§å°ä¸º $Mâ€™ \times Kâ€™ = 32 \times 16$ï¼ŒB çŸ©é˜µçš„ sub-tile å¤§å°ä¸º $Kâ€™ \times Nâ€™ = 16 \times 32$ã€‚</p> <p>ä½¿ç”¨<strong>SM75_U16x8_LDSM_T</strong>ï¼Œå…¶ä¸€æ¬¡æ‹·è´çš„ sub-tile å¤§å°ä¸º $32 \times 8 = 256$ï¼Œå³å¯¹åº”ä¸Šé¢æ‰“å°ä¿¡æ¯ä¸­çš„ <strong>ValLayoutSrc: (_32, _8):(_8, _1)</strong>ã€‚å› æ­¤ï¼ŒTiledCopy çš„ Copy Atom é…ç½®æ»¡è¶³ä¸€æ¬¡åŠ è½½ æ‰§è¡Œä¸€ä¸ª Tiled MMA æ‰€éœ€è¦çš„æ•°æ®ã€‚</p> <p>å¦å¤–ï¼Œåœ¨ Tiled MMA é…ç½®ä¸­ï¼ŒB é…ç½®äº† permutationï¼Œä½¿å¾— B çŸ©é˜µçš„ sub-tile å¤§å°ä¸ A çŸ©é˜µå¤§å°ä¸€è‡´ï¼Œå¦åˆ™é’ˆå¯¹ Bï¼Œå°±éœ€è¦é€‰æ‹©å…¶ä»–çš„ Copy Atom æ¥æ»¡è¶³ tiled MMA çš„è®¡ç®—éœ€æ±‚ã€‚</p> <h4 id="222-tiledcopy-ä»¥åŠ-threadcopy-åˆ›å»º">2.2.2. TiledCopy ä»¥åŠ ThreadCopy åˆ›å»º</h4> <p>åˆ›å»º TiledCopyï¼ŒCopy_Atom é…ç½®å¦‚ä¸Š<strong>SM75_U16x8_LDSM_T</strong>ï¼ŒTV-Layout åˆ™ç”±ä¸Šè¿°çš„ Tiled MMA ç»™å‡ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">auto</span> <span class="n">copy_atom_A</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">Copy_Atom</span><span class="o">&lt;</span><span class="n">cute</span><span class="o">::</span><span class="n">SM75_U16x8_LDSM_T</span><span class="p">,</span> <span class="n">TA</span><span class="o">&gt;</span><span class="p">{};</span>
  <span class="k">auto</span> <span class="n">copy_atom_B</span> <span class="o">=</span> <span class="n">cute</span><span class="o">::</span><span class="n">Copy_Atom</span><span class="o">&lt;</span><span class="n">cute</span><span class="o">::</span><span class="n">SM75_U16x8_LDSM_T</span><span class="p">,</span> <span class="n">TB</span><span class="o">&gt;</span><span class="p">{};</span>

  <span class="k">auto</span> <span class="n">smem_tiled_copy_A</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tiled_copy_A</span><span class="p">(</span><span class="n">copy_atom_A</span><span class="p">,</span> <span class="n">tiled_mma</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">smem_tiled_copy_B</span><span class="p">{</span><span class="n">cute</span><span class="o">::</span><span class="n">make_tiled_copy_B</span><span class="p">(</span><span class="n">copy_atom_B</span><span class="p">,</span> <span class="n">tiled_mma</span><span class="p">)};</span>
</code></pre></div></div> <p>Tiled Copy ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smem_tiled_copy_A
TiledCopy
  Tiler_MN:       (_32,_16)
  TiledLayout_TV: ((_4,_8,_2,_2),((_2,_2,_2),(_1,_1))):((_64,_1,_16,_0),((_32,_8,_256),(_0,_0)))
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b

smem_tiled_copy_B
TiledCopy
  Tiler_MN:       (_32,_16)
  TiledLayout_TV: ((_4,_8,_2,_2),((_2,_2),(_2,_1))):((_64,_1,_0,_8),((_32,_256),(_16,_0)))
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b
</code></pre></div></div> <p><strong>ä½¿ç”¨ Thread Copy ä»¥åŠåˆ›å»ºæœ¬çº¿ç¨‹ sub-tile</strong></p> <p>åˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆä½¿ç”¨ <strong>ThrCopy&lt;â€¦&gt;::partition_S</strong> è·å–çº¿ç¨‹çš„ tensorï¼Œå†ä½¿ç”¨ <strong>ThrCopy&lt;â€¦&gt;::retile_D</strong> è·å–è°ƒæ•´ shape ä¹‹åçš„ tensorã€‚ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">auto</span> <span class="n">smem_thread_copy_A</span><span class="p">{</span><span class="n">smem_tiled_copy_A</span><span class="p">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">THREAD_IDX</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">smem_thread_copy_B</span><span class="p">{</span><span class="n">smem_tiled_copy_B</span><span class="p">.</span><span class="n">get_slice</span><span class="p">(</span><span class="n">THREAD_IDX</span><span class="p">)};</span>

  <span class="k">auto</span> <span class="n">thread_layout_C_smem_tensor_A_tiled_copy</span><span class="p">{</span><span class="n">smem_thread_copy_A</span><span class="p">.</span><span class="n">partition_S</span><span class="p">(</span><span class="n">smem_tensor_A</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_smem_tensor_B_tiled_copy</span><span class="p">{</span><span class="n">smem_thread_copy_B</span><span class="p">.</span><span class="n">partition_S</span><span class="p">(</span><span class="n">smem_tensor_B</span><span class="p">)};</span>

  <span class="k">auto</span> <span class="n">thread_layout_C_register_tensor_A_copy_view</span><span class="p">{</span><span class="n">smem_thread_copy_A</span><span class="p">.</span><span class="n">retile_D</span><span class="p">(</span><span class="n">thread_layout_C_register_tensor_A</span><span class="p">)};</span>
  <span class="k">auto</span> <span class="n">thread_layout_C_register_tensor_B_copy_view</span><span class="p">{</span><span class="n">smem_thread_copy_B</span><span class="p">.</span><span class="n">retile_D</span><span class="p">(</span><span class="n">thread_layout_C_register_tensor_B</span><span class="p">)};</span>
</code></pre></div></div> <p><strong>thread_layout_C_smem_tensor_A/B_tiled_copy</strong> ä½œä¸ºæº tensorï¼Œä»–ä»¬çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_layout_C_smem_tensor_A_tiled_copy
ptr[16b](0x57b7b93248c0) o ((_8,_1),_4,_2):((_1,_0),_32,_2048)
thread_layout_C_smem_tensor_B_tiled_copy
ptr[16b](0x57b7b93268d0) o ((_8,_1),_4,_2):((_1,_0),_32,_2048)
</code></pre></div></div> <p>ä½œä¸ºç›®çš„ tensor çš„ <strong>thread_layout_C_register_tensor_A/B</strong>ï¼ˆç”± <strong>ThrMMA&lt;â€¦&gt;::partition_fragment_A/B</strong> è·å–ï¼‰ï¼Œå…¶ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_layout_C_register_tensor_A
ptr[16b](0x7ffc34e465f0) o ((_2,_2,_2),_4,_2):((_1,_2,_4),_8,_32)
thread_layout_C_register_tensor_B
ptr[16b](0x7ffc34e46670) o ((_2,_2),_8,_2):((_1,_2),_4,_32)
</code></pre></div></div> <p>æ‰€ä»¥éœ€è¦å¯¹ç›®çš„ tensor è¿›è¡Œè°ƒæ•´ï¼Œä½¿å¾—å…¶ shape ä¸æº tensor ä¸€è‡´ã€‚è°ƒæ•´ä¹‹åçš„ç›®çš„ tensor <strong>thread_layout_C_register_tensor_A/B_copy_view</strong> çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thread_layout_C_register_tensor_A_copy_view
ptr[16b](0x7ffd7a129350) o ((_8,_1),_4,_2):((_1,_0),_8,_32)
thread_layout_C_register_tensor_B_copy_view
ptr[16b](0x7ffd7a1293d0) o ((_8,_1),_4,_2):((_1,_0),_8,_32)
</code></pre></div></div> <h3 id="23-æ€»ç»“">2.3. æ€»ç»“</h3> <p>ä½¿ç”¨ partition / partition_fragment åˆ†å—ï¼Œåˆ†å—æ•°æ®å¯èƒ½ä¸è¿ç»­ï¼Œå¯¼è‡´éœ€è¦å¤šæ¬¡è®¿é—® SMEM / GMEMã€‚ä½¿ç”¨åˆé€‚çš„ ldmatrix å¯ä»¥ä¸€æ¬¡å°†ä¸€æ¬¡è®¡ç®—æ‰€éœ€è¦çš„ sub-tile æ•°æ®æ‹·è´åˆ°å¯„å­˜å™¨ã€‚</p> <p>ä½¿ç”¨ TiledCopy / ldmatrix çš„æµç¨‹æ˜¯ï¼š</p> <ul> <li>é…ç½® Copy Atom / Copy Traitsï¼Œä½¿å¾—ä¸€æ¬¡ tiled copy çš„æ•°æ®é‡æ»¡è¶³ä¸€æ¬¡ tiled MMA è®¡ç®—çš„éœ€æ±‚ã€‚</li> <li>åˆ›å»º TiledCopyï¼Œå¹¶è·å–çº¿ç¨‹å¯¹åº”çš„ ThreadCopyã€‚</li> <li>ä½¿ç”¨ ThreadCopy çš„ partition_S è·å–çº¿ç¨‹çš„ tensorã€‚</li> <li>ä½¿ç”¨ ThreadCopy çš„ retile_D è·å–è°ƒæ•´ shape ä¹‹åçš„ tensorï¼Œä½¿å¾—å…¶ä¸ tiled copy çš„æº tensor shape ä¸€è‡´ã€‚</li> <li>ä½¿ç”¨ ThreadCopy æ‰§è¡Œ copy æ“ä½œï¼Œå°†æ•°æ®ä» SMEM ä¸­åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚</li> </ul> <p><strong>TODO</strong>ï¼šldmatrix å¯¼è‡´çš„ smem bank å†²çªï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ swizzle æ¥è§„é¿ã€‚</p> <h2 id="å‚è€ƒåŠèµ„æ–™">å‚è€ƒåŠèµ„æ–™</h2> <ul> <li> <a href="https://leimao.github.io/blog/CuTe-Tiled-MMA/" rel="external nofollow noopener" target="_blank">CuTe Tiled MMA</a>ï¼šMao Lei åšå®¢</li> <li> <a href="https://github.com/leimao/CUTLASS-Examples/tree/main/examples/cute_general_matrix_multiplication" rel="external nofollow noopener" target="_blank">CuTe General Matrix Multiplication</a>ï¼šMao Lei GitHub GEMM ä»£ç </li> <li> <a href="https://github.com/NVIDIA/cutlass/blob/main/media/docs/cpp/cute/0t_mma_atom.md" rel="external nofollow noopener" target="_blank">0t_mma_atom</a>ï¼šCUTLASS-CuTe 0t_mma_atom æ–‡æ¡£ <strong>å¾…é˜…è¯»</strong> </li> <li> <a href="https://leimao.github.io/blog/CuTe-ldmatrix/" rel="external nofollow noopener" target="_blank">CuTe ldmatrix</a>ï¼šMao Lei åšå®¢ ldmatrix <strong>å¾…é˜…è¯»</strong> </li> <li> <a href="https://zhuanlan.zhihu.com/p/697228676" rel="external nofollow noopener" target="_blank">ldmatrixæŒ‡ä»¤ä¾‹å­å’Œå…¶å¸¦æ¥çš„smem bankå†²çª</a> <strong>å¾…é˜…è¯»</strong> </li> <li> <a href="https://zhuanlan.zhihu.com/p/696231622" rel="external nofollow noopener" target="_blank">ldmatrixä¸swizzleï¼ˆç¬”è®°ï¼‰</a> <strong>å¾…é˜…è¯»</strong> </li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/al-folio-customization-summary/">al-folio æ¨¡æ¿å®šåˆ¶ä¿®æ”¹æ€»ç»“</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/al-folio-local-deploy-ubuntu2404/">al-folio æœ¬åœ°éƒ¨ç½²è®°å½•ï¼ˆUbuntu 24.04ï¼‰</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2026/C++-Traits/">C++ Traits</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95/">é“æ ¼æ‹‰æ–¯-æ™®å…‹ç®—æ³•(Douglasâ€“Peucker algorithm)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93/">CMakeæ”¯æŒåº“æ”¶é›†</a> </li> </div> </div> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> Â© Copyright 2026 Roderick Huang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?v=a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?v=85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?v=c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?v=2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?v=c15de51d4bb57887caa2c21988d97279"></script> <script defer src="/assets/js/copy_code.js?v=c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?v=d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?v=a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?v=2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?v=f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?v=a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?v=6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?v=ccc841c459bfc0e64c1c2b5acd10df02"></script> </body> </html>