<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://hxf0223.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://hxf0223.github.io/" rel="alternate" type="text/html" hreflang="zh-CN"/><updated>2026-02-28T10:26:55+00:00</updated><id>https://hxf0223.github.io/feed.xml</id><title type="html">blank</title><subtitle>Roderick Huang 的个人博客，记录工作与技术。 </subtitle><entry><title type="html">al-folio 模板定制修改总结</title><link href="https://hxf0223.github.io/blog/2026/al-folio-customization-summary/" rel="alternate" type="text/html" title="al-folio 模板定制修改总结"/><published>2026-02-28T02:00:00+00:00</published><updated>2026-02-28T02:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2026/al-folio-customization-summary</id><content type="html" xml:base="https://hxf0223.github.io/blog/2026/al-folio-customization-summary/"><![CDATA[<p>本文总结将 <a href="https://github.com/alshedivat/al-folio">al-folio</a> 模板 fork 到个人仓库后所做的全部定制修改，供后续维护参考。</p> <hr/> <h2 id="1-站点基本信息配置_configyml">1. 站点基本信息配置（_config.yml）</h2> <p>在 <code class="language-plaintext highlighter-rouge">_config.yml</code> 中修改了以下关键配置项：</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 个人信息</span>
<span class="na">first_name</span><span class="pi">:</span> <span class="s">Roderick</span>
<span class="na">middle_name</span><span class="pi">:</span>
<span class="na">last_name</span><span class="pi">:</span> <span class="s">Huang</span>
<span class="na">lang</span><span class="pi">:</span> <span class="s">zh-CN</span>
<span class="na">contact_note</span><span class="pi">:</span> <span class="pi">&gt;</span>
  <span class="s">欢迎通过 GitHub 或邮件与我联系。</span>
<span class="na">description</span><span class="pi">:</span> <span class="pi">&gt;</span>
  <span class="s">Roderick Huang 的个人博客，记录工作与技术。</span>

<span class="c1"># 站点 URL</span>
<span class="na">url</span><span class="pi">:</span> <span class="s">https://hxf0223.github.io</span>
<span class="na">baseurl</span><span class="pi">:</span> <span class="c1"># 个人站点留空</span>

<span class="c1"># 博客设置</span>
<span class="na">blog_name</span><span class="pi">:</span> <span class="s">WorkLog</span>

<span class="c1"># 页面宽度</span>
<span class="na">max_width</span><span class="pi">:</span> <span class="s">1400px</span>

<span class="c1"># Giscus 评论系统</span>
<span class="na">giscus</span><span class="pi">:</span>
  <span class="na">repo</span><span class="pi">:</span> <span class="s">hxf0223/hxf0223.github.io</span>
  <span class="na">repo_id</span><span class="pi">:</span> <span class="s">R_kgDOL6EGLA</span>
  <span class="na">category</span><span class="pi">:</span> <span class="s">General</span>
  <span class="na">category_id</span><span class="pi">:</span> <span class="s">DIC_kwDOL6EGLM4Czxtq</span>
  <span class="na">mapping</span><span class="pi">:</span> <span class="s">pathname</span>
  <span class="na">strict</span><span class="pi">:</span> <span class="m">0</span>
  <span class="na">lang</span><span class="pi">:</span> <span class="s">zh-CN</span>

<span class="c1"># Scholar</span>
<span class="na">scholar</span><span class="pi">:</span>
  <span class="na">last_name</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Huang</span><span class="pi">]</span>
  <span class="na">first_name</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Roderick</span><span class="pi">,</span> <span class="nv">R.</span><span class="pi">]</span>

<span class="c1"># 注释掉外部文章源</span>
<span class="c1"># external_sources: ...</span>
</code></pre></div></div> <p>另外在 <code class="language-plaintext highlighter-rouge">defaults</code> 中为所有文章默认启用右侧目录：</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">defaults</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">scope</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">posts</span>
    <span class="na">values</span><span class="pi">:</span>
      <span class="na">toc</span><span class="pi">:</span>
        <span class="na">sidebar</span><span class="pi">:</span> <span class="s">right</span>
</code></pre></div></div> <hr/> <h2 id="2-博客文章批量迁移">2. 博客文章批量迁移</h2> <p>将旧博客的 155 篇 Markdown 文章迁移到 <code class="language-plaintext highlighter-rouge">_posts/</code> 目录，使用 Python 脚本批量更新 frontmatter，确保格式符合 al-folio 要求：</p> <ul> <li>添加 <code class="language-plaintext highlighter-rouge">layout: post</code></li> <li>添加 <code class="language-plaintext highlighter-rouge">toc: sidebar: right</code></li> <li>保留原始 <code class="language-plaintext highlighter-rouge">title</code>、<code class="language-plaintext highlighter-rouge">date</code>、<code class="language-plaintext highlighter-rouge">categories</code>、<code class="language-plaintext highlighter-rouge">tags</code> 字段</li> </ul> <p>分两轮处理：</p> <ol> <li>第一轮处理 112 个非中文文件名的文件</li> <li>第二轮使用 <code class="language-plaintext highlighter-rouge">git -c core.quotepath=false</code> 处理 43 个中文文件名的文件</li> </ol> <hr/> <h2 id="3-tagscategories-自动显示_pagesblogmd">3. Tags/Categories 自动显示（_pages/blog.md）</h2> <h3 id="问题">问题</h3> <p>al-folio 默认使用 <code class="language-plaintext highlighter-rouge">_config.yml</code> 中的 <code class="language-plaintext highlighter-rouge">display_tags</code> 和 <code class="language-plaintext highlighter-rouge">display_categories</code> 手动列表控制博客页面的标签过滤栏。新添加文章的 tags 不会自动出现。</p> <h3 id="解决方案">解决方案</h3> <p>修改 <code class="language-plaintext highlighter-rouge">_pages/blog.md</code>，将手动列表替换为 Jekyll 自动收集的 <code class="language-plaintext highlighter-rouge">site.tags</code> 和 <code class="language-plaintext highlighter-rouge">site.categories</code>：</p> <div class="language-liquid highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">all_tags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">site</span><span class="p">.</span><span class="nv">tags</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">sort</span><span class="w"> </span><span class="cp">%}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">assign</span><span class="w"> </span><span class="nv">all_categories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">site</span><span class="p">.</span><span class="nv">categories</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">sort</span><span class="w"> </span><span class="cp">%}</span>
<span class="cp">{%</span><span class="w"> </span><span class="nt">if</span><span class="w"> </span><span class="nv">all_tags</span><span class="p">.</span><span class="nf">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="nv">all_categories</span><span class="p">.</span><span class="nf">size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="cp">%}</span>
  &lt;div class="tag-category-list"&gt;
    &lt;ul class="p-0 m-0"&gt;
      <span class="cp">{%</span><span class="w"> </span><span class="nt">for</span><span class="w"> </span><span class="nv">tag</span><span class="w"> </span><span class="nt">in</span><span class="w"> </span><span class="nv">all_tags</span><span class="w"> </span><span class="cp">%}</span>
        &lt;li&gt;
          &lt;i class="fa-solid fa-hashtag fa-sm"&gt;&lt;/i&gt;
          &lt;a href="<span class="cp">{{</span><span class="w"> </span><span class="nv">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">slugify</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">prepend</span><span class="p">:</span><span class="w"> </span><span class="s1">'/blog/tag/'</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">relative_url</span><span class="w"> </span><span class="cp">}}</span>"&gt;<span class="cp">{{</span><span class="w"> </span><span class="nv">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="cp">}}</span>&lt;/a&gt;
        &lt;/li&gt;
        <span class="cp">{%</span><span class="w"> </span><span class="nt">unless</span><span class="w"> </span><span class="nb">forloop.last</span><span class="w"> </span><span class="cp">%}</span>&lt;p&gt;&amp;bull;&lt;/p&gt;<span class="cp">{%</span><span class="w"> </span><span class="nt">endunless</span><span class="w"> </span><span class="cp">%}</span>
      <span class="cp">{%</span><span class="w"> </span><span class="nt">endfor</span><span class="w"> </span><span class="cp">%}</span>
      ...
    &lt;/ul&gt;
  &lt;/div&gt;
<span class="cp">{%</span><span class="w"> </span><span class="nt">endif</span><span class="w"> </span><span class="cp">%}</span>

</code></pre></div></div> <blockquote> <p><strong>注意：</strong> <code class="language-plaintext highlighter-rouge">site.tags</code> 是一个 hash（<code class="language-plaintext highlighter-rouge">[name, posts_array]</code>），取标签名需使用 <code class="language-plaintext highlighter-rouge">tag[0]</code>，而 <code class="language-plaintext highlighter-rouge">site.display_tags</code> 是一个字符串数组。</p> </blockquote> <hr/> <h2 id="4-pwa-支持可安装为桌面应用">4. PWA 支持（可安装为桌面应用）</h2> <h3 id="41-新增-manifestjson">4.1 新增 manifest.json</h3> <p>创建 <code class="language-plaintext highlighter-rouge">manifest.json</code>（使用 Liquid front matter 动态填充站点信息）：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Roderick Huang"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"short_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Huang"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"start_url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"display"</span><span class="p">:</span><span class="w"> </span><span class="s2">"standalone"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"background_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#ffffff"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"theme_color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#1a1a2e"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"icons"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/assets/img/pwa-icon-192.png"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"192x192"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/assets/img/pwa-icon-512.png"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"512x512"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"src"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/assets/img/pwa-icon-512.png"</span><span class="p">,</span><span class="w"> </span><span class="nl">"sizes"</span><span class="p">:</span><span class="w"> </span><span class="s2">"512x512"</span><span class="p">,</span><span class="w"> </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"image/png"</span><span class="p">,</span><span class="w"> </span><span class="nl">"purpose"</span><span class="p">:</span><span class="w"> </span><span class="s2">"maskable"</span><span class="w"> </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">id</code> 和 <code class="language-plaintext highlighter-rouge">scope</code> 是新版 Chrome/Edge 用于标识 PWA 身份和作用域的关键字段</li> <li>需要在 <code class="language-plaintext highlighter-rouge">assets/img/</code> 下提供 192x192 和 512x512 的 PNG 图标</li> </ul> <h3 id="42-新增-swjsservice-worker">4.2 新增 sw.js（Service Worker）</h3> <p>创建 <code class="language-plaintext highlighter-rouge">sw.js</code> 实现离线缓存。关键注意点：</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// install 事件：预缓存关键资源，添加容错处理</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">install</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nf">waitUntil</span><span class="p">(</span>
    <span class="nx">caches</span>
      <span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">cache</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="nx">PRECACHE_URLS</span><span class="p">).</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nf">warn</span><span class="p">(</span><span class="dl">"</span><span class="s2">Precache failed (non-fatal):</span><span class="dl">"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="p">})</span>
      <span class="p">)</span>
      <span class="p">.</span><span class="nf">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nb">self</span><span class="p">.</span><span class="nf">skipWaiting</span><span class="p">())</span>
  <span class="p">);</span>
<span class="p">});</span>

<span class="c1">// fetch 事件：必须过滤非 HTTP 协议请求</span>
<span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">fetch</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span> <span class="o">||</span> <span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">http</span><span class="dl">"</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

  <span class="nx">event</span><span class="p">.</span><span class="nf">respondWith</span><span class="p">(</span>
    <span class="nx">caches</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">).</span><span class="nf">then</span><span class="p">((</span><span class="nx">cached</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">cached</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cached</span><span class="p">;</span>
      <span class="k">return</span> <span class="nf">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">).</span><span class="nf">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">response</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">200</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">opaque</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">toCache</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nf">clone</span><span class="p">();</span>
        <span class="nx">caches</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nf">then</span><span class="p">((</span><span class="nx">cache</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="nx">cache</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">toCache</span><span class="p">).</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{});</span>
        <span class="p">});</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">})</span>
  <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div> <p><strong>踩坑记录：</strong></p> <ol> <li><code class="language-plaintext highlighter-rouge">cache.addAll()</code> 如果任何一个 URL 失败，整个 Promise 会 reject，导致 SW 安装失败 → 浏览器不显示安装按钮。必须添加 <code class="language-plaintext highlighter-rouge">.catch()</code> 容错</li> <li>Edge/Chrome 浏览器扩展的请求（<code class="language-plaintext highlighter-rouge">chrome-extension://</code>）也会被 SW 的 fetch 事件拦截，<code class="language-plaintext highlighter-rouge">cache.put()</code> 不支持非 HTTP scheme，导致 <code class="language-plaintext highlighter-rouge">Uncaught TypeError</code>。必须用 <code class="language-plaintext highlighter-rouge">url.protocol.startsWith('http')</code> 过滤</li> <li><code class="language-plaintext highlighter-rouge">cache.put()</code> 也需要 <code class="language-plaintext highlighter-rouge">.catch(() =&gt; {})</code> 兜底，防止其他异常场景</li> </ol> <h3 id="43-修改-_includesheadliquid">4.3 修改 _includes/head.liquid</h3> <p>在 <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> 中添加 manifest 引用、theme-color、SW 注册脚本和 CSP：</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- PWA manifest &amp; theme color --&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"manifest"</span> <span class="na">href=</span><span class="s">"/manifest.json"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"theme-color"</span> <span class="na">media=</span><span class="s">"(prefers-color-scheme: light)"</span> <span class="na">content=</span><span class="s">"#ffffff"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"theme-color"</span> <span class="na">media=</span><span class="s">"(prefers-color-scheme: dark)"</span> <span class="na">content=</span><span class="s">"#1a1a2e"</span> <span class="nt">/&gt;</span>

<span class="c">&lt;!-- PWA Service Worker registration --&gt;</span>
<span class="nt">&lt;script&gt;</span>
  <span class="k">if </span><span class="p">(</span><span class="dl">"</span><span class="s2">serviceWorker</span><span class="dl">"</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">window</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">load</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
      <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nf">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">/sw.js</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>

<span class="c">&lt;!-- CSP: 需要包含 worker-src 'self' --&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"Content-Security-Policy"</span> <span class="na">content=</span><span class="s">"... worker-src 'self';"</span> <span class="nt">/&gt;</span>
</code></pre></div></div> <blockquote> <p><strong>注意：</strong> CSP 必须包含 <code class="language-plaintext highlighter-rouge">worker-src 'self'</code>，否则某些浏览器版本会阻止 Service Worker 注册。</p> </blockquote> <hr/> <h2 id="5-prettier-配置">5. Prettier 配置</h2> <h3 id="prettierrc">.prettierrc</h3> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">plugins</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">@shopify/prettier-plugin-liquid"</span><span class="pi">]</span>
<span class="na">printWidth</span><span class="pi">:</span> <span class="m">150</span>
<span class="na">trailingComma</span><span class="pi">:</span> <span class="s2">"</span><span class="s">es5"</span>
<span class="na">overrides</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">files</span><span class="pi">:</span> <span class="s2">"</span><span class="s">**/*.md"</span>
    <span class="na">options</span><span class="pi">:</span>
      <span class="na">proseWrap</span><span class="pi">:</span> <span class="s2">"</span><span class="s">preserve"</span>
      <span class="na">printWidth</span><span class="pi">:</span> <span class="m">10000</span>
</code></pre></div></div> <ul> <li><code class="language-plaintext highlighter-rouge">proseWrap: "preserve"</code> 防止 prettier 重排 Markdown 段落中的换行和空行</li> <li><code class="language-plaintext highlighter-rouge">printWidth: 10000</code> 避免 Markdown 文本被强制换行</li> </ul> <h3 id="prettierignore">.prettierignore</h3> <p>额外添加的忽略项：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Ignore Jekyll Liquid-templated JSON/JS files
manifest.json
sw.js
# Ignore upstream files that conflict with prettier
CUSTOMIZE.md
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">manifest.json</code> 和 <code class="language-plaintext highlighter-rouge">sw.js</code> 包含 Jekyll Liquid front matter（<code class="language-plaintext highlighter-rouge">---</code> 头部），prettier 无法正确解析，需要忽略。</p> <hr/> <h2 id="6-cicd-修改githubworkflowsdeployyml">6. CI/CD 修改（.github/workflows/deploy.yml）</h2> <p>在部署工作流的路径过滤器中添加 <code class="language-plaintext highlighter-rouge">**.json</code>，确保 <code class="language-plaintext highlighter-rouge">manifest.json</code> 等 JSON 文件的修改能触发自动部署：</p> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">**.js"</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">**.json"</span> <span class="c1"># 新增</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">**.liquid"</span>
</code></pre></div></div> <p>另外升级了 CodeQL action 到 v4 以消除 deprecated action 警告。</p> <hr/> <h2 id="7-其他小修改">7. 其他小修改</h2> <table> <thead> <tr> <th>修改项</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>Category 大小写统一</td> <td><code class="language-plaintext highlighter-rouge">RANSAC.md</code> 中 <code class="language-plaintext highlighter-rouge">categories: [algorithm]</code> 改为 <code class="language-plaintext highlighter-rouge">[Algorithm]</code>，避免 Jekyll 路径冲突</td> </tr> <tr> <td>禁用 external_sources</td> <td>注释掉 <code class="language-plaintext highlighter-rouge">_config.yml</code> 中的 <code class="language-plaintext highlighter-rouge">external_sources</code> 配置，移除示例外部文章</td> </tr> <tr> <td>默认 toc 设置</td> <td>在 <code class="language-plaintext highlighter-rouge">_config.yml</code> 的 <code class="language-plaintext highlighter-rouge">defaults</code> 中为所有 posts 设置 <code class="language-plaintext highlighter-rouge">toc: sidebar: right</code></td> </tr> </tbody> </table> <hr/> <h2 id="提交历史参考">提交历史参考</h2> <table> <thead> <tr> <th>日期</th> <th>Commit</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">9d5407b</code></td> <td>更新个人信息和站点 URL</td> </tr> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">86b0695</code></td> <td>初始化仓库 fork 配置</td> </tr> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">59860f6</code></td> <td>迁移博客文章</td> </tr> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">3d120b6</code></td> <td>添加 PWA manifest</td> </tr> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">5d5993f</code></td> <td>添加 Service Worker 和 theme-color</td> </tr> <tr> <td>2026-02-27</td> <td><code class="language-plaintext highlighter-rouge">92c705e</code></td> <td>修复 manifest.json 尾部换行导致 JSON 无效</td> </tr> <tr> <td>2026-02-28</td> <td><code class="language-plaintext highlighter-rouge">4ad9c06</code></td> <td>完成全部文章迁移（含中文文件名）</td> </tr> <tr> <td>2026-02-28</td> <td><code class="language-plaintext highlighter-rouge">c16ac46</code></td> <td>Tags/Categories 自动显示</td> </tr> <tr> <td>2026-02-28</td> <td><code class="language-plaintext highlighter-rouge">aed979b</code></td> <td>PWA 远程修复（SW 容错、manifest scope/id、CSP worker-src）</td> </tr> <tr> <td>2026-02-28</td> <td><code class="language-plaintext highlighter-rouge">804f9b0</code></td> <td>修复 SW fetch 拦截 chrome-extension 协议的错误</td> </tr> </tbody> </table>]]></content><author><name></name></author><category term="工具"/><category term="博客"/><category term="jekyll"/><category term="al-folio"/><category term="ubuntu"/><summary type="html"><![CDATA[本文总结将 al-folio 模板 fork 到个人仓库后所做的全部定制修改，供后续维护参考。]]></summary></entry><entry><title type="html">al-folio 本地部署记录（Ubuntu 24.04）</title><link href="https://hxf0223.github.io/blog/2026/al-folio-local-deploy-ubuntu2404/" rel="alternate" type="text/html" title="al-folio 本地部署记录（Ubuntu 24.04）"/><published>2026-02-27T02:00:00+00:00</published><updated>2026-02-27T02:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2026/al-folio-local-deploy-ubuntu2404</id><content type="html" xml:base="https://hxf0223.github.io/blog/2026/al-folio-local-deploy-ubuntu2404/"><![CDATA[<p>本文记录在 Ubuntu 24.04 上从零开始本地部署 <a href="https://github.com/alshedivat/al-folio">al-folio</a> Jekyll 主题的完整流程，以及遇到的问题和解决方案。</p> <h2 id="环境说明">环境说明</h2> <ul> <li>操作系统：Ubuntu 24.04 x86_64</li> <li>Ruby 版本管理：rbenv</li> <li>目标 Ruby 版本：3.3.5</li> </ul> <hr/> <h2 id="第一步安装系统依赖">第一步：安装系统依赖</h2> <p>Ruby 编译和 Jekyll 运行需要以下系统包：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libyaml-dev libssl-dev libreadline-dev zlib1g-dev libffi-dev imagemagick nodejs
</code></pre></div></div> <blockquote> <p><strong>说明：</strong></p> <ul> <li><code class="language-plaintext highlighter-rouge">libyaml-dev</code>：编译 Ruby 3.3.x 时必须，缺少会导致 <code class="language-plaintext highlighter-rouge">psych</code> 扩展编译失败。</li> <li><code class="language-plaintext highlighter-rouge">imagemagick</code>：提供 <code class="language-plaintext highlighter-rouge">convert</code> 命令，用于生成响应式 WebP 图片。</li> <li><code class="language-plaintext highlighter-rouge">nodejs</code>：为 Terser JS 压缩插件提供运行时。</li> </ul> </blockquote> <hr/> <h2 id="第二步安装-ruby-335通过-rbenv">第二步：安装 Ruby 3.3.5（通过 rbenv）</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 安装 Ruby 3.3.5</span>
rbenv <span class="nb">install </span>3.3.5

<span class="c"># 在项目目录设置 Ruby 版本</span>
<span class="nb">cd</span> ~/work/hxf0223.github.io
rbenv <span class="nb">local </span>3.3.5

<span class="c"># 验证</span>
ruby <span class="nt">--version</span>
<span class="c"># =&gt; ruby 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux]</span>
</code></pre></div></div> <blockquote> <p><strong>注意：</strong> 必须先安装 <code class="language-plaintext highlighter-rouge">libyaml-dev</code> 再执行 <code class="language-plaintext highlighter-rouge">rbenv install</code>，否则会报错：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*** Following extensions are not compiled:
psych:
    Could not be configured. It will not be installed.
BUILD FAILED
</code></pre></div> </div> </blockquote> <hr/> <h2 id="第三步处理-gem_home-冲突">第三步：处理 GEM_HOME 冲突</h2> <p>若系统 <code class="language-plaintext highlighter-rouge">~/.bashrc</code> 中存在为旧版 Ruby 手动设置的 <code class="language-plaintext highlighter-rouge">GEM_HOME</code>，会导致 gem 版本冲突（<code class="language-plaintext highlighter-rouge">linked to incompatible libruby-3.2.so</code>）。</p> <p>检查并注释掉相关行：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 编辑 ~/.bashrc，注释掉以下两行：</span>
<span class="c"># export GEM_HOME="$HOME/gems"</span>
<span class="c"># export PATH="$HOME/gems/bin:$PATH"</span>
</code></pre></div></div> <p>在新终端生效前，当前终端需手动清除：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME
<span class="nb">unset </span>GEM_PATH
</code></pre></div></div> <hr/> <h2 id="第四步安装-jupyter处理-ipynb-文件">第四步：安装 Jupyter（处理 .ipynb 文件）</h2> <p>al-folio 支持在博文中嵌入 Jupyter Notebook，需要系统安装 <code class="language-plaintext highlighter-rouge">jupyter</code>：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> jupyter-core jupyter-nbconvert
</code></pre></div></div> <blockquote> <p>Ubuntu 24.04 限制了通过 <code class="language-plaintext highlighter-rouge">pip install --user</code> 安装包，建议直接使用 apt 安装。</p> </blockquote> <hr/> <h2 id="第五步安装-ruby-gems">第五步：安装 Ruby Gems</h2> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/work/hxf0223.github.io

<span class="c"># 清除旧的 GEM_HOME（如尚未在新终端中）</span>
<span class="nb">unset </span>GEM_HOME

<span class="c"># 安装 Bundler</span>
gem <span class="nb">install </span>bundler

<span class="c"># 删除旧的 Gemfile.lock（如果存在）</span>
<span class="nb">rm</span> <span class="nt">-f</span> Gemfile.lock

<span class="c"># 安装所有依赖</span>
bundle <span class="nb">install</span>
</code></pre></div></div> <p>成功后输出类似：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Bundle complete! 27 Gemfile dependencies, 100 gems now installed.
</code></pre></div></div> <hr/> <h2 id="第六步启动本地服务">第六步：启动本地服务</h2> <blockquote> <p><strong>每次打开新终端前</strong>，如果 <code class="language-plaintext highlighter-rouge">~/.bashrc</code> 中的 <code class="language-plaintext highlighter-rouge">GEM_HOME</code> 尚未完全失效（旧终端），需先执行：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME
</code></pre></div> </div> <p>新登录的终端（<code class="language-plaintext highlighter-rouge">.bashrc</code> 已修复后）无需此步骤。</p> </blockquote> <h3 id="常规启动含文件监听推荐开发时使用">常规启动（含文件监听，推荐开发时使用）</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>jekyll serve <span class="nt">--port</span> 4000
</code></pre></div></div> <p>访问 <a href="http://localhost:4000">http://localhost:4000</a> 查看效果，修改文件后会自动重新构建。</p> <h3 id="仅构建不启动服务器">仅构建，不启动服务器</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>jekyll build
</code></pre></div></div> <p>生成结果输出到 <code class="language-plaintext highlighter-rouge">_site/</code> 目录。</p> <h3 id="增量构建加速二次构建">增量构建（加速二次构建）</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>jekyll serve <span class="nt">--port</span> 4000 <span class="nt">--incremental</span>
</code></pre></div></div> <p>只重新编译发生变动的文件，适合文章较多时加速预览。</p> <h3 id="指定-host局域网访问">指定 host（局域网访问）</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME <span class="o">&amp;&amp;</span> bundle <span class="nb">exec </span>jekyll serve <span class="nt">--port</span> 4000 <span class="nt">--host</span> 0.0.0.0
</code></pre></div></div> <p>局域网内其他设备可通过 <code class="language-plaintext highlighter-rouge">http://&lt;本机IP&gt;:4000</code> 访问。</p> <h3 id="生产环境构建">生产环境构建</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">unset </span>GEM_HOME <span class="o">&amp;&amp;</span> <span class="nv">JEKYLL_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>jekyll build
</code></pre></div></div> <p>启用 CSS/JS 压缩等生产优化，与 GitHub Actions 部署行为一致。</p> <hr/> <h2 id="常见问题汇总">常见问题汇总</h2> <table> <thead> <tr> <th>错误信息</th> <th>原因</th> <th>解决方案</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">psych: Could not be configured. BUILD FAILED</code></td> <td>缺少 <code class="language-plaintext highlighter-rouge">libyaml-dev</code></td> <td><code class="language-plaintext highlighter-rouge">sudo apt-get install libyaml-dev</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">linked to incompatible libruby-3.2.so</code></td> <td><code class="language-plaintext highlighter-rouge">GEM_HOME</code> 指向旧版本 gems</td> <td>注释 <code class="language-plaintext highlighter-rouge">~/.bashrc</code> 中的 <code class="language-plaintext highlighter-rouge">GEM_HOME</code>，执行 <code class="language-plaintext highlighter-rouge">unset GEM_HOME</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">bundler (= 4.0.4) required by user-specified dependency</code></td> <td>Ruby 版本太旧（3.1.x），Bundler 4.x 需要 Ruby &gt;= 3.3</td> <td>升级到 Ruby 3.3.5</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">sh: convert: not found</code></td> <td>ImageMagick 未安装</td> <td><code class="language-plaintext highlighter-rouge">sudo apt-get install imagemagick</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">No such file or directory - jupyter</code></td> <td>jupyter 未安装</td> <td><code class="language-plaintext highlighter-rouge">sudo apt-get install jupyter-core jupyter-nbconvert</code></td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Could not find a JavaScript runtime</code></td> <td>Node.js 未安装</td> <td><code class="language-plaintext highlighter-rouge">sudo apt-get install nodejs</code></td> </tr> </tbody> </table> <hr/> <h2 id="一键安装脚本">一键安装脚本</h2> <p>将以上步骤整合为脚本，方便在新机器上复现：</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span>

<span class="c"># 1. 系统依赖</span>
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> libyaml-dev libssl-dev libreadline-dev <span class="se">\</span>
    zlib1g-dev libffi-dev imagemagick nodejs <span class="se">\</span>
    jupyter-core jupyter-nbconvert

<span class="c"># 2. 安装 Ruby 3.3.5</span>
rbenv <span class="nb">install </span>3.3.5
rbenv <span class="nb">local </span>3.3.5

<span class="c"># 3. 清除旧 GEM_HOME（如有）</span>
<span class="nb">unset </span>GEM_HOME
<span class="nb">unset </span>GEM_PATH

<span class="c"># 4. 安装 Gems</span>
gem <span class="nb">install </span>bundler
<span class="nb">rm</span> <span class="nt">-f</span> Gemfile.lock
bundle <span class="nb">install

echo</span> <span class="s2">"✅ 完成！执行以下命令启动本地服务："</span>
<span class="nb">echo</span> <span class="s2">"   unset GEM_HOME &amp;&amp; bundle exec jekyll serve --port 4000"</span>
</code></pre></div></div> <hr/> <h2 id="部署到-github-pages-后的-prettier-检查">部署到 GitHub Pages 后的 Prettier 检查</h2> <p>将代码推送到 GitHub 后，Actions 会自动运行 Prettier 格式检查。若出现以下错误，说明文件格式不符合规范：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Checking formatting...
[warn] _config.yml
[warn] _posts/xxx.md
[warn] Code style issues found in N files. Run Prettier with --write to fix.
</code></pre></div></div> <h3 id="安装-npm如未安装">安装 npm（如未安装）</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> npm
</code></pre></div></div> <h3 id="安装-prettier-及-liquid-插件">安装 Prettier 及 Liquid 插件</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> ~/work/hxf0223.github.io
npm <span class="nb">install</span> <span class="nt">--save-dev</span> prettier @shopify/prettier-plugin-liquid
</code></pre></div></div> <h3 id="修复格式问题">修复格式问题</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx prettier <span class="nb">.</span> <span class="nt">--write</span>
</code></pre></div></div> <h3 id="验证全部通过">验证全部通过</h3> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx prettier <span class="nb">.</span> <span class="nt">--check</span>
<span class="c"># =&gt; All matched files use Prettier code style!</span>
</code></pre></div></div> <blockquote> <p><strong>建议：</strong> 每次 <code class="language-plaintext highlighter-rouge">git push</code> 之前先运行 <code class="language-plaintext highlighter-rouge">npx prettier . --write</code>，可避免 CI 格式检查失败。</p> </blockquote> <hr/> <h2 id="参考资料">参考资料</h2> <ul> <li><a href="https://george-gca.github.io/blog/2022/running-local-al-folio/">Running local al-folio</a></li> <li><a href="https://zhuanlan.zhihu.com/p/707289907">Jekyll al-folio 博客部署指南</a></li> <li><a href="https://github.com/flammingRaven/flammingRaven.github.io">flammingRaven 的 al-folio 部署参考</a></li> </ul>]]></content><author><name></name></author><category term="工具"/><category term="博客"/><category term="jekyll"/><category term="al-folio"/><category term="ubuntu"/><category term="ruby"/><category term="rbenv"/><summary type="html"><![CDATA[本文记录在 Ubuntu 24.04 上从零开始本地部署 al-folio Jekyll 主题的完整流程，以及遇到的问题和解决方案。]]></summary></entry><entry><title type="html">C++ Traits</title><link href="https://hxf0223.github.io/blog/2026/C++-Traits/" rel="alternate" type="text/html" title="C++ Traits"/><published>2026-02-06T00:00:00+00:00</published><updated>2026-02-06T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2026/C++-Traits</id><content type="html" xml:base="https://hxf0223.github.io/blog/2026/C++-Traits/"><![CDATA[<p>TBD</p> <h2 id="资料">资料</h2> <ul> <li><a href="https://accu.org/journals/overload/9/43/frogley_442">An introduction to C++ Traits</a></li> <li><a href="https://www.cnblogs.com/zhxmdefj/p/12530982.html">C++ Traits Classes</a></li> </ul>]]></content><author><name></name></author><category term="Cpp"/><category term="Cpp"/><summary type="html"><![CDATA[TBD]]></summary></entry><entry><title type="html">道格拉斯-普克算法(Douglas–Peucker algorithm)</title><link href="https://hxf0223.github.io/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95/" rel="alternate" type="text/html" title="道格拉斯-普克算法(Douglas–Peucker algorithm)"/><published>2025-12-28T00:00:00+00:00</published><updated>2025-12-28T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/%E9%81%93%E6%A0%BC%E6%8B%89%E6%96%AF-%E6%99%AE%E5%85%8B%E7%AE%97%E6%B3%95/"><![CDATA[<p>道格拉斯-普克算法（Douglas–Peucker algorithm），又称为<code class="language-plaintext highlighter-rouge">Ramer-Douglas-Peucker</code>算法，是一种用于简化曲线的算法。它通过减少曲线上的点数来近似表示原始曲线，同时尽量保持其形状和特征。可以应用于计算机图形学、地理信息系统（GIS）、甚至CAD领域。</p> <p>算法的具体实现逻辑如下：</p> <ol> <li>在轨迹曲线在曲线首尾两点<code class="language-plaintext highlighter-rouge">A</code>，<code class="language-plaintext highlighter-rouge">B</code>之间连接一条直线<code class="language-plaintext highlighter-rouge">AB</code>，该直线为曲线的弦；</li> <li>遍历曲线上其他所有点，求每个点到直线<code class="language-plaintext highlighter-rouge">AB</code>的距离，找到最大距离的点<code class="language-plaintext highlighter-rouge">C</code>，最大距离记为<code class="language-plaintext highlighter-rouge">maxDistance</code></li> <li>比较该距离<code class="language-plaintext highlighter-rouge">maxDistance</code>与预先定义的阈值<code class="language-plaintext highlighter-rouge">epsilon</code>大小，如果<code class="language-plaintext highlighter-rouge">maxDistance</code> &lt; <code class="language-plaintext highlighter-rouge">epsilon</code>，则将该直线<code class="language-plaintext highlighter-rouge">AB</code>作为曲线段的近似，舍去<code class="language-plaintext highlighter-rouge">AB</code>之间的所有点，曲线段处理完毕；</li> <li>若<code class="language-plaintext highlighter-rouge">maxDistance</code> &gt;= <code class="language-plaintext highlighter-rouge">epsilon</code>，则使<code class="language-plaintext highlighter-rouge">C</code>点将曲线<code class="language-plaintext highlighter-rouge">AB</code>分为<code class="language-plaintext highlighter-rouge">AC</code>和<code class="language-plaintext highlighter-rouge">CB</code>两段，并分别对这两段进行（1）~（3）步处理；</li> <li>当所有曲线都处理完毕时，依次连接各个分割点形成的折线，即为原始曲线的路径。</li> </ol> <p><img src="/assets/images/algorithm/20251228/Douglas-Peucker-algorithm.webp" alt="Douglas-Peucker Algorithm Illustration"/></p>]]></content><author><name></name></author><category term="Algorithm"/><category term="Algorithm"/><summary type="html"><![CDATA[道格拉斯-普克算法（Douglas–Peucker algorithm），又称为Ramer-Douglas-Peucker算法，是一种用于简化曲线的算法。它通过减少曲线上的点数来近似表示原始曲线，同时尽量保持其形状和特征。可以应用于计算机图形学、地理信息系统（GIS）、甚至CAD领域。]]></summary></entry><entry><title type="html">CMake支持库收集</title><link href="https://hxf0223.github.io/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93/" rel="alternate" type="text/html" title="CMake支持库收集"/><published>2025-12-23T00:00:00+00:00</published><updated>2025-12-23T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/CMake%E6%94%AF%E6%8C%81%E5%BA%93/"><![CDATA[<ul> <li><a href="https://github.com/MarkSchofield/WindowsToolchain">CMake Toolchain files for Windows</a></li> <li><a href="https://github.com/aminya/project_options">CMake project_options</a></li> </ul>]]></content><author><name></name></author><category term="CMake"/><category term="CMake"/><summary type="html"><![CDATA[CMake Toolchain files for Windows CMake project_options]]></summary></entry><entry><title type="html">QGC代码架构解析：飞行前检查（起飞条件）</title><link href="https://hxf0223.github.io/blog/2025/QGC%E9%A3%9E%E8%A1%8C%E5%89%8D%E6%A3%80%E6%9F%A5/" rel="alternate" type="text/html" title="QGC代码架构解析：飞行前检查（起飞条件）"/><published>2025-12-18T00:00:00+00:00</published><updated>2025-12-18T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/QGC%E9%A3%9E%E8%A1%8C%E5%89%8D%E6%A3%80%E6%9F%A5</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/QGC%E9%A3%9E%E8%A1%8C%E5%89%8D%E6%A3%80%E6%9F%A5/"><![CDATA[<p><code class="language-plaintext highlighter-rouge">QGC</code>中，飞行状态指示器（<code class="language-plaintext highlighter-rouge">Flight Status Indicator</code>）显示的状态列表：</p> <table> <thead> <tr> <th>状态名称</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>准备好飞速 (_绿色背景)</td> <td>载具已准备就绪，可以起飞</td> </tr> <tr> <td>准备好飞行 (_黄色背景)</td> <td>载具已准备好在当前飞行模式下飞行，但有些警告可能造成问题</td> </tr> <tr> <td>尚未准备好</td> <td>载具没有准备好飞行，也不会起飞</td> </tr> <tr> <td>解锁</td> <td>载具已解锁并准备起飞。</td> </tr> <tr> <td>飞行</td> <td>载具正在飞行</td> </tr> <tr> <td>着陆</td> <td>载具正在着陆</td> </tr> <tr> <td>通信丢失</td> <td><code class="language-plaintext highlighter-rouge">QGC</code>已失去与载具的通信</td> </tr> </tbody> </table> <p>更多信息，参考<a href="https://github.com/mavlink/qgroundcontrol/blob/master/docs/zh/qgc-user-guide/fly_view/fly_view_toolbar.md">飞行视图工具栏</a>。</p> <h2 id="1-解锁检查项">1. 解锁检查项</h2> <ul> <li>气压计（Barometer）</li> <li>指南针（Compass）</li> <li>GPS 锁定（GPS lock）</li> <li>惯性导航系统（INS）</li> <li>参数（Parameters）</li> <li>遥控通道（RC Channels）</li> <li>电路板电压（Board voltage）</li> <li>电池电量（Battery Level）</li> <li>空速（Airspeed）</li> <li>日志记录可用（Logging Available）</li> <li>硬件安全开关（Hardware safety switch）</li> <li>GPS 配置（GPS Configuration）</li> <li>系统（System） ：<a href="https://github.com/mavlink/qgroundcontrol/blob/master/docs/en/qgc-user-guide/setup_view/safety_ardupilot.md">Safety Setup (ArduPilot)</a></li> </ul> <p>检查实现函数：<code class="language-plaintext highlighter-rouge">HealthAndArmingCheckReport::update</code>。</p> <p><code class="language-plaintext highlighter-rouge">QGC</code>提供了可选的飞行前检查清单功能：<a href="https://github.com/mavlink/qgroundcontrol/blob/master/docs/en/qgc-user-guide/fly_view/hud.md#pre-flight-checklist-preflight_checklist">Pre Flight Checklist</a>。</p> <p>备注：</p> <ul> <li>通常情况下，不需要手动解锁飞机。简单地起飞或开始执行任务时，飞行器会自动解锁。</li> <li>不同的飞行器类型（多旋翼、固定翼、地面车、潜水器）可能有略微不同的解锁检查项，但核心检查项是相似的。</li> </ul> <h2 id="2-mav_mode">2. MAV_MODE</h2> <p><code class="language-plaintext highlighter-rouge">MAV_MODE</code>枚举定义了飞行器的标准飞行模式。不同的飞行模式决定了飞行器的行为和控制方式，设置命令是<code class="language-plaintext highlighter-rouge">MAV_CMD_DO_SET_MODE</code>。</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// common/common.h</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">MAV_MODE</span>
<span class="p">{</span>
   <span class="n">MAV_MODE_PREFLIGHT</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="cm">/* System is not ready to fly, booting, calibrating, etc. No flag is set. | */</span>
   <span class="n">MAV_MODE_MANUAL_DISARMED</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under manual (RC) control, no stabilization | */</span>
   <span class="n">MAV_MODE_TEST_DISARMED</span><span class="o">=</span><span class="mi">66</span><span class="p">,</span> <span class="cm">/* UNDEFINED mode. This solely depends on the autopilot - use with caution, intended for developers only. | */</span>
   <span class="n">MAV_MODE_STABILIZE_DISARMED</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under assisted RC control. | */</span>
   <span class="n">MAV_MODE_GUIDED_DISARMED</span><span class="o">=</span><span class="mi">88</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under autonomous control, manual setpoint | */</span>
   <span class="n">MAV_MODE_AUTO_DISARMED</span><span class="o">=</span><span class="mi">92</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under autonomous control and navigation (the trajectory is decided onboard and not pre-programmed by waypoints) | */</span>
   <span class="n">MAV_MODE_MANUAL_ARMED</span><span class="o">=</span><span class="mi">192</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under manual (RC) control, no stabilization | */</span>
   <span class="n">MAV_MODE_TEST_ARMED</span><span class="o">=</span><span class="mi">194</span><span class="p">,</span> <span class="cm">/* UNDEFINED mode. This solely depends on the autopilot - use with caution, intended for developers only. | */</span>
   <span class="n">MAV_MODE_STABILIZE_ARMED</span><span class="o">=</span><span class="mi">208</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under assisted RC control. | */</span>
   <span class="n">MAV_MODE_GUIDED_ARMED</span><span class="o">=</span><span class="mi">216</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under autonomous control, manual setpoint | */</span>
   <span class="n">MAV_MODE_AUTO_ARMED</span><span class="o">=</span><span class="mi">220</span><span class="p">,</span> <span class="cm">/* System is allowed to be active, under autonomous control and navigation (the trajectory is decided onboard and not pre-programmed by waypoints) | */</span>
   <span class="n">MAV_MODE_ENUM_END</span><span class="o">=</span><span class="mi">221</span><span class="p">,</span> <span class="cm">/*  | */</span>
<span class="p">}</span> <span class="n">MAV_MODE</span><span class="p">;</span>
</code></pre></div></div> <p>结合文章<code class="language-plaintext highlighter-rouge">QGC代码架构解析：MAVLink Mission Protocol，以及 QGC 航点管理</code>查看<code class="language-plaintext highlighter-rouge">MAV_CMD</code>相关命令。</p>]]></content><author><name></name></author><category term="QGC"/><category term="QGC"/><summary type="html"><![CDATA[QGC中，飞行状态指示器（Flight Status Indicator）显示的状态列表：]]></summary></entry><entry><title type="html">QGC代码架构解析：MAVLink Mission Protocol，以及 QGC 航点管理</title><link href="https://hxf0223.github.io/blog/2025/qgc_mission_manager/" rel="alternate" type="text/html" title="QGC代码架构解析：MAVLink Mission Protocol，以及 QGC 航点管理"/><published>2025-12-15T00:00:00+00:00</published><updated>2025-12-15T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/qgc_mission_manager</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/qgc_mission_manager/"><![CDATA[<p>本文厘清如下几个问题：</p> <ul> <li>航点协议（<code class="language-plaintext highlighter-rouge">Mission Protocol</code>）有哪些命令/消息；</li> <li>微服务的处理流程，以及流程中通信双方使用到的命令ID/请求ID-响应ID；</li> <li>带参数的命令/消息，其参数格式，以及单位；</li> <li>航点文件格式。</li> </ul> <h2 id="1-mavlink-mission-protocol">1. MAVLink Mission Protocol</h2> <p>航点协议主要实现航点集合的上传、下载、清除。另外有一些其他消息，以及附带的参数/枚举。</p> <p>航点上传/下载使用到如下几个消息定义：</p> <table> <thead> <tr> <th>消息名称</th> <th>说明</th> <th>发送方</th> </tr> </thead> <tbody> <tr> <td>MISSION_REQUEST_LIST</td> <td>启动航点集下载动作</td> <td>地面站</td> </tr> <tr> <td>MISSION_COUNT</td> <td>航点数量</td> <td>地面站/飞控</td> </tr> <tr> <td>MISSION_REQUEST_INT</td> <td>请求航点</td> <td>地面站/飞控</td> </tr> <tr> <td>MISSION_ITEM_INT</td> <td>请求航点</td> <td>飞控/地面站</td> </tr> <tr> <td>MISSION_ACK</td> <td>航点响应</td> <td>飞控/地面站</td> </tr> </tbody> </table> <h3 id="11-航点的上传下载流程">1.1. 航点的上传/下载流程</h3> <p>航点上传/下载流程图（左边为QGC请求下载，右边为QGC请求上传）：</p> <p><img src="/assets/images/qgc/20251216/mission_planner_flow_down_up.png" alt="航点上传下载流程图"/></p> <p>对比发现规律：</p> <ul> <li><code class="language-plaintext highlighter-rouge">QGC</code>请求下载时，使用<code class="language-plaintext highlighter-rouge">MISSION_REQUEST_LIST</code>来启动，而请求上传时，使用<code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>来启动（<strong>注意</strong>：不论上传/下载，都是<code class="language-plaintext highlighter-rouge">QGC</code>发起的）；</li> <li><code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>既可以作为飞控响应<code class="language-plaintext highlighter-rouge">QGC</code>的下载请求，也可以作为<code class="language-plaintext highlighter-rouge">QGC</code>请求飞控上传航点的启动消息；</li> <li>启动之后，中间航点的请求，双方使用<code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code> &lt;–&gt; <code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>配对，即一个完整的单个航点传输流程。航点发送方使用<code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code>请求，接收方使用<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>响应。</li> <li>最后使用<code class="language-plaintext highlighter-rouge">MISSION_ACK</code>作为<strong>结束标示</strong>。在这里，<code class="language-plaintext highlighter-rouge">ACK</code>消息的含义是结束，即整个流程结束了，这样理解更合理。</li> <li>从文档看，<code class="language-plaintext highlighter-rouge">MISSION_ACK</code>只用在上传/下载流程里面。其他消息里面没有使用到。</li> </ul> <p>上传/下载的流程，不具有对称性，给理解带来了一定的混乱。流程步骤在语义上理解也不顺畅。</p> <h4 id="111-协议实现注意事项">1.1.1. 协议实现注意事项</h4> <ul> <li>在流程图的<code class="language-plaintext highlighter-rouge">Start timeout</code>处，需要实现超时重传机制： <ul> <li><code class="language-plaintext highlighter-rouge">MISSION_REQUEST_LIST</code>超时没有响应，重传该命令若干次；</li> <li><code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>超时没有响应，重传该命令若干次；</li> <li><code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code>超时没有响应，重传该命令若干次；</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code>请求的航点，需要按序号顺序请求以及应答。如果收到的<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>中的航点顺序不对，需要丢弃该航点数据，并重新请求。</li> <li>当上传/下载航点时，飞机会返回一个<code class="language-plaintext highlighter-rouge">opaque_id</code>（类似整个航点集合计算得到的哈希），用于避免不不必要的再次上传/下载。当<code class="language-plaintext highlighter-rouge">QGC</code>上传时，飞机在最后一个消息返回该值：<code class="language-plaintext highlighter-rouge">MISSION_ACK.opaque_id</code>。当<code class="language-plaintext highlighter-rouge">QGC</code>下载时，飞机在<code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>中返回该值：<code class="language-plaintext highlighter-rouge">MISSION_COUNT.opaque_id</code>。</li> <li>当上传/下载的过程中失败时（对方提前返回<code class="language-plaintext highlighter-rouge">MISSION_ACK</code>并包含错误消息），<code class="language-plaintext highlighter-rouge">QGC</code>或者飞机应该终止当前流程，并恢复使用上一次的航点集。</li> <li>协议没有说明，上传过程中，最后一步，如果飞机没有返回<code class="language-plaintext highlighter-rouge">MISSION_ACK</code>，应该如何处理。<code class="language-plaintext highlighter-rouge">QGC</code>的实际处理方式是，认为上传成功并完成，但是<code class="language-plaintext highlighter-rouge">opaque_id</code>没有更新。</li> </ul> <h3 id="12-航点消息结构消息-mission_item_int以及-mav_cmd">1.2. 航点消息结构：消息 MISSION_ITEM_INT，以及 MAV_CMD</h3> <p>航点不仅仅只有坐标等数据，还包含动作含义，即<code class="language-plaintext highlighter-rouge">MAV_CMD</code>其实是一个命令+参数数据。<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>就是用于发送这些<code class="language-plaintext highlighter-rouge">MAV_CMD</code>子命令+参数的。<code class="language-plaintext highlighter-rouge">MAV_CMD</code>分为如下几类：</p> <ul> <li><code class="language-plaintext highlighter-rouge">MAV_CMD_NAV_*</code>：导航类命令（起飞、降落、返回RTL、悬停、飞到指定航点位置），比如<code class="language-plaintext highlighter-rouge">MAV_CMD_NAV_WAYPOINT</code>表示普通航点，<code class="language-plaintext highlighter-rouge">MAV_CMD_NAV_LOITER_UNLIM</code>表示无限悬停等。</li> <li><code class="language-plaintext highlighter-rouge">MAV_CMD_DO_*</code>：动作类命令，比如<code class="language-plaintext highlighter-rouge">MAV_CMD_DO_CHANGE_SPEED</code>表示改变速度，<code class="language-plaintext highlighter-rouge">MAV_CMD_DO_SET_RELAY</code>表示设置继电器等；</li> <li><code class="language-plaintext highlighter-rouge">MAV_CMD_CONDITION_*</code>：命令执行条件，比如<code class="language-plaintext highlighter-rouge">MAV_CMD_CONDITION_DELAY</code>表示等待一段时间之后，再执行下一个航点<code class="language-plaintext highlighter-rouge">MAV_CMD</code>。从<code class="language-plaintext highlighter-rouge">Ardupilot</code>文档看，<code class="language-plaintext highlighter-rouge">MAV_CMD_CONDITION_*</code>命令是作用于<code class="language-plaintext highlighter-rouge">MAV_CMD_DO_*</code>命令，参考<a href="https://ardupilot.org/dev/docs/common-mavlink-mission-command-messages-mav_cmd.html#conditional-commands">Ardupilot – Mission Commands – Conditional commands</a>。</li> </ul> <p>主要的<code class="language-plaintext highlighter-rouge">MAV_CMD_NAV</code>命令列表：</p> <table> <thead> <tr> <th>Command ID</th> <th>Name</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>16</td> <td>MAV_CMD_NAV_WAYPOINT</td> <td>Navigate to a specific waypoint</td> </tr> <tr> <td>21</td> <td>MAV_CMD_NAV_LAND</td> <td>Land at the specified location</td> </tr> <tr> <td>22</td> <td>MAV_CMD_NAV_TAKEOFF</td> <td>Take off and ascend to specified altitude</td> </tr> <tr> <td>20</td> <td>MAV_CMD_NAV_RETURN_TO_LAUNCH</td> <td>Return to launch/home location</td> </tr> <tr> <td>80</td> <td>MAV_CMD_NAV_ROI</td> <td>Sets region of interest for camera</td> </tr> <tr> <td>82</td> <td>MAV_CMD_NAV_SPLINE_WAYPOINT</td> <td>Navigate using a spline path</td> </tr> </tbody> </table> <p>所有<code class="language-plaintext highlighter-rouge">MAV_CMD</code>命令的完整列表，以及参数，可以参考<code class="language-plaintext highlighter-rouge">MAVLink</code>协议文档：<a href="https://mavlink.io/en/messages/common.html#mav_commands">Commands (MAV_CMD)</a>。</p> <h3 id="13-航点命令的参数mission_item_int的参数frame坐标系">1.3. 航点命令的参数：MISSION_ITEM_INT的参数：Frame（坐标系）</h3> <p>在使用<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>消息发送航点命令(<code class="language-plaintext highlighter-rouge">Mission Item</code>)时（包括<code class="language-plaintext highlighter-rouge">MAV_CMD_NAV_*</code>命令，以及<code class="language-plaintext highlighter-rouge">MAV_CMD_DO_*</code>命令），需要指定坐标系<code class="language-plaintext highlighter-rouge">frame</code>，比如<code class="language-plaintext highlighter-rouge">WGS84</code>坐标系，<code class="language-plaintext highlighter-rouge">NED</code>坐标系，或者在<code class="language-plaintext highlighter-rouge">WGS84</code>坐标系的修改，如高度改为相对<code class="language-plaintext highlighter-rouge">HOME</code>点高度，或者地形高度。坐标系枚举定义见：<a href="https://mavlink.io/en/messages/common.html#MAV_FRAME">MAV_FRAME</a>。</p> <p>官方文档整理下来，有关<code class="language-plaintext highlighter-rouge">Frame</code>的描述，没有完全讲清楚，整个<code class="language-plaintext highlighter-rouge">MAVLink</code>协议中，有若干个命令使用到<code class="language-plaintext highlighter-rouge">Frame</code>作为参数。常见的需要使用到<code class="language-plaintext highlighter-rouge">Frame</code>的命令：</p> <ul> <li><code class="language-plaintext highlighter-rouge">Mission Protocol</code>中少量<code class="language-plaintext highlighter-rouge">MAV_CMD_DO</code>。</li> <li><code class="language-plaintext highlighter-rouge">COMMAND_INT</code>需要使用<code class="language-plaintext highlighter-rouge">Frame</code>作为命令参数：<a href="https://mavlink.io/en/services/command.html">Command Protocol</a>。</li> </ul> <p>根据文档描述，针对<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>，目前<code class="language-plaintext highlighter-rouge">APM</code>以及<code class="language-plaintext highlighter-rouge">PX4</code>仅支持<code class="language-plaintext highlighter-rouge">global</code>类型的<code class="language-plaintext highlighter-rouge">Frame</code>，见文档描述<a href="https://mavlink.io/en/services/mission.html#mavlink_commands">Mission Items (MAVLink Commands)</a>。另外，有少量的<code class="language-plaintext highlighter-rouge">MAV_CMD_DO</code>命令，里面也带有<code class="language-plaintext highlighter-rouge">frame</code>参数，很奇怪，有些混乱。</p> <p>更多信息：</p> <ul> <li><a href="https://mavlink.io/en/services/mission.html#frames-positional-information">MAVLink – Frames &amp; Positional Information</a></li> <li><a href="https://ardupilot.org/dev/docs/common-mavlink-mission-command-messages-mav_cmd.html#navigation-commands">Ardupilot – Navigation commands</a></li> <li><a href="https://mavlink.io/en/messages/common.html#mav_commands">MAVLink – Commands (MAV_CMD)</a></li> <li><a href="https://mavlink.io/en/messages/common.html#MISSION_ITEM_INT">MAVLink – MISSION_ITEM_INT (73)</a></li> </ul> <h3 id="14-航点命令的参数mission_item_int的参数param1--param7">1.4. 航点命令的参数：MISSION_ITEM_INT的参数：param1 ~ param7</h3> <p><img src="/assets/images/qgc/20251216/MISSION_ITEM_INT_params.png" alt="MISSION_ITEM_INT_params"/></p> <p>前四个参数<code class="language-plaintext highlighter-rouge">param1</code> ~ <code class="language-plaintext highlighter-rouge">param4</code>，具体含义，以及单位，由具体的<code class="language-plaintext highlighter-rouge">MAV_CMD</code>命令决定，且数据类型就是<code class="language-plaintext highlighter-rouge">float</code>，即如果是其他类型，需要<code class="language-plaintext highlighter-rouge">static_cast</code>转换为<code class="language-plaintext highlighter-rouge">float</code>。</p> <p>针对<code class="language-plaintext highlighter-rouge">MAV_CMD_NAV</code>命令，则是坐标信息，其中<code class="language-plaintext highlighter-rouge">param5</code>、<code class="language-plaintext highlighter-rouge">param6</code>（经纬度）是全局坐标，即<code class="language-plaintext highlighter-rouge">1e7</code>。高度参数<code class="language-plaintext highlighter-rouge">param7</code>，其含义由<code class="language-plaintext highlighter-rouge">frame</code>指定（但应该全部都是<code class="language-plaintext highlighter-rouge">global</code>类型的），<code class="language-plaintext highlighter-rouge">global</code>坐标系列表：</p> <ul> <li><code class="language-plaintext highlighter-rouge">MAV_FRAME_GLOBAL_INT</code>，</li> <li><code class="language-plaintext highlighter-rouge">MAV_FRAME_GLOBAL_RELATIVE_ALT_INT</code>，</li> <li><code class="language-plaintext highlighter-rouge">MAV_FRAME_GLOBAL_TERRAIN_ALT</code>，</li> <li><code class="language-plaintext highlighter-rouge">MAV_FRAME_GLOBAL_TERRAIN_ALT_INT</code>，</li> <li><code class="language-plaintext highlighter-rouge">MAV_FRAME_GLOBAL</code>。</li> </ul> <p>另外，如果<code class="language-plaintext highlighter-rouge">frame</code>是<code class="language-plaintext highlighter-rouge">MAV_FRAME_MISSION</code>，表示这<code class="language-plaintext highlighter-rouge">param5</code> ~ <code class="language-plaintext highlighter-rouge">param7</code>不是坐标，所以实现发送/接收的时候，不需要将<code class="language-plaintext highlighter-rouge">param5</code> ~ <code class="language-plaintext highlighter-rouge">param7</code>乘以<code class="language-plaintext highlighter-rouge">1e7</code>。</p> <p>根据协议，如果是<code class="language-plaintext highlighter-rouge">frame</code>的类型是<code class="language-plaintext highlighter-rouge">local</code>的，则发送/接收的时候<code class="language-plaintext highlighter-rouge">param5</code>、<code class="language-plaintext highlighter-rouge">param6</code>的精度应该是<code class="language-plaintext highlighter-rouge">1e4</code>，单位是米（参考协议文档<a href="https://mavlink.io/en/services/mission.html#frames-positional-information">Frames &amp; Positional Information</a>）。</p> <p><strong>总结</strong>：协议实现的时候：</p> <ul> <li>如果<code class="language-plaintext highlighter-rouge">frame</code>是<code class="language-plaintext highlighter-rouge">MAV_FRAME_MISSION</code>：则<code class="language-plaintext highlighter-rouge">param5</code>、<code class="language-plaintext highlighter-rouge">param6</code>按原样发送值，可能需要<code class="language-plaintext highlighter-rouge">static_cast&lt;int&gt;</code>转换。</li> <li>如果<code class="language-plaintext highlighter-rouge">frame</code>是<code class="language-plaintext highlighter-rouge">global</code>类型的：则<code class="language-plaintext highlighter-rouge">param5</code>、<code class="language-plaintext highlighter-rouge">param6</code>需要乘以<code class="language-plaintext highlighter-rouge">1e7</code>进行发送，接收时需要除以<code class="language-plaintext highlighter-rouge">1e7</code>。</li> <li>如果<code class="language-plaintext highlighter-rouge">frame</code>是<code class="language-plaintext highlighter-rouge">local</code>类型的：则<code class="language-plaintext highlighter-rouge">param5</code>、<code class="language-plaintext highlighter-rouge">param6</code>需要乘以<code class="language-plaintext highlighter-rouge">1e4</code>进行发送，接收时需要除以<code class="language-plaintext highlighter-rouge">1e4</code>。</li> <li>其他<code class="language-plaintext highlighter-rouge">param1</code> ~ <code class="language-plaintext highlighter-rouge">param4</code>，以及<code class="language-plaintext highlighter-rouge">param7</code>，按原样发送/接收，可能需要<code class="language-plaintext highlighter-rouge">static_cast&lt;float&gt;</code>转换。</li> </ul> <p>另外，这个规则，应该也适用于<code class="language-plaintext highlighter-rouge">COMMAND_INT</code>命令<a href="https://mavlink.io/en/messages/common.html#COMMAND_INT">COMMAND_INT</a>。且：</p> <ul> <li>使用<code class="language-plaintext highlighter-rouge">COMMAND_INT</code>命令时，有些参数没有使用到，部分样例参考：<a href="https://ardupilot.org/copter/docs/common-mavlink-mission-command-messages-mav_cmd.html#commands-supported-by-copter">ardupilot – Commands supported by Copter</a></li> <li>这些浮点类型的参数，值<code class="language-plaintext highlighter-rouge">nan</code>也有有意义的，比如维持原值，具体搜索<code class="language-plaintext highlighter-rouge">QGC</code>代码中<code class="language-plaintext highlighter-rouge">qQNaN()</code>的使用地方。</li> </ul> <h3 id="15-航点管理中其他命令消息">1.5. 航点管理中其他命令/消息</h3> <p>如下两个消息，用来监控航点执行进度及状态：</p> <ul> <li><code class="language-plaintext highlighter-rouge">MISSION_CURRENT</code>：当前航点改变通知消息，由飞控广播，其他信息：序号<code class="language-plaintext highlighter-rouge">seq</code>，一起当前飞机航点状态，比如是否是暂停等。</li> <li><code class="language-plaintext highlighter-rouge">MISSION_ITEM_REACHED</code>：与<code class="language-plaintext highlighter-rouge">MISSION_CURRENT</code>类似，<code class="language-plaintext highlighter-rouge">QGC</code>中没有处理该消息。</li> </ul> <p>清除航点使用消息：<code class="language-plaintext highlighter-rouge">MISSION_CLEAR_ALL</code>。</p> <h2 id="2-qgc-航点管理实现">2. QGC 航点管理实现</h2> <p><code class="language-plaintext highlighter-rouge">PlanManager</code>实现<code class="language-plaintext highlighter-rouge">Mission Protocol</code>的协议。由于<code class="language-plaintext highlighter-rouge">MAVLink v2</code>中将航点(<code class="language-plaintext highlighter-rouge">flight plans</code>)、地理围栏(<code class="language-plaintext highlighter-rouge">geofences</code>)、降落点(<code class="language-plaintext highlighter-rouge">rally/safe points</code>)都放在<code class="language-plaintext highlighter-rouge">Mission Protocol</code>中，在请求上传(<code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>)/下载(<code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code>)，以及传输(<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>)时，带有<code class="language-plaintext highlighter-rouge">MAV_MISSION_TYPE</code>字段，确定是哪种<code class="language-plaintext highlighter-rouge">Mission Type</code>，参考协议文档：<a href="https://mavlink.io/en/services/mission.html#mission_types">Mission Protocol – Mission Types</a>。</p> <ul> <li><code class="language-plaintext highlighter-rouge">MissionManager</code>：拓展航点的协议<code class="language-plaintext highlighter-rouge">MAV_MISSION_TYPE_MISSION</code>的固件实现：主要实现<code class="language-plaintext highlighter-rouge">Ardupilot</code>相关的实现，以及一些功能。</li> <li><code class="language-plaintext highlighter-rouge">GeoFenceManager</code>：实现<code class="language-plaintext highlighter-rouge">MAV_MISSION_TYPE_FENCE</code>。</li> <li><code class="language-plaintext highlighter-rouge">RallyPointManager</code>：实现<code class="language-plaintext highlighter-rouge">MAV_MISSION_TYPE_RALLY</code>。</li> </ul> <h3 id="21-航点协议上传下载功能的实现">2.1. 航点协议上传/下载功能的实现</h3> <p><code class="language-plaintext highlighter-rouge">PlanManager</code>使用状态机实现上传/下载流程。定义一个<code class="language-plaintext highlighter-rouge">TransactionType_t</code>枚举，表示当前的事务类型，以及一个<code class="language-plaintext highlighter-rouge">AckType_t</code>表示期望的<code class="language-plaintext highlighter-rouge">ACK</code>类型：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">AckNone</span><span class="p">,</span>            <span class="c1">///&lt; State machine is idle</span>
    <span class="n">AckMissionCount</span><span class="p">,</span>    <span class="c1">///&lt; MISSION_COUNT message expected</span>
    <span class="n">AckMissionItem</span><span class="p">,</span>     <span class="c1">///&lt; MISSION_ITEM expected</span>
    <span class="n">AckMissionRequest</span><span class="p">,</span>  <span class="c1">///&lt; MISSION_REQUEST is expected, or MISSION_ACK to end sequence</span>
    <span class="n">AckMissionClearAll</span><span class="p">,</span> <span class="c1">///&lt; MISSION_CLEAR_ALL sent, MISSION_ACK is expected</span>
    <span class="n">AckGuidedItem</span><span class="p">,</span>      <span class="c1">///&lt; MISSION_ACK expected in response to ArduPilot guided mode single item send</span>
<span class="p">}</span> <span class="n">AckType_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">TransactionNone</span><span class="p">,</span>
    <span class="n">TransactionRead</span><span class="p">,</span>
    <span class="n">TransactionWrite</span><span class="p">,</span>
    <span class="n">TransactionRemoveAll</span>
<span class="p">}</span> <span class="n">TransactionType_t</span><span class="p">;</span>
</code></pre></div></div> <p>请求下载入口函数：<code class="language-plaintext highlighter-rouge">PlanManager::loadFromVehicle</code>，请求上传入口函数：<code class="language-plaintext highlighter-rouge">PlanManager::writeMissionItems(const QList&lt;MissionItem*&gt;&amp; missionItems)</code>。以及一个handle函数，用于处理收到的消息：</p> <ul> <li><code class="language-plaintext highlighter-rouge">PlanManager::_handleMissionCount</code>：处理<code class="language-plaintext highlighter-rouge">MISSION_COUNT</code>消息（请求下载）；</li> <li><code class="language-plaintext highlighter-rouge">PlanManager::_handleMissionItem</code>：处理<code class="language-plaintext highlighter-rouge">MISSION_ITEM_INT</code>消息（请求下载）；</li> <li><code class="language-plaintext highlighter-rouge">PlanManager::_handleMissionRequestInt</code>：处理<code class="language-plaintext highlighter-rouge">MISSION_REQUEST_INT</code>消息（请求上传）；</li> </ul> <p><code class="language-plaintext highlighter-rouge">PlanManager</code>中，有两个函数处理<code class="language-plaintext highlighter-rouge">ACK</code>消息：<code class="language-plaintext highlighter-rouge">_handleMissionAck</code>，<code class="language-plaintext highlighter-rouge">_ackTimeout</code>，这两个函数驱动状态机的流转：判断<code class="language-plaintext highlighter-rouge">ACK</code>与请求步骤是否匹配，发送一下一个航点数据/请求下一个航点数据，以及结束流程。</p> <h3 id="22-其他模块">2.2. 其他模块</h3> <ul> <li><code class="language-plaintext highlighter-rouge">MissionItem</code>：表示单个航点数据结构，航点管理模块的基础数据类。</li> <li><code class="language-plaintext highlighter-rouge">MissionController</code>：提供<code class="language-plaintext highlighter-rouge">QML</code>接口访问航点数据。</li> <li><code class="language-plaintext highlighter-rouge">PlanMasterController</code>：航点管理模块的顶层控制类（入口），提供<code class="language-plaintext highlighter-rouge">QML</code>接口访问航点（<code class="language-plaintext highlighter-rouge">MissionController</code>）、电子围栏（<code class="language-plaintext highlighter-rouge">GeoFenceController</code>）、降落点（<code class="language-plaintext highlighter-rouge">RallyPointController</code>）。以及从文件中加载/保存（包含<code class="language-plaintext highlighter-rouge">kml</code>文件格式）。</li> <li><code class="language-plaintext highlighter-rouge">MissionCommandTree</code>：提供<code class="language-plaintext highlighter-rouge">MAV_CMD</code>命令树结构，供<code class="language-plaintext highlighter-rouge">QML</code>界面使用。</li> </ul> <h3 id="23-航点文件格式">2.3. 航点文件格式</h3> <p><code class="language-plaintext highlighter-rouge">QGC</code>中，航点文件格式使用<code class="language-plaintext highlighter-rouge">JSON</code>格式，文件扩展名为<code class="language-plaintext highlighter-rouge">.plan</code>，保存目录样例：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:\Users\Administrator\Documents\QGroundControl Daily\Missions
</code></pre></div></div> <p>保存时，将航点数据、电子围栏数据、降落点数据，保存到同一个文件中。保存及加载函数入口：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PlanMasterController</span><span class="o">::</span><span class="n">saveToJson</span><span class="p">();</span>
<span class="n">MissionController</span><span class="o">::</span><span class="n">save</span><span class="p">(</span><span class="n">QJsonObject</span><span class="o">&amp;</span> <span class="n">json</span><span class="p">);</span>

<span class="c1">// 加载实现</span>
<span class="kt">bool</span> <span class="nf">_loadJsonMissionFileV2</span><span class="p">(</span><span class="k">const</span> <span class="n">QJsonObject</span><span class="o">&amp;</span> <span class="n">json</span><span class="p">,</span> <span class="n">QmlObjectListModel</span><span class="o">*</span> <span class="n">visualItems</span><span class="p">,</span> <span class="n">QString</span><span class="o">&amp;</span> <span class="n">errorString</span><span class="p">);</span>
</code></pre></div></div> <p>另外还可以导出/导入<code class="language-plaintext highlighter-rouge">kml</code>格式的航点文件，记录的字段格式有所不同，另外测试发现加载有些<code class="language-plaintext highlighter-rouge">BUG</code>。</p> <p>航点有<code class="language-plaintext highlighter-rouge">SimpleItem</code>，以及<code class="language-plaintext highlighter-rouge">ComplexItem</code>，一个简单的航点文件样例：</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"fileType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Plan"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
  </span><span class="nl">"groundStation"</span><span class="p">:</span><span class="w"> </span><span class="s2">"QGroundControl"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"mission"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"cruiseSpeed"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hoverSpeed"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AMSLAltAboveTerrain"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nl">"autoContinue"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
        </span><span class="nl">"frame"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">47.397742</span><span class="p">,</span><span class="w"> </span><span class="mf">8.545594</span><span class="p">,</span><span class="w"> </span><span class="mi">488</span><span class="p">],</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SimpleItem"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AMSLAltAboveTerrain"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nl">"autoContinue"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
        </span><span class="nl">"frame"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">47.397825</span><span class="p">,</span><span class="w"> </span><span class="mf">8.545632</span><span class="p">,</span><span class="w"> </span><span class="mi">488</span><span class="p">],</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"SimpleItem"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>有关航点文件格式的更多信息，参考<code class="language-plaintext highlighter-rouge">QGC</code>代码仓库文档：</p> <ul> <li><a href="https://github.com/mavlink/qgroundcontrol/blob/master/docs/en/qgc-dev-guide/plan/mission_command_tree.md">Mission Command Tree</a></li> <li><a href="https://github.com/mavlink/qgroundcontrol/blob/master/docs/en/qgc-dev-guide/file_formats/plan.md">Plan File Format</a></li> </ul> <h2 id="3-参考文档">3. 参考文档</h2> <ul> <li><a href="https://mavlink.io/en/services/mission.html">MAVLink Mission Protocol</a></li> <li><a href="https://ardupilot.org/dev/docs/common-mavlink-mission-command-messages-mav_cmd.html">Ardupilot – Mission Commands</a></li> </ul>]]></content><author><name></name></author><category term="QGC"/><category term="QGC"/><summary type="html"><![CDATA[本文厘清如下几个问题：]]></summary></entry><entry><title type="html">AI工具收集，其他不分类工具收集，持续更新</title><link href="https://hxf0223.github.io/blog/2025/AI%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86/" rel="alternate" type="text/html" title="AI工具收集，其他不分类工具收集，持续更新"/><published>2025-12-14T00:00:00+00:00</published><updated>2025-12-14T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/AI%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/AI%E5%B7%A5%E5%85%B7%E6%94%B6%E9%9B%86/"><![CDATA[<ul> <li><a href="https://github.com/funstory-ai/BabelDOC">BabelDOC</a>: 一款基于AI的文档生成工具，能够自动从代码库中提取信息并生成详细的技术文档，支持多种编程语言和格式。</li> </ul> <h2 id="其他实用工具">其他实用工具</h2> <ul> <li><a href="https://github.com/yt-dlp/yt-dlp">yt-dlp</a>: 一个命令行视频下载工具，支持从YouTube及其他多个网站下载视频，功能强大且持续更新。</li> </ul>]]></content><author><name></name></author><category term="AI"/><category term="AI"/><summary type="html"><![CDATA[BabelDOC: 一款基于AI的文档生成工具，能够自动从代码库中提取信息并生成详细的技术文档，支持多种编程语言和格式。]]></summary></entry><entry><title type="html">QGC代码架构解析：QGC初始加载及状态机</title><link href="https://hxf0223.github.io/blog/2025/qgc_init_load_states/" rel="alternate" type="text/html" title="QGC代码架构解析：QGC初始加载及状态机"/><published>2025-12-13T00:00:00+00:00</published><updated>2025-12-13T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/qgc_init_load_states</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/qgc_init_load_states/"><![CDATA[<p>在收到飞机发来的心跳包后，消息发送给<code class="language-plaintext highlighter-rouge">MultiVehicleManager</code>，在<code class="language-plaintext highlighter-rouge">MultiVehicleManager</code>中，检查组件ID是否是<code class="language-plaintext highlighter-rouge">MAV_COMP_ID_AUTOPILOT1</code>，以及<code class="language-plaintext highlighter-rouge">vehicleType</code>不是<code class="language-plaintext highlighter-rouge">GCS</code>等之后，会创建一个<code class="language-plaintext highlighter-rouge">Vehicle</code>对象，并进入初始化流程。</p> <blockquote> <p><code class="language-plaintext highlighter-rouge">mavlink_message_t</code>中已经包含了<code class="language-plaintext highlighter-rouge">sysid</code>、<code class="language-plaintext highlighter-rouge">compid</code>信息。而心跳包<code class="language-plaintext highlighter-rouge">mavlink_heartbeat_t</code>中则包含了<code class="language-plaintext highlighter-rouge">vehicleType</code>、<code class="language-plaintext highlighter-rouge">firmwareType</code>等信息。</p> </blockquote> <blockquote> <p>需要注意的是，与飞控通信中，组件ID是固定的：<code class="language-plaintext highlighter-rouge">MAV_COMP_ID_AUTOPILOT1</code>，即每个飞控的组件ID都是1。</p> </blockquote> <p>飞机发现、创建及初始化流程如下图所示： <img src="/assets/images/qgc/20251214/QGC-Vehicle-Discovery-and-Creation-Process.png" alt="qgc_vehicle_init"/></p> <p>主要初始流程入口在<code class="language-plaintext highlighter-rouge">InitialConnectStateMachine</code>中以状态机实现，且部分子流程也是以状态机实现（至多嵌套了三层状态机）：</p> <blockquote> <p>由于获取信息需要使用同步方式，在<code class="language-plaintext highlighter-rouge">InitialConnectStateMachine</code>状态机中，使用回调方式处理应答<code class="language-plaintext highlighter-rouge">Ack</code>，在回调中进入下一个处理阶段。参见：<a href="#1-请求的实现以及模拟同步请求">1. 请求的实现，以及模拟同步请求</a>。</p> </blockquote> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="n">StateMachine</span><span class="o">::</span><span class="n">StateFn</span> <span class="n">_rgStates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">_stateRequestAutopilotVersion</span><span class="p">,</span>
    <span class="n">_stateRequestStandardModes</span><span class="p">,</span>
    <span class="n">_stateRequestCompInfo</span><span class="p">,</span>
    <span class="n">_stateRequestParameters</span><span class="p">,</span>
    <span class="n">_stateRequestMission</span><span class="p">,</span>
    <span class="n">_stateRequestGeoFence</span><span class="p">,</span>
    <span class="n">_stateRequestRallyPoints</span><span class="p">,</span>
    <span class="n">_stateSignalInitialConnectComplete</span>
<span class="p">};</span>
</code></pre></div></div> <h2 id="1-请求的实现以及模拟同步请求">1. 请求的实现，以及模拟同步请求</h2> <p>请求飞机信息，使用<code class="language-plaintext highlighter-rouge">MAV_CMD_REQUEST_MESSAGE</code>命令字，请求对应的消息ID（即子命令，比如请求飞机版本信息<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AUTOPILOT_VERSION</code>），以及子命令的参数。另外，使用命令<code class="language-plaintext highlighter-rouge">MAV_CMD_SET_MESSAGE_INTERVAL</code>让飞机定期周期响应子命令消息。</p> <p>飞机端收到<code class="language-plaintext highlighter-rouge">MESSAGE</code>消息之后，先返回一个响应<code class="language-plaintext highlighter-rouge">Ack</code>（<code class="language-plaintext highlighter-rouge">Ack</code>中包含<code class="language-plaintext highlighter-rouge">msgid</code>，以及响应码，比如<code class="language-plaintext highlighter-rouge">MAV_RESULT_ACCEPTED</code>）。<code class="language-plaintext highlighter-rouge">QGC</code>收到该消息，继续处理之前发送的请求，实现代码主要有两个函数入口：<code class="language-plaintext highlighter-rouge">Vehicle::requestMessage</code>，<code class="language-plaintext highlighter-rouge">Vehicle::_handleCommandAck(mavlink_message_t&amp; message)</code>，以及一个主要的数据成员<code class="language-plaintext highlighter-rouge">QMap&lt;int, QMap&lt;int, RequestMessageInfo_t*&gt;&gt; _requestMessageInfoMap</code>。</p> <p><code class="language-plaintext highlighter-rouge">MAV_CMD_REQUEST_MESSAGE</code>消息的文档：<a href="https://mavlink.io/en/mavgen_python/howto_requestmessages.html">How to Request &amp; Stream Messages</a>。处理流程示例：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>你的程序                           飞控
   |                               |
   | 1. 发送 MAV_CMD_SET_MESSAGE_INTERVAL
   |----------------------------------------→  (请求：以1Hz发送BATTERY_STATUS)
   |
   |                               | 处理请求
   | 2. 接收 COMMAND_ACK
   |←----------------------------------------  (确认已接受)
   |
   | 3. 等待 BATTERY_STATUS
   |
   |                               | 自动发送电池信息（周期:  1秒）
   | ← 接收 BATTERY_STATUS #1      |
   | ← 接收 BATTERY_STATUS #2      | （自动循环，无需请求）
   | ← 接收 BATTERY_STATUS #3      |
   | ← 接收 BATTERY_STATUS #4      |
</code></pre></div></div> <h2 id="2-请求飞机版本信息mavlink_msg_id_autopilot_version">2. 请求飞机版本信息(<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AUTOPILOT_VERSION</code>)</h2> <p>主要获取飞机的编号、固件的<code class="language-plaintext highlighter-rouge">vender_id</code>、<code class="language-plaintext highlighter-rouge">product_id</code>，固件版本信息，以及<code class="language-plaintext highlighter-rouge">capabilities</code>（64位bitmask），<code class="language-plaintext highlighter-rouge">capabilities</code>相关枚举定义在<code class="language-plaintext highlighter-rouge">MAVLink</code>协议的<code class="language-plaintext highlighter-rouge">MAV_PROTOCOL_CAPABILITY</code>中。</p> <h2 id="3-请求飞机标准模式mavlink_msg_id_available_modes">3. 请求飞机标准模式(<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_AVAILABLE_MODES</code>)</h2> <p>主要获取飞机支持的标准模式。获取的模式列表用于设置给<code class="language-plaintext highlighter-rouge">FirmwarePlugin</code>，并在<code class="language-plaintext highlighter-rouge">Vehicle</code>中使用。</p> <h2 id="4-请求组件元数据meta信息">4. 请求组件元数据（META）信息</h2> <p>由于这一步请求处理多个类型<code class="language-plaintext highlighter-rouge">META</code>数据文件，整个处理放在单独的模块（源码文件）<code class="language-plaintext highlighter-rouge">ComponentInformationManager</code>中，且也使用状态机来实现：请求<code class="language-plaintext highlighter-rouge">General</code>元数据、<code class="language-plaintext highlighter-rouge">Param</code>元数据、<code class="language-plaintext highlighter-rouge">Events</code>元数据、<code class="language-plaintext highlighter-rouge">Actuator</code>元数据。<code class="language-plaintext highlighter-rouge">General</code>是指组件的信息（主要是飞控自身），而<code class="language-plaintext highlighter-rouge">Events</code>，<code class="language-plaintext highlighter-rouge">Actuator</code>不一定每个组件都有。</p> <p>请求每个子分类的<code class="language-plaintext highlighter-rouge">META</code>数据，分为几个步骤（还是用状态机实现），在<code class="language-plaintext highlighter-rouge">RequestMetaDataTypeStateMachine</code>中实现：请求数据文件的地址<code class="language-plaintext highlighter-rouge">URI</code>（返回URI，以及CRC），根据URI请求<code class="language-plaintext highlighter-rouge">META</code>数据文件内容（具有缓存功能，先比较CRC，不相等再请求远程<code class="language-plaintext highlighter-rouge">META</code>文件），即数据类型描述文件。比如下一个步骤请求飞机的参数信息，就需要将请求到的参数生成<code class="language-plaintext highlighter-rouge">Fact</code>，而<code class="language-plaintext highlighter-rouge">Fact</code>的类型信息就来自于参数的<code class="language-plaintext highlighter-rouge">META</code>数据文件。</p> <blockquote> <p>在请求<code class="language-plaintext highlighter-rouge">META</code>数据文件的过程中，定义了两个数据类：1. <code class="language-plaintext highlighter-rouge">struct CompInfo::Uris</code>：存放<code class="language-plaintext highlighter-rouge">META</code>文件的<code class="language-plaintext highlighter-rouge">URI</code>，<code class="language-plaintext highlighter-rouge">CRC</code>，以及其他一些信息（如<code class="language-plaintext highlighter-rouge">Fallback</code>请求信息）。2. <code class="language-plaintext highlighter-rouge">CompInfo</code>，以及继承自<code class="language-plaintext highlighter-rouge">CompInfo</code>的上述几种<code class="language-plaintext highlighter-rouge">META</code>文件对应的子类：<code class="language-plaintext highlighter-rouge">CompInfoGeneral</code>，<code class="language-plaintext highlighter-rouge">CompInfoParam</code>，<code class="language-plaintext highlighter-rouge">CompInfoEvents</code>，<code class="language-plaintext highlighter-rouge">CompInfoActuators</code>。其中最重要也是首先需要请求的<code class="language-plaintext highlighter-rouge">META</code>文件是<code class="language-plaintext highlighter-rouge">CompInfoGeneral</code>，因为这个文件里面包含了设备支持的<code class="language-plaintext highlighter-rouge">META</code>文件类型列表（数据成员<code class="language-plaintext highlighter-rouge">QMap&lt;COMP_METADATA_TYPE, Uris&gt; _supportedTypes;</code>）。后续几个请求，要先检查设备是否支持该类型的<code class="language-plaintext highlighter-rouge">META</code>文件。</p> </blockquote> <blockquote> <p>在<code class="language-plaintext highlighter-rouge">ComponentInformationManager</code>中，维护了一个<code class="language-plaintext highlighter-rouge">QMap&lt;uint8_t /* compId */, QMap&lt;COMP_METADATA_TYPE, CompInfo*&gt;&gt; _compInfoMap;</code>，用于存放每个组件的各类<code class="language-plaintext highlighter-rouge">META</code>文件对象。这与上面所述的逻辑连接起来。</p> </blockquote> <blockquote> <p><code class="language-plaintext highlighter-rouge">Events</code>是<code class="language-plaintext highlighter-rouge">MAVLink</code>协议中的一个系统事件和诊断机制，用于飞机端向地面站实时报告系统事件、警告和错误。相关文档：<a href="https://mavlink.io/en/services/events.html">Events Interface (WIP)</a>。比如可能有如下事件：</p> </blockquote> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>飞机端事件流：
    ├─ 电池低电量事件
    ├─ GPS 信号丢失事件
    ├─ IMU 过热警告
    ├─ 传感器校准失败
    ├─ 电机故障检测
    └─ 健康检查失败 (Health &amp; Arming Checks)
</code></pre></div></div> <h3 id="41-meta数据使用流程">4.1. META数据使用流程</h3> <p>请求到的<code class="language-plaintext highlighter-rouge">META</code>数据文件，主要用于创建<code class="language-plaintext highlighter-rouge">FactMetaData</code>对象，进而创建<code class="language-plaintext highlighter-rouge">Fact</code>对象。以请求参数的<code class="language-plaintext highlighter-rouge">META</code>数据文件为例，流程如下所示：</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌───────────────────────────────────────────────────┐
│           飞机端 (Autopilot)                       │
└───────────────────────────────────────────────────┘
                       │
                       │ MAVLink
                       │
         ┌─────────────▼──────────────┐
         │ ComponentInformation       │
         │ ┌──────────────────────┐   │
         │ │ COMP_METADATA_TYPE   │   │
         │ │ _PARAMETER           │   │
         │ │ (JSON 文件 URI)      │   │
         │ └──────────────────────┘   │
         └─────────────┬──────────────┘
                       │ 下载 JSON
                       │
         ┌─────────────▼──────────────┐
         │ CompInfoParam.setJson()    │
         │ (解析 JSON 文件)            │
         └─────────────┬──────────────┘
                       │
         ┌─────────────▼──────────────────────────────┐
         │ FactMetaData::createFromJsonObject()       │
         │ (将 JSON 转换为 FactMetaData 对象)          │
         └─────────────┬──────────────────────────────┘
                       │
         ┌─────────────▼──────────────────────────────┐
         │ ParameterManager                           │
         │ _nameToMetaDataMap[paramName]              │
         │ (存储所有参数的元数据)                       │
         └────────────────────────────────────────────┘
</code></pre></div></div> <p>代码执行流程：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1️⃣ 初始化连接时，请求参数的元数据</span>
<span class="n">_stateRequestCompInfoEvents</span><span class="p">()</span>
    <span class="err">└─►</span> <span class="n">_requestTypeStateMachine</span><span class="p">.</span><span class="n">request</span><span class="p">(</span>
            <span class="n">_compInfoMap</span><span class="p">[</span><span class="n">MAV_COMP_ID_AUTOPILOT1</span><span class="p">][</span><span class="n">COMP_METADATA_TYPE_PARAMETER</span><span class="p">]</span>
        <span class="p">);</span>

<span class="c1">// 2️⃣ 下载 JSON 文件后，调用 setJson()</span>
<span class="n">CompInfoParam</span><span class="o">::</span><span class="n">setJson</span><span class="p">(</span><span class="k">const</span> <span class="n">QString</span><span class="o">&amp;</span> <span class="n">metadataJsonFileName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 3️⃣ 解析 JSON 文件</span>
    <span class="n">QJsonDocument</span> <span class="n">jsonDoc</span> <span class="o">=</span> <span class="c1">// 从文件读取</span>
    <span class="n">QJsonArray</span> <span class="n">rgParameters</span> <span class="o">=</span> <span class="n">jsonDoc</span><span class="p">[</span><span class="s">"QGC_PARAMETERS"</span><span class="p">].</span><span class="n">toArray</span><span class="p">();</span>

    <span class="c1">// 4️⃣ 为每个参数创建 FactMetaData 对象</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">QJsonValue</span> <span class="n">parameterValue</span> <span class="o">:</span> <span class="n">rgParameters</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FactMetaData</span><span class="o">*</span> <span class="n">newMetaData</span> <span class="o">=</span>
            <span class="n">FactMetaData</span><span class="o">::</span><span class="n">createFromJsonObject</span><span class="p">(</span><span class="n">parameterValue</span><span class="p">.</span><span class="n">toObject</span><span class="p">(),</span> <span class="p">...);</span>

        <span class="c1">// 5️⃣ 存储到 map 中</span>
        <span class="n">_nameToMetaDataMap</span><span class="p">[</span><span class="n">newMetaData</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()]</span> <span class="o">=</span> <span class="n">newMetaData</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 6️⃣ 后续使用时</span>
<span class="n">FactMetaData</span><span class="o">*</span> <span class="n">meta</span> <span class="o">=</span> <span class="n">_compInfoParam</span><span class="o">-&gt;</span><span class="n">factMetaDataForName</span><span class="p">(</span><span class="s">"PARAM_NAME"</span><span class="p">);</span>
<span class="c1">// 使用 meta 来验证、转换参数值</span>
</code></pre></div></div> <h3 id="42-对应的-mavlink-服务">4.2. 对应的 MAVLink 服务</h3> <p>请求<code class="language-plaintext highlighter-rouge">META</code>数据使用微服务<a href="https://mavlink.io/en/services/component_information.html">Component Metadata Protocol (WIP)</a>，命令字：<code class="language-plaintext highlighter-rouge">MAVLINK_MSG_ID_COMPONENT_METADATA</code>。针对各个<code class="language-plaintext highlighter-rouge">META</code>数据类型，提供了枚举定义<code class="language-plaintext highlighter-rouge">COMP_METADATA_TYPE</code>。</p> <p>请求流程图如下所示：</p> <pre><code class="language-mermaid">sequenceDiagram;
    participant Client
    participant Server
    Note over Server, Client: Client: Request component information.
    Client-&gt;&gt;Server: MAV_CMD_REQUEST_MESSAGE(param1=397)
    Client--&gt;&gt;Client: Start ACK receive timeout
      Server-&gt;&gt;Client: CMD_ACK
      Server-&gt;&gt;Client: COMPONENT_METADATA( uri, file_crc)
    Note over Server, Client: Client check file at uri has changed (using CRC in file_crc).
    Note over Server, Client: Client download file at uri using MAVFTP and parse.
    Note over Server, Client: Client download other metadata types referenced in general metadata&lt;br&gt; (from device or Internet).
</code></pre> <h2 id="5-请求系统参数列表">5. 请求系统参数列表</h2> <p>这个步骤请求飞机的所有参数，使用<code class="language-plaintext highlighter-rouge">MAVLink</code>的微服务<code class="language-plaintext highlighter-rouge">Parameter Protocol</code>，在<code class="language-plaintext highlighter-rouge">QGC</code>的<code class="language-plaintext highlighter-rouge">ParameterManager</code>模块中实现，见上一篇<code class="language-plaintext highlighter-rouge">QGC代码架构解析：MAVLink参数服务及QGC参数管理模块</code>。</p> <p>请求参数，依赖于上一步骤，即请求的参数<code class="language-plaintext highlighter-rouge">META</code>数据文件，用于创建参数对应的<code class="language-plaintext highlighter-rouge">FactMetaData</code>对象。</p> <h2 id="6-请求任务列表航点列表">6. 请求任务列表（航点列表）</h2> <p>这个步骤使用<code class="language-plaintext highlighter-rouge">Mission Protocol</code>，直接调用<code class="language-plaintext highlighter-rouge">PlanManager::loadFromVehicle</code>下载飞机航点信息，进行初始化同步。具体参考下一篇<code class="language-plaintext highlighter-rouge">QGC代码架构解析：MAVLink Mission Protocol，以及 QGC 航点管理</code>。</p> <p>由于<code class="language-plaintext highlighter-rouge">MAVLink v2</code>中，<code class="language-plaintext highlighter-rouge">Mission Protocol</code>不仅仅包含航点，还包含地理围栏(<code class="language-plaintext highlighter-rouge">GeoFence</code>)、降落点(<code class="language-plaintext highlighter-rouge">Rally Points</code>)等信息。所有这些部分都实现在<code class="language-plaintext highlighter-rouge">PlanManager</code>以及其继承子类中。</p> <h2 id="7-请求地理围栏列表">7. 请求地理围栏列表</h2> <p>参考6。</p> <h2 id="8-请求降落点列表">8. 请求降落点列表</h2> <p>参考6。</p> <h2 id="9-初始化完成">9. 初始化完成</h2> <p>完成初始化，发送<code class="language-plaintext highlighter-rouge">signal</code>，通知<code class="language-plaintext highlighter-rouge">QML</code>界面。</p>]]></content><author><name></name></author><category term="QGC"/><category term="QGC"/><summary type="html"><![CDATA[在收到飞机发来的心跳包后，消息发送给MultiVehicleManager，在MultiVehicleManager中，检查组件ID是否是MAV_COMP_ID_AUTOPILOT1，以及vehicleType不是GCS等之后，会创建一个Vehicle对象，并进入初始化流程。]]></summary></entry><entry><title type="html">QGC代码架构解析：MAVLink参数服务及QGC参数管理模块</title><link href="https://hxf0223.github.io/blog/2025/qgc_parameter_module/" rel="alternate" type="text/html" title="QGC代码架构解析：MAVLink参数服务及QGC参数管理模块"/><published>2025-12-12T00:00:00+00:00</published><updated>2025-12-12T00:00:00+00:00</updated><id>https://hxf0223.github.io/blog/2025/qgc_parameter_module</id><content type="html" xml:base="https://hxf0223.github.io/blog/2025/qgc_parameter_module/"><![CDATA[<p><code class="language-plaintext highlighter-rouge">MAVLink</code>参数服务网页：<a href="https://mavlink.io/en/services/parameter.html#parameter-protocol">Parameter Protocol</a></p> <h2 id="1-微服务parameter-protocol">1. 微服务：Parameter Protocol</h2> <p>基本流程为请求-&gt;响应返回。请求/消息列表：</p> <ul> <li><code class="language-plaintext highlighter-rouge">PARAM_REQUEST_LIST</code>：请求所有参数。随后远端会周期性发送所有参数，直到发送完毕。请求数据结构： <ul> <li><code class="language-plaintext highlighter-rouge">target_system</code>（uint8_t）：System ID</li> <li><code class="language-plaintext highlighter-rouge">target_component</code>（uint8_t）：Component ID</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">PARAM_REQUEST_READ</code>：请求单个参数。请求数据结构： <ul> <li><code class="language-plaintext highlighter-rouge">target_system</code>（uint8_t）：System ID</li> <li><code class="language-plaintext highlighter-rouge">target_component</code>（uint8_t）：Component ID</li> <li><code class="language-plaintext highlighter-rouge">param_id</code>（char[16]）：参数名称，与<code class="language-plaintext highlighter-rouge">param_index</code>二选一</li> <li><code class="language-plaintext highlighter-rouge">param_index</code>（int16_t）：参数索引（-1表示忽略）</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">PARAM_SET</code>：设置单个参数。请求数据结构： <ul> <li><code class="language-plaintext highlighter-rouge">target_system</code>（uint8_t）：System ID</li> <li><code class="language-plaintext highlighter-rouge">target_component</code>（uint8_t）：Component ID</li> <li><code class="language-plaintext highlighter-rouge">param_id</code>（char[16]）：参数名称</li> <li><code class="language-plaintext highlighter-rouge">param_value</code>（float）：参数值</li> <li><code class="language-plaintext highlighter-rouge">param_type</code>（uint8_t）：参数数据类型枚举</li> </ul> </li> <li><code class="language-plaintext highlighter-rouge">PARAM_VALUE</code>：参数值响应。响应数据结构（系统ID以及组件ID在<code class="language-plaintext highlighter-rouge">mavlink_message_t</code>中）： <ul> <li><code class="language-plaintext highlighter-rouge">param_id</code>（char[16]）：参数名称</li> <li><code class="language-plaintext highlighter-rouge">param_value</code>（float）：参数值</li> <li><code class="language-plaintext highlighter-rouge">param_type</code>（uint8_t）：参数数据类型枚举</li> <li><code class="language-plaintext highlighter-rouge">param_count</code>（uint16_t）：参数总数</li> <li><code class="language-plaintext highlighter-rouge">param_index</code>（uint16_t）：当前参数索引</li> </ul> </li> </ul> <p><strong>知识点总结</strong>：</p> <ul> <li>获取/设置所有子系统的参数：<code class="language-plaintext highlighter-rouge">target_component</code>设置为<code class="language-plaintext highlighter-rouge"> MAV_COMP_ID_ALL</code>（QGC就是采取这种方式）。</li> <li>参数响应消息中，带有参数总数和当前索引，<code class="language-plaintext highlighter-rouge">QGC</code>可以判断是否接收完毕。</li> <li><code class="language-plaintext highlighter-rouge">param_value</code>有两种格式存储参数值：转换为<code class="language-plaintext highlighter-rouge">float</code>类型；或者直接按照原始数据复制到<code class="language-plaintext highlighter-rouge">param_value</code>域。<code class="language-plaintext highlighter-rouge">Ardupilot</code>直接使用<code class="language-plaintext highlighter-rouge">memcpy</code>的方式（小端）。<code class="language-plaintext highlighter-rouge">MAVLink</code>参数协议中，定义了相应的标志位，表示使用哪种方式存储。</li> <li>当<code class="language-plaintext highlighter-rouge">QGC</code>发送设置命令<code class="language-plaintext highlighter-rouge">PARAM_SET</code>之后，飞机端会返回一个<code class="language-plaintext highlighter-rouge">PARAM_VALUE</code>消息作为确认：<a href="https://mavlink.io/en/services/parameter.html#write">Parameter Protocol – Write Parameters</a>。</li> <li><code class="language-plaintext highlighter-rouge">PX4</code>固件支持缓存机制，即通过返回名称为<code class="language-plaintext highlighter-rouge">PARAM_HASH</code>，值为哈希值的<code class="language-plaintext highlighter-rouge">PARAM_VALUE</code>消息，确认参数没有变化：<a href="https://mavlink.io/en/services/parameter.html#px4">Parameter Protocol – PX4</a>。</li> <li>设置参数非法等原因导致飞机拒绝设置时，飞机端返回<code class="language-plaintext highlighter-rouge">STATUS_TEXT</code>消息。</li> </ul> <h3 id="11-参数存储代码示例">1.1. 参数存储代码示例</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义如下结构体，适用于原始字节流存储参数值（Bytewise）</span>
<span class="c1">// https://github.com/mavlink/c_library_v2/blob/master/mavlink_types.h</span>
<span class="n">MAVPACKED</span><span class="p">(</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">param_union</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">float</span> <span class="n">param_float</span><span class="p">;</span>
		<span class="kt">int32_t</span> <span class="n">param_int32</span><span class="p">;</span>
		<span class="kt">uint32_t</span> <span class="n">param_uint32</span><span class="p">;</span>
		<span class="kt">int16_t</span> <span class="n">param_int16</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">param_uint16</span><span class="p">;</span>
		<span class="kt">int8_t</span> <span class="n">param_int8</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">param_uint8</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">};</span>
	<span class="kt">uint8_t</span> <span class="n">type</span><span class="p">;</span>
<span class="p">})</span> <span class="n">mavlink_param_union_t</span><span class="p">;</span>
</code></pre></div></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mavlink_param_union_t</span> <span class="n">param</span><span class="p">;</span>
<span class="kt">int32_t</span> <span class="n">integer</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">;</span>
<span class="n">param</span><span class="p">.</span><span class="n">param_int32</span> <span class="o">=</span> <span class="n">integer</span><span class="p">;</span>
<span class="n">param</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MAV_PARAM_TYPE_INT32</span><span class="p">;</span>

<span class="c1">// Then send the param by providing the float bytes to the send function</span>
<span class="n">mavlink_msg_param_set_send</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span> <span class="n">xxx</span><span class="p">,</span> <span class="n">param</span><span class="p">.</span><span class="n">param_float</span><span class="p">,</span> <span class="n">param</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">xxx</span><span class="p">);</span>
</code></pre></div></div> <h3 id="12-协议限制及缺陷">1.2. 协议限制及缺陷</h3> <ul> <li>没有同步保证一致性机制，即发送修改命令，飞机端的参数可能已经更新了，跟<code class="language-plaintext highlighter-rouge">QGC</code>不一样了。安全的方式是：设置时，<code class="language-plaintext highlighter-rouge">QGC</code>将修改前的值带入，让飞机端进行比较。</li> <li>如果有多个关联参数需要一起设置的，没有原子操作机制。</li> </ul> <p>新增的服务<code class="language-plaintext highlighter-rouge">Extended Parameter Protocol</code>，数据类型可以支持<code class="language-plaintext highlighter-rouge">uint64_t</code>以及字节流：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MAVPACKED</span><span class="p">(</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="kt">float</span>       <span class="n">param_float</span><span class="p">;</span>
        <span class="kt">double</span>      <span class="n">param_double</span><span class="p">;</span>
        <span class="kt">int64_t</span>     <span class="n">param_int64</span><span class="p">;</span>
        <span class="kt">uint64_t</span>    <span class="n">param_uint64</span><span class="p">;</span>
        <span class="kt">int32_t</span>     <span class="n">param_int32</span><span class="p">;</span>
        <span class="kt">uint32_t</span>    <span class="n">param_uint32</span><span class="p">;</span>
        <span class="kt">int16_t</span>     <span class="n">param_int16</span><span class="p">;</span>
        <span class="kt">uint16_t</span>    <span class="n">param_uint16</span><span class="p">;</span>
        <span class="kt">int8_t</span>      <span class="n">param_int8</span><span class="p">;</span>
        <span class="kt">uint8_t</span>     <span class="n">param_uint8</span><span class="p">;</span>
        <span class="kt">uint8_t</span>     <span class="n">bytes</span><span class="p">[</span><span class="n">MAVLINK_MSG_PARAM_EXT_SET_FIELD_PARAM_VALUE_LEN</span><span class="p">];</span>
    <span class="p">};</span>
    <span class="kt">uint8_t</span> <span class="n">type</span><span class="p">;</span>
<span class="p">})</span> <span class="n">param_ext_union_t</span><span class="p">;</span>
</code></pre></div></div> <ul> <li><a href="https://mavlink.io/en/services/parameter_ext.html">Extended Parameter Protocol</a></li> <li><a href="https://github.com/mavlink/mavlink-devguide/blob/master/zh/services/parameter_ext.md">github – mavlink-devguide: Extended Parameter Protocol</a></li> </ul> <h3 id="13-资料">1.3. 资料</h3> <ul> <li><a href="https://github.com/PX4/PX4-Autopilot">github – PX4 Drone Autopilot</a></li> </ul> <h2 id="2-qgc参数管理模块">2. QGC参数管理模块</h2> <p>参数管理模块<code class="language-plaintext highlighter-rouge">ParameterManager</code>主要提供参数的请求，缓存功能，以及参数的设置功能。以及对外提供参数访问接口（参数管理模块不直接对UI层提供参数列表，由各个<code class="language-plaintext highlighter-rouge">AutoPilotPlugin</code>中各个部件模块提供比较合理），故参数模块应该作为一个公共模块，提供给<code class="language-plaintext highlighter-rouge">plugin</code>使用。另外，还提供了离线参数加载功能，离线参数文件定义在<code class="language-plaintext highlighter-rouge">FirmwarePlugin</code>中。</p> <p>下载的参数，存储在成员变量<code class="language-plaintext highlighter-rouge">_mapCompId2FactMap</code>中：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span> <span class="cm">/* comp id */</span><span class="p">,</span> <span class="n">QMap</span><span class="o">&lt;</span><span class="n">QString</span> <span class="cm">/* parameter name */</span><span class="p">,</span> <span class="n">Fact</span><span class="o">*&gt;&gt;</span> <span class="n">_mapCompId2FactMap</span><span class="p">;</span>
</code></pre></div></div> <p>缓存的文件名格式为<code class="language-plaintext highlighter-rouge">&lt;系统ID&gt;_&lt;组件ID&gt;.v2</code>，存储目录定义在<code class="language-plaintext highlighter-rouge">ParameterManager::parameterCacheDir()</code>中。参数存储格式为：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="n">QPair</span><span class="o">&lt;</span><span class="kt">int</span> <span class="cm">/* FactMetaData::ValueType_t */</span><span class="p">,</span> <span class="n">QVariant</span> <span class="cm">/* Fact::rawValue */</span><span class="o">&gt;</span> <span class="n">ParamTypeVal</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">QMap</span><span class="o">&lt;</span><span class="n">QString</span> <span class="cm">/* parameter name */</span><span class="p">,</span> <span class="n">ParamTypeVal</span><span class="o">&gt;</span> <span class="n">CacheMapName2ParamTypeVal</span><span class="p">;</span>

<span class="c1">// 展开之后为</span>
<span class="c1">// QMap&lt;QString, std::pair&lt;int, QVariant&gt;&gt;</span>
<span class="c1">// 即 QMap&lt;参数名称, &lt;参数类型枚举, 参数值&gt;&gt;</span>
</code></pre></div></div> <h3 id="21-参数请求">2.1. 参数请求</h3> <p>在<code class="language-plaintext highlighter-rouge">QGC</code>初始化时，请求所有参数：</p> <ul> <li>从网站（不是飞控）下载参数文件，仅针对<code class="language-plaintext highlighter-rouge">APM</code>固件，入口：<code class="language-plaintext highlighter-rouge">APMAirframeComponentController::loadParameters</code>；</li> <li>使用<code class="language-plaintext highlighter-rouge">FTP</code>从飞控下载参数文件，入口函数<code class="language-plaintext highlighter-rouge">refreshAllParameters</code>；</li> <li>通过参数服务请求参数，入口函数<code class="language-plaintext highlighter-rouge">refreshAllParameters</code>。</li> </ul> <p>请求完成之后，都需要调用<code class="language-plaintext highlighter-rouge">_checkInitialLoadComplete</code>。</p> <p>在<code class="language-plaintext highlighter-rouge">ParameterManager</code>中，跟请求相关的主要的数据结构定义：</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">_paramCountMap</span><span class="p">;</span>                              <span class="c1">///&lt; Key: Component id, Value: count of parameters in this component</span>
<span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">_waitingReadParamIndexMap</span><span class="p">;</span>        <span class="c1">///&lt; Key: Component id, Value: Map { Key: parameter index still waiting for, Value: retry count }</span>
<span class="n">QMap</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">QList</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">_failedReadParamIndexMap</span><span class="p">;</span>             <span class="c1">///&lt; Key: Component id, Value: failed parameter index</span>
</code></pre></div></div> <h3 id="22-参数设置">2.2. 参数设置</h3> <p>由于生成的参数列表，存在<code class="language-plaintext highlighter-rouge">_mapCompId2FactMap</code>中，及每个参数以<code class="language-plaintext highlighter-rouge">Fact</code>表示，使用<code class="language-plaintext highlighter-rouge">Fact</code>值变更的信号，设置单个参数。</p>]]></content><author><name></name></author><category term="QGC"/><category term="QGC"/><summary type="html"><![CDATA[MAVLink参数服务网页：Parameter Protocol]]></summary></entry></feed>