---
layout: post
title: CUTLASS-Cute åˆæ­¥(3.1)ï¼šTiledCopy ä»¥åŠ TiledMMA é…ç½®ç¤ºä¾‹
date: 2025-02-26 +1030
categories: [CUDA]
tags: [CUDA]

# ä»¥ä¸‹é»˜è®¤false
math: true
mermaid: true
# pin: true

toc:
  sidebar: right
---

- [cute_tiled_mma_preview.cu](https://github.com/HPC02/cuda_perf/blob/master/src/study_codes/tiled_mma_preview/cute_tiled_mma_preview.cu)

```cpp
  // Configure data type.
  using TA = cute::half_t;
  using TB = cute::half_t;
  using TC = cute::half_t;

  // Configure static "shared memory".
  // The "shared memory" is actually on host for preview purpose.
  // For tiled mma, the shared memory layout has to be static.
  constexpr int bM{128 * 2 / sizeof(TA)};
  constexpr int bN{128 * 2 / sizeof(TB)};
  constexpr int bK{32};
  auto const blk_M = cute::Int<bM>{};
  auto const blk_N = cute::Int<bN>{};
  auto const blk_K = cute::Int<bK>{};

  auto const smem_shape_A{cute::make_shape(blk_M, blk_K)};
  auto const smem_shape_B{cute::make_shape(blk_N, blk_K)};
  auto const smem_shape_C{cute::make_shape(blk_M, blk_N)};
  auto const smem_stride_A{cute::make_stride(cute::Int<1>{}, blk_M)};        // Column-major
  auto const smem_stride_B{cute::make_stride(cute::Int<1>{}, blk_N)};        // Column-major
  auto const smem_stride_C{cute::make_stride(cute::Int<1>{}, blk_M)};        // Column-major
  auto const smem_layout_A{cute::make_layout(smem_shape_A, smem_stride_A)};  // (blk_M, blk_K)
  auto const smem_layout_B{cute::make_layout(smem_shape_B, smem_stride_B)};  // (blk_N, blk_K)
  auto const smem_layout_C{cute::make_layout(smem_shape_C, smem_stride_C)};  // (blk_M, blk_N)

  auto const size_a{blk_M * blk_K};
  auto const size_b{blk_N * blk_K};
  auto const size_c{blk_M * blk_N};

  auto h_A = thrust::host_vector<TA>(size_a);
  auto h_B = thrust::host_vector<TB>(size_b);
  auto h_C = thrust::host_vector<TC>(size_c);

  // Make tensor for smem_A and smem_B.
  auto smem_tensor_A{cute::make_tensor(h_A.data(), smem_layout_A)};
  auto smem_tensor_B{cute::make_tensor(h_B.data(), smem_layout_B)};
  auto smem_tensor_C{cute::make_tensor(h_C.data(), smem_layout_C)};
```

## 1. TiledMMA é…ç½®

ä½äº SMEM ä¸­çš„ tile å¤§å°ä¸º $M \times N \times K = 128 \times 128 \times 32$ï¼Œå…¶ä¸­ï¼š

- A çŸ©é˜µä¸º $M \times K = 128 \times 32$ï¼Œrow-major layoutï¼›
- B çŸ©é˜µä¸º $K \times N = 32 \times 128$ï¼Œcolumn-major layoutï¼›
- C çŸ©é˜µä¸º $M \times N = 128 \times 128$ã€‚

### 1.1. MMA_Atom é…ç½®

MMA_Atom ä½¿ç”¨çš„é…ç½®ä¸º **cute::SM80_16x8x16_F16F16F16F16_TN**ï¼Œä½¿ç”¨ä¸€ä¸ª warpï¼Œå³ 32 ä¸ªçº¿ç¨‹å¤„ç†è¿™ä¸ª MMA Atomã€‚å¤„ç†çš„ MNK è§„æ¨¡ä¸ºï¼š$M' \times N' \times K' = 16 \times 8 \times 16$ï¼Œå…¶ä¸­ï¼š

- A sub-tile ä¸º $M' \times K' = 16 \times 16$ï¼›
- B sub-tile ä¸º $K' \times N' = 16 \times 8$ï¼›
- C sub-tile ä¸º $M' \times N' = 16 \times 8$ã€‚

```text
mma_atom
MMA_Atom
  ThrID:      _32:_1
  Shape_MNK:  (_16,_8,_16)
  LayoutA_TV: ((_4,_8),(_2,_2,_2)):((_32,_1),(_16,_8,_128))
  LayoutB_TV: ((_4,_8),(_2,_2)):((_16,_1),(_8,_64))
  LayoutC_TV: ((_4,_8),(_2,_2)):((_32,_1),(_16,_8))
```

åˆ†é…åˆ°çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•°é‡ä¸ºï¼šA çŸ©é˜µä¸º 2 x 2 x 2 = 8 ä¸ªå…ƒç´ ï¼ŒB çŸ©é˜µä¸º 2 x 2 = 4 ä¸ªå…ƒç´ ï¼Œå¾—åˆ° C çŸ©é˜µä¸­ 2 x 2 = 4 ä¸ªå…ƒç´ ã€‚

![inverse_tv_layout_SM80_16x8x16_F16F16F16F16_TN](/assets/images/cuda/20250226/tiled_mma_example/mma_atom_SM80_16x8x16_F16F16F16F16_TN.svg)

### 1.2. Tiled MMA é…ç½®

```cpp
  // Configure tiled MMA.
  using MmaTraits           = cute::MMA_Traits<cute::SM80_16x8x16_F16F16F16F16_TN>;
  using MmaAtomShape        = MmaTraits::Shape_MNK;
  auto const mma_atom       = cute::MMA_Atom<MmaTraits>{};
  auto const mma_atom_shape = MmaAtomShape{};
  // Repeating the mma atom along the M, N, and K dimensions.
  // This increases the number of threads to process the tiled MMA.
  constexpr int MMA_LAYOUT_M{2};
  constexpr int MMA_LAYOUT_N{2};
  constexpr int MMA_LAYOUT_K{1};
  auto mma_layout{cute::make_layout(
    cute::make_shape(cute::Int<MMA_LAYOUT_M>{}, cute::Int<MMA_LAYOUT_N>{}, cute::Int<MMA_LAYOUT_K>{}))};
  // Repeating the mma processing along the M, N, and K dimensions.
  // This does not increase the number of threads to process the tiled MMA.
  // But the number of registers required for processing the tiled MMA increases.
  constexpr int NUM_MMA_TILE_M{1};
  constexpr int NUM_MMA_TILE_N{2};
  constexpr int NUM_MMA_TILE_K{1};
  constexpr int MMA_TILE_M{cute::get<0>(mma_atom_shape) * MMA_LAYOUT_M * NUM_MMA_TILE_M};
  constexpr int MMA_TILE_N{cute::get<1>(mma_atom_shape) * MMA_LAYOUT_N * NUM_MMA_TILE_N};
  constexpr int MMA_TILE_K{cute::get<2>(mma_atom_shape) * MMA_LAYOUT_K * NUM_MMA_TILE_K};
  auto mma_tile{cute::make_tile(cute::Int<MMA_TILE_M>{}, cute::Int<MMA_TILE_N>{}, cute::Int<MMA_TILE_K>{})};
  auto tiled_mma{cute::make_tiled_mma(mma_atom, mma_layout, mma_tile)};
```

åœ¨ M ç»´åº¦ä¸Šï¼ŒMMA Atom é‡å¤ 2 æ¬¡ï¼Œåœ¨ N ç»´åº¦ä¸Šé‡å¤ 2 æ¬¡ï¼Œåœ¨ K ç»´åº¦ä¸Šé‡å¤ 1 æ¬¡ã€‚ä¸€å…±éœ€è¦ 2 x 2 x 1 = 4 ä¸ª MMA Atom æ¥å¤„ç†è¿™ä¸ª tiled MMAã€‚æ¯ä¸ª Atom ç”±ä¸€ä¸ª warpï¼ˆ32 ä¸ªçº¿ç¨‹ï¼‰å¤„ç†ï¼Œæ•´ä¸ª tiled MMA ç”± 4 ä¸ª warpï¼ˆ128 ä¸ªçº¿ç¨‹ï¼‰å¤„ç†ã€‚å³ **ThrLayoutVMNK = (\_32,\_2,\_2,\_1):(\_1,\_32,\_64,\_0)**ã€‚ç»è¿‡æ­¤é…ç½®åï¼Œèƒ½å¤„ç†çš„ MNK è§„æ¨¡ä¸º $(M' \times 2) \times (N' \times 2) \times (K' \times 1) = 32 \times 16 \times 16$ã€‚

å¦å¤–ï¼Œé€šè¿‡é…ç½® PermutationMNKï¼ˆå¯¹åº”ä»¥å‰ç‰ˆæœ¬çš„ ValLayoutMNKï¼‰ï¼Œä½¿å¾—ä¸€ä¸ª tiled MMA åœ¨ M/N/K æ–¹å‘ä¸Šå¤„ç†æ›´å¤šçš„å…ƒç´ ï¼ˆå³ä¸€ä¸ªçº¿ç¨‹å¤„ç†æ›´å¤šçš„å…ƒç´ ï¼‰ã€‚è¿™é‡Œé…ç½® N ç»´åº¦ä¸Šä¹˜ä»¥ 2ï¼Œå¾—åˆ°è¯¥ tiled MMA å¤„ç†çš„ MNK è§„æ¨¡ä¸º $32 \times 32 \times 16$ï¼Œå³ **PermutationMNK: (\_32,\_32,\_16)**ã€‚

```text
tiled_mma
TiledMMA
  ThrLayoutVMNK:  (_32,_2,_2,_1):(_1,_32,_64,_0)
  PermutationMNK: (_32,_32,_16)
MMA_Atom
  ThrID:      _32:_1
  Shape_MNK:  (_16,_8,_16)
  LayoutA_TV: ((_4,_8),(_2,_2,_2)):((_32,_1),(_16,_8,_128))
  LayoutB_TV: ((_4,_8),(_2,_2)):((_16,_1),(_8,_64))
  LayoutC_TV: ((_4,_8),(_2,_2)):((_32,_1),(_16,_8))
```

![tile_mma_SM80_16x8x16_F16F16F16F16_TN](/assets/images/cuda/20250226/tiled_mma_example/tiled_mma_SM80_16x8x16_F16F16F16F16_TN.svg)

### 1.3. Tiled MMA åˆ’åˆ†æ€»ç»“

ä»¥$M \times N \times K = 128 \times 128 \times 32$ï¼Œä»¥åŠ MMA Atom **SM80_16x8x16_F16F16F16F16_TN** ä¸ºä¾‹ï¼ŒMNK ä¸‰ä¸ªç»´åº¦åˆ†å—åˆ’åˆ†ï¼ˆè®¡ç®—å…¬å¼ï¼‰ï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹å‡ ç§ï¼š

- $\frac{M}{M'} \times \frac{N}{N'} \times \frac{K}{K'}$ = $\frac{128}{16} \times \frac{128}{8} \times \frac{32}{16}$ = $8 \times 16 \times 2$ = $256$ï¼Œå³ MMA Atom åœ¨ M ç»´åº¦é‡å¤ 8 æ¬¡ï¼ŒN ç»´åº¦ é‡å¤16 æ¬¡ï¼ŒK ç»´åº¦é‡å¤ 2 æ¬¡ã€‚Atom æ€»å…±éœ€è¦å¾ªç¯ **256** æ¬¡ã€‚
- $\frac{M}{M' \times MMA\_LAYOUT\_M} \times \frac{N}{N' \times MMA\_LAYOUT\_N} \times \frac{K}{K' \times MMA\_LAYOUT\_K}$ = $\frac{128}{16 \times 2} \times \frac{128}{8 \times 2} \times \frac{32}{16 \times 1}$ = $4 \times 8 \times 2$ = $64$ï¼Œå³ tiled MMA åœ¨ M ç»´åº¦é‡å¤ 2 æ¬¡ï¼ŒN ç»´åº¦é‡å¤ 2 æ¬¡ï¼ŒK ç»´åº¦é‡å¤ 1 æ¬¡ã€‚Atom æ€»å…±éœ€è¦å¾ªç¯ **64** æ¬¡ã€‚
- å…¶ä»–é…ç½®æ–¹å¼ï¼Œç±»ä¼¼ä¸Šé¢ä¸¤ç§è®¡ç®—æ–¹å¼ã€‚

ä¸€ä¸ª thread block å¦‚ä½•åˆ’åˆ†ä¸€ä¸ª tiled MMAï¼Œä»æ€§èƒ½ä¸Šéœ€è¦ç»¼åˆè€ƒè™‘ä»¥ä¸‹å‡ ä¸ªå› ç´ ï¼š

- SM ä¸Šå¯ç”¨çš„å¯„å­˜å™¨æ•°é‡ï¼Œæ¥ç¡®å®šä¸€ä¸ª thread block ä¸­å¯ä»¥æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™ä¸ª tiled MMAã€‚æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„å…ƒç´ æ•°é‡è¶Šå¤šï¼Œéœ€è¦çš„å¯„å­˜å™¨æ•°é‡å°±è¶Šå¤šã€‚
- åœ¨å¯„å­˜å™¨å¤Ÿç”¨çš„æƒ…å†µä¸‹ï¼Œå°½é‡è®©ä¸€ä¸ª thread block ä¸­çš„çº¿ç¨‹æ•°é‡èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ SM ä¸Šçš„è®¡ç®—èµ„æºï¼ˆå³ CUDA Coreã€Tensor Coreï¼‰ã€‚æ¯ä¸ª tiled MMA éœ€è¦å¤šå°‘ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œå–å†³äº MMA Atom çš„é…ç½®ä»¥åŠ tiled MMA çš„é…ç½®ã€‚

## 2. å†…å­˜åˆ†å—ä»¥åŠ TiledCopy

åœ¨å°† thread block å¯¹åº”çš„ tile å†…å­˜å†æ¬¡åˆ†è§£ä¸ºçº¿ç¨‹ sub-tile è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ CuTe åˆ†å—ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š

- ä½¿ç”¨ partition åˆ†å—ï¼Œå¾—åˆ° SMEM / GMEM sliceã€‚
- ä½¿ç”¨ partition_fragment åˆ†å—ï¼Œå¾—åˆ°å¯„å­˜å™¨ç‰‡æ®µï¼ˆregister fragmentï¼‰ã€‚
- ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“ã€‚

### 2.1. ä½¿ç”¨ partitionã€partition_fragment åˆ†å—

**partition_A/B/C**

ä½¿ç”¨ partition æ–¹æ³•ï¼Œè·å–åŸå§‹ layout çš„åˆ†å—ï¼Œå³ç”Ÿæˆä¸€ä¸ª sliceã€‚åˆ†å—ä¹‹åï¼Œæ•°æ®è¿˜æ˜¯åœ¨ SMEM / GMEM ä¸­ï¼Œä¸”ä¿ç•™äº†åŸæœ‰çš„ tile çš„ stride ä¿¡æ¯ã€‚

```cpp
  auto thread_mma{tiled_mma.get_slice(THREAD_IDX)};

  auto thread_layout_C_smem_tensor_A_no_tiled_copy{thread_mma.partition_A(smem_tensor_A)};  // (MMA, MMA_M, MMA_K)
  auto thread_layout_C_smem_tensor_B_no_tiled_copy{thread_mma.partition_B(smem_tensor_B)};  // (MMA, MMA_N, MMA_K)
  auto thread_layout_C_smem_tensor_C_no_tiled_copy{thread_mma.partition_C(smem_tensor_C)};  // (MMA, MMA_M, MMA_N)
```

æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
thread_layout_C_smem_tensor_A_no_tiled_copy
ptr[16b](0x5c6c073e78c0) o ((_2,_2,_2),_4,_2):((_128,_8,_1024),_32,_2048)
thread_layout_C_smem_tensor_B_no_tiled_copy
ptr[16b](0x5c6c073e98d0) o ((_2,_2),_8,_2):((_128,_1024),_16,_2048)
thread_layout_C_smem_tensor_C_no_tiled_copy
ptr[16b](0x5c6c073eb8e0) o ((_2,_2),_4,_8):((_128,_8),_32,_2048)
```

å…¶ä¸­ï¼Œå«ä¹‰å¦‚ä¸‹ï¼š

| ç»´åº¦          | å«ä¹‰                                  |
| ------------- | ------------------------------------- |
| MMA (ç¬¬0ç»´)   | ä¸€æ¬¡ tiled MMA è®¡ç®—ä¸­è¯¥çº¿ç¨‹è´Ÿè´£çš„å…ƒç´  |
| MMA_M (ç¬¬1ç»´) | æ²¿ M æ–¹å‘éœ€è¦å¾ªç¯çš„æ¬¡æ•°               |
| MMA_K (ç¬¬2ç»´) | æ²¿ K æ–¹å‘éœ€è¦å¾ªç¯çš„æ¬¡æ•°               |

å…·ä½“åˆ° A/B/C çŸ©é˜µä¸Šï¼Œå«ä¹‰å¦‚ä¸‹ï¼š

| çŸ©é˜µ | shape                     | è§£é‡Š                            |
| ---- | ------------------------- | ------------------------------- |
| A    | ((\_2,\_2,\_2), \_4, \_2) | MMA=8ä¸ªå…ƒç´ , Må¾ªç¯4æ¬¡, Kå¾ªç¯2æ¬¡ |
| B    | ((\_2,\_2), \_8, \_2)     | MMA=4ä¸ªå…ƒç´ , Nå¾ªç¯8æ¬¡, Kå¾ªç¯2æ¬¡ |
| C    | ((\_2,\_2), \_4, \_8)     | MMA=4ä¸ªå…ƒç´ , Må¾ªç¯4æ¬¡, Nå¾ªç¯8æ¬¡ |

æŒ‰çº¿ç¨‹åˆ‡åˆ†ä¹‹åï¼Œä¿ç•™çš„ç¬¬ä¸€ä¸ª modeï¼Œå¦å¤–ä¸¤ä¸ª mode å«ä¹‰æ˜¯ï¼ˆä»¥ A ä¸ºä¾‹ï¼‰ï¼ŒMMA Atom æŒ‰ M ç»´åº¦å¾ªç¯ 4 æ¬¡ï¼ŒK ç»´åº¦å¾ªç¯ 2 æ¬¡ã€‚å¯¹äº B/C çŸ©é˜µç±»ä¼¼ã€‚

> ğŸ“Œ å¾ªç¯æ¬¡æ•°è®¡ç®—æ–¹å¼å¦‚ä¸‹ï¼š
>
> - SMEM tileï¼šM \* N \* K = 128 \* 128 \* 32ã€‚
> - tiled_mmaï¼šM' \* N' \* K' = 32 \* 32 \* 16ã€‚
>
> å¾—åˆ°è®¡ç®—å…¬å¼ï¼š
>
> - MMA_M = 128 / 32 = 4
> - MMA_N = 128 / 32 \* 2 = 8 (ç”±äºé…ç½®äº† permutationï¼Œä½¿å¾— tiled MMA åœ¨ N ç»´åº¦ä¸Šå¤„ç†æ›´å¤šçš„å…ƒç´ ï¼Œæ‰€ä»¥å¾ªç¯æ¬¡æ•°å¢åŠ äº†)
> - MMA_K = 32 / 16 = 2
>
> ğŸ’¡ ä»æ‰“å°ä¿¡æ¯çœ‹å‡ºï¼Œä¸è®ºæ˜¯ç›´æ¥ä½¿ç”¨ **thread_layout_C_smem_tensor_A/B_no_tiled_copy**ï¼Œè¿˜æ˜¯å°†å…¶æ‹·è´åˆ°å¯„å­˜å™¨ï¼Œç”±äºä¸è¿ç»­ï¼Œå¯¼è‡´çº¿ç¨‹æ¯æ¬¡è®¿é—® 2 \* 2 \* 2 = 8 ä¸ªå…ƒç´ æ—¶ï¼Œéœ€è¦åˆ†å¼€æ‹·è´ï¼Œå³åˆ† 8 æ¬¡è®¿é—® SMEM / GMEM æ¥åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ä¸­ã€‚

**partition_fragment_A/B/C**

partition_fragment åˆ™åˆ›å»ºå¯„å­˜å™¨ç‰‡æ®µï¼ˆregister fragmentï¼‰ï¼Œä»¥å¤ç”¨å¯„å­˜å™¨æ•°æ®ã€‚åˆ†å—ä¹‹åï¼Œæ•°æ®åœ¨å¯„å­˜å™¨ä¸­ï¼Œä¸”ä¸ä¿ç•™åŸæœ‰ tile çš„ stride ä¿¡æ¯ï¼Œè€Œæ˜¯å˜ä¸ºç´§å‡‘å‹å¸ƒå±€ã€‚çº¿ç¨‹åœ¨åš gemm ä¹‹å‰ï¼Œä½¿ç”¨ copy å°†æ•°æ®ä» SMEM ä¸­åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚

```cpp
  auto thread_layout_C_register_tensor_A{thread_mma.partition_fragment_A(smem_tensor_A)};  // (MMA, MMA_M, MMA_K)
  auto thread_layout_C_register_tensor_B{thread_mma.partition_fragment_B(smem_tensor_B)};  // (MMA, MMA_N, MMA_K)
  auto thread_layout_C_register_tensor_C{thread_mma.partition_fragment_C(smem_tensor_C)};  // (MMA, MMA_M, MMA_N)
```

æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
thread_layout_C_register_tensor_A
ptr[16b](0x7ffc34e465f0) o ((_2,_2,_2),_4,_2):((_1,_2,_4),_8,_32)
thread_layout_C_register_tensor_B
ptr[16b](0x7ffc34e46670) o ((_2,_2),_8,_2):((_1,_2),_4,_32)
thread_layout_C_register_tensor_C
ptr[16b](0x7ffc34e466f0) o ((_2,_2),_4,_8):((_1,_2),_4,_16)
```

**æ€»ç»“**

ä½¿ç”¨ partition / partition_fragment åˆ†å—ï¼Œåˆ†å—æ•°æ®å¯èƒ½ä¸è¿ç»­ï¼Œå¯¼è‡´éœ€è¦å¤šæ¬¡è®¿é—® SMEM / GMEMã€‚ä½¿ç”¨åˆé€‚çš„ ldmatrix å¯ä»¥ä¸€æ¬¡å°†ä¸€æ¬¡è®¡ç®—æ‰€éœ€è¦çš„ sub-tile æ•°æ®æ‹·è´åˆ°å¯„å­˜å™¨ã€‚

### 2.2. ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“

å‰é¢ä½¿ç”¨çš„ partition / partition_fragment æ–¹å¼ï¼Œç›´æ¥ä½¿ç”¨ TiledMMA/ThrMMA åˆ†å—å¾—åˆ°çš„ã€‚ä½¿ç”¨ TiledCopy / ldmatrix è¿›è¡Œåˆ†å—ä»¥åŠä¼ è¾“ã€‚è®¾ç½® TiledCopy éœ€è¦çš„ Copy_Atomã€CopyTraitsï¼ˆlayout ä¿¡æ¯ï¼‰ï¼Œå¹¶ä½¿å…¶ä¼ è¾“çš„ sub-tile å¤§å°ä¸ tiled MMA çš„è®¡ç®—éœ€æ±‚ä¸€è‡´ã€‚

#### 2.2.1. Copy Atom é…ç½®

é’ˆå¯¹ Aã€Bï¼Œä½¿ç”¨ **cute::SM75_U16x8_LDSM_T** ç”Ÿæˆ Copy Atom æ¥å¤åˆ¶ Aã€B çš„ sub-tileï¼Œå…¶å¯¹åº”çš„ PTX ä¸ºï¼š

```cpp
ldmatrix.sync.aligned.m8n8.x4.trans.shared.b16 {r0, r1, r2, r3}, [addr];
```

å³ä½¿ç”¨ä¸€ä¸ª warpï¼ˆ32 ä¸ªçº¿ç¨‹ï¼‰åŒæ—¶åŠ è½½ä¸€ä¸ª sub-tile çš„æ•°æ®åˆ°å¯„å­˜å™¨ä¸­ã€‚

> ldmatrix åªæ”¯æŒ16ä½æ•°æ®ï¼Œä¸æ”¯æŒ32ä½æ•°æ®ï¼›å¦å¤– ldmatrix æ˜¯ PTX æŒ‡ä»¤ï¼Œå¯¹åº”åˆ° ncu ä¸­çœ‹åˆ°çš„ LDSM æŒ‡ä»¤ã€‚x1 è¡¨ç¤ºä½¿ç”¨å‰ 8 ä¸ªçº¿ç¨‹ï¼Œx2ã€x4 ä¾æ¬¡ç±»æ¨ã€‚m8n8 è¡¨ç¤º load æ“ä½œçš„å­å—å¤§å°ä¸º 8x8ï¼Œx4 åˆ™è¡¨ç¤ºåŒæ—¶åŠ è½½ 4 ä¸ªå­å—ã€‚

**cute::SM75_U16x8_LDSM_T** æ‰“å°ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
copy_atom_A
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b

copy_atom_B
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b
```

åœ¨å‰é¢ TiledMMA çš„é…ç½®ä¸­ï¼Œç»è¿‡ AtomLayout ä»¥åŠ Permutationï¼Œæœ€ç»ˆå¾—åˆ°çš„ tiled MMA å¤„ç†çš„ sub-tile å¤§å°ä¸º $M' \times N' \times K' = 32 \times 32 \times 16$ã€‚å…¶ä¸­ A çŸ©é˜µçš„ sub-tile å¤§å°ä¸º $M' \times K' = 32 \times 16$ï¼ŒB çŸ©é˜µçš„ sub-tile å¤§å°ä¸º $K' \times N' = 16 \times 32$ã€‚

ä½¿ç”¨**SM75_U16x8_LDSM_T**ï¼Œå…¶ä¸€æ¬¡æ‹·è´çš„ sub-tile å¤§å°ä¸º $32 \times 8 = 256$ï¼Œå³å¯¹åº”ä¸Šé¢æ‰“å°ä¿¡æ¯ä¸­çš„ **ValLayoutSrc: (\_32,\_8):(\_8,\_1)**ã€‚å› æ­¤ï¼ŒTiledCopy çš„ Copy Atom é…ç½®æ»¡è¶³ä¸€æ¬¡åŠ è½½ æ‰§è¡Œä¸€ä¸ª Tiled MMA æ‰€éœ€è¦çš„æ•°æ®ã€‚

å¦å¤–ï¼Œåœ¨ Tiled MMA é…ç½®ä¸­ï¼ŒB é…ç½®äº† permutationï¼Œä½¿å¾— B çŸ©é˜µçš„ sub-tile å¤§å°ä¸ A çŸ©é˜µå¤§å°ä¸€è‡´ï¼Œå¦åˆ™é’ˆå¯¹ Bï¼Œå°±éœ€è¦é€‰æ‹©å…¶ä»–çš„ Copy Atom æ¥æ»¡è¶³ tiled MMA çš„è®¡ç®—éœ€æ±‚ã€‚

#### 2.2.2. TiledCopy ä»¥åŠ ThreadCopy åˆ›å»º

åˆ›å»º TiledCopyï¼ŒCopy_Atom é…ç½®å¦‚ä¸Š**SM75_U16x8_LDSM_T**ï¼ŒTV-Layout åˆ™ç”±ä¸Šè¿°çš„ Tiled MMA ç»™å‡ºã€‚ä»£ç å¦‚ä¸‹ï¼š

```cpp
  auto copy_atom_A = cute::Copy_Atom<cute::SM75_U16x8_LDSM_T, TA>{};
  auto copy_atom_B = cute::Copy_Atom<cute::SM75_U16x8_LDSM_T, TB>{};

  auto smem_tiled_copy_A{cute::make_tiled_copy_A(copy_atom_A, tiled_mma)};
  auto smem_tiled_copy_B{cute::make_tiled_copy_B(copy_atom_B, tiled_mma)};
```

Tiled Copy ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
smem_tiled_copy_A
TiledCopy
  Tiler_MN:       (_32,_16)
  TiledLayout_TV: ((_4,_8,_2,_2),((_2,_2,_2),(_1,_1))):((_64,_1,_16,_0),((_32,_8,_256),(_0,_0)))
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b

smem_tiled_copy_B
TiledCopy
  Tiler_MN:       (_32,_16)
  TiledLayout_TV: ((_4,_8,_2,_2),((_2,_2),(_2,_1))):((_64,_1,_0,_8),((_32,_256),(_16,_0)))
Copy_Atom
  ThrID:        _32:_1
  ValLayoutSrc: (_32,_8):(_8,_1)
  ValLayoutDst: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValLayoutRef: ((_4,_8),(_1,_2,_4)):((_16,_1),(_1,_8,_64))
  ValueType:    16b
```

**ä½¿ç”¨ Thread Copy ä»¥åŠåˆ›å»ºæœ¬çº¿ç¨‹ sub-tile**

åˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆä½¿ç”¨ **ThrCopy<...>::partition_S** è·å–çº¿ç¨‹çš„ tensorï¼Œå†ä½¿ç”¨ **ThrCopy<...>::retile_D** è·å–è°ƒæ•´ shape ä¹‹åçš„ tensorã€‚ä»£ç å¦‚ä¸‹ï¼š

```cpp
  auto smem_thread_copy_A{smem_tiled_copy_A.get_slice(THREAD_IDX)};
  auto smem_thread_copy_B{smem_tiled_copy_B.get_slice(THREAD_IDX)};

  auto thread_layout_C_smem_tensor_A_tiled_copy{smem_thread_copy_A.partition_S(smem_tensor_A)};
  auto thread_layout_C_smem_tensor_B_tiled_copy{smem_thread_copy_B.partition_S(smem_tensor_B)};

  auto thread_layout_C_register_tensor_A_copy_view{smem_thread_copy_A.retile_D(thread_layout_C_register_tensor_A)};
  auto thread_layout_C_register_tensor_B_copy_view{smem_thread_copy_B.retile_D(thread_layout_C_register_tensor_B)};
```

**thread_layout_C_smem_tensor_A/B_tiled_copy** ä½œä¸ºæº tensorï¼Œä»–ä»¬çš„ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
thread_layout_C_smem_tensor_A_tiled_copy
ptr[16b](0x57b7b93248c0) o ((_8,_1),_4,_2):((_1,_0),_32,_2048)
thread_layout_C_smem_tensor_B_tiled_copy
ptr[16b](0x57b7b93268d0) o ((_8,_1),_4,_2):((_1,_0),_32,_2048)
```

ä½œä¸ºç›®çš„ tensor çš„ **thread_layout_C_register_tensor_A/B**ï¼ˆç”± **ThrMMA<...>::partition_fragment_A/B** è·å–ï¼‰ï¼Œå…¶ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
thread_layout_C_register_tensor_A
ptr[16b](0x7ffc34e465f0) o ((_2,_2,_2),_4,_2):((_1,_2,_4),_8,_32)
thread_layout_C_register_tensor_B
ptr[16b](0x7ffc34e46670) o ((_2,_2),_8,_2):((_1,_2),_4,_32)
```

æ‰€ä»¥éœ€è¦å¯¹ç›®çš„ tensor è¿›è¡Œè°ƒæ•´ï¼Œä½¿å¾—å…¶ shape ä¸æº tensor ä¸€è‡´ã€‚è°ƒæ•´ä¹‹åçš„ç›®çš„ tensor **thread_layout_C_register_tensor_A/B_copy_view** çš„ä¿¡æ¯å¦‚ä¸‹ï¼š

```text
thread_layout_C_register_tensor_A_copy_view
ptr[16b](0x7ffd7a129350) o ((_8,_1),_4,_2):((_1,_0),_8,_32)
thread_layout_C_register_tensor_B_copy_view
ptr[16b](0x7ffd7a1293d0) o ((_8,_1),_4,_2):((_1,_0),_8,_32)
```

### 2.3. æ€»ç»“

ä½¿ç”¨ partition / partition_fragment åˆ†å—ï¼Œåˆ†å—æ•°æ®å¯èƒ½ä¸è¿ç»­ï¼Œå¯¼è‡´éœ€è¦å¤šæ¬¡è®¿é—® SMEM / GMEMã€‚ä½¿ç”¨åˆé€‚çš„ ldmatrix å¯ä»¥ä¸€æ¬¡å°†ä¸€æ¬¡è®¡ç®—æ‰€éœ€è¦çš„ sub-tile æ•°æ®æ‹·è´åˆ°å¯„å­˜å™¨ã€‚

ä½¿ç”¨ TiledCopy / ldmatrix çš„æµç¨‹æ˜¯ï¼š

- é…ç½® Copy Atom / Copy Traitsï¼Œä½¿å¾—ä¸€æ¬¡ tiled copy çš„æ•°æ®é‡æ»¡è¶³ä¸€æ¬¡ tiled MMA è®¡ç®—çš„éœ€æ±‚ã€‚
- åˆ›å»º TiledCopyï¼Œå¹¶è·å–çº¿ç¨‹å¯¹åº”çš„ ThreadCopyã€‚
- ä½¿ç”¨ ThreadCopy çš„ partition_S è·å–çº¿ç¨‹çš„ tensorã€‚
- ä½¿ç”¨ ThreadCopy çš„ retile_D è·å–è°ƒæ•´ shape ä¹‹åçš„ tensorï¼Œä½¿å¾—å…¶ä¸ tiled copy çš„æº tensor shape ä¸€è‡´ã€‚
- ä½¿ç”¨ ThreadCopy æ‰§è¡Œ copy æ“ä½œï¼Œå°†æ•°æ®ä» SMEM ä¸­åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ã€‚

**TODO**ï¼šldmatrix å¯¼è‡´çš„ smem bank å†²çªï¼Œä»¥åŠå¦‚ä½•é€šè¿‡ swizzle æ¥è§„é¿ã€‚

## å‚è€ƒåŠèµ„æ–™

- [CuTe Tiled MMA](https://leimao.github.io/blog/CuTe-Tiled-MMA/)ï¼šMao Lei åšå®¢
- [CuTe General Matrix Multiplication](https://github.com/leimao/CUTLASS-Examples/tree/main/examples/cute_general_matrix_multiplication)ï¼šMao Lei GitHub GEMM ä»£ç 
- [0t_mma_atom](https://github.com/NVIDIA/cutlass/blob/main/media/docs/cpp/cute/0t_mma_atom.md)ï¼šCUTLASS-CuTe 0t_mma_atom æ–‡æ¡£ **å¾…é˜…è¯»**
- [CuTe ldmatrix](https://leimao.github.io/blog/CuTe-ldmatrix/)ï¼šMao Lei åšå®¢ ldmatrix **å¾…é˜…è¯»**
- [ldmatrixæŒ‡ä»¤ä¾‹å­å’Œå…¶å¸¦æ¥çš„smem bankå†²çª](https://zhuanlan.zhihu.com/p/697228676) **å¾…é˜…è¯»**
- [ldmatrixä¸swizzleï¼ˆç¬”è®°ï¼‰](https://zhuanlan.zhihu.com/p/696231622) **å¾…é˜…è¯»**
